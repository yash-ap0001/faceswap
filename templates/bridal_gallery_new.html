{% extends "base.html" %}

{% block style %}
<style>
    :root {
        --primary-purple: #5e35b1;
        --secondary-purple: #7e57c2;
        --dark-purple: #4527a0;
        --light-purple: #b39ddb;
        --dark-surface: #1a1a1a;
        --card-surface: #212121;
        --border-color: #333333;
        --text-primary: #f5f5f5;
        --text-secondary: #bdbdbd;
        --accent-color: var(--light-purple);
    }
    
    body {
        background-color: var(--dark-surface);
        color: var(--text-primary);
        font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
    
    .navbar {
        background-color: var(--dark-purple) !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .card {
        background-color: var(--card-surface);
        border: 1px solid var(--border-color);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .card-header {
        background-color: rgba(0,0,0,0.2);
        border-bottom: 1px solid var(--border-color);
    }
    
    .btn-primary {
        background-color: var(--primary-purple);
        border-color: var(--primary-purple);
    }
    
    .btn-primary:hover {
        background-color: var(--secondary-purple);
        border-color: var(--secondary-purple);
    }
    
    .btn-outline-primary {
        color: var(--primary-purple);
        border-color: var(--primary-purple);
    }
    
    .btn-outline-primary:hover {
        background-color: var(--primary-purple);
        color: white;
    }
    
    .ceremony-section {
        margin-bottom: 2rem;
        padding: 1rem;
        border-radius: 0.5rem;
        background-color: rgba(0,0,0,0.1);
    }
    
    .template-img {
        height: 350px;
        object-fit: cover;
        width: 100%;
        border-radius: 4px;
        transition: transform 0.3s ease-in-out;
    }
    
    .template-img:hover {
        transform: scale(1.02);
    }
    
    .template-card {
        margin-bottom: 1rem;
    }
    
    /* Hide additional rows by default */
    .expanded-row {
        display: none;
    }
    
    /* Show additional rows when expanded */
    .ceremony-section.expanded .expanded-row {
        display: flex;
    }
    
    /* Selection styles */
    .selection-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0,0,0,0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        display: none;
    }
    
    .selection-mode .selection-overlay {
        display: flex;
    }
    
    .selected-template {
        border: 3px solid var(--primary-purple);
    }
    
    /* Multi-selection interface */
    .multi-selection-interface {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: var(--card-surface);
        padding: 1rem;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        z-index: 1000;
    }
    
    .selected-preview-container {
        position: relative;
        margin-right: 10px;
        display: inline-block;
    }
    
    .selected-preview-image {
        height: 80px;
        width: 80px;
        object-fit: cover;
        border-radius: 4px;
    }
    
    .remove-selected-btn {
        position: absolute;
        top: -8px;
        right: -8px;
        padding: 0;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="mb-0">Bridal Gallery</h1>
                <div>
                    <a href="{{ url_for('bridal_swap') }}" class="btn btn-primary">
                        <i class="fas fa-exchange-alt me-2"></i> Single Face Swap
                    </a>
                    <a href="{{ url_for('bridal_multi_swap') }}" class="btn btn-info ms-2">
                        <i class="fas fa-images me-2"></i> Multi-Template Swap
                    </a>
                    <a href="{{ url_for('bulk_upload_page') }}" class="btn btn-secondary ms-2">
                        <i class="fas fa-upload me-2"></i> Upload Templates
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Model Status Card -->
    <div class="row mb-4" id="model-status-card">
        <div class="col">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <i class="fas fa-exclamation-triangle me-2"></i>Model Status
                </div>
                <div class="card-body">
                    <p class="card-text">Loading face swap models... This may take a moment.</p>
                    <a href="{{ url_for('check_models') }}" class="btn btn-sm btn-outline-warning">
                        <i class="fas fa-sync-alt me-2"></i>Check Status
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    {% for ceremony in ceremony_types %}
    <div class="ceremony-section" id="{{ ceremony }}-section">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="mb-0">
                {% if ceremony == 'haldi' %}
                <i class="fas fa-sun me-2 text-warning"></i>
                {% elif ceremony == 'mehendi' %}
                <i class="fas fa-paint-brush me-2 text-success"></i>
                {% elif ceremony == 'sangeeth' %}
                <i class="fas fa-music me-2 text-info"></i>
                {% elif ceremony == 'wedding' %}
                <i class="fas fa-heart me-2 text-danger"></i>
                {% elif ceremony == 'reception' %}
                <i class="fas fa-glass-cheers me-2 text-primary"></i>
                {% else %}
                <i class="fas fa-camera me-2"></i>
                {% endif %}
                {{ ceremony.capitalize() }} Ceremony Templates
            </h3>
            <div>
                <button class="btn btn-sm btn-outline-danger manage-btn" data-ceremony="{{ ceremony }}">
                    <i class="fas fa-cog"></i> Manage
                </button>
                <button class="btn btn-sm btn-outline-primary expand-btn" data-section="{{ ceremony }}-section">
                    <i class="fas fa-chevron-down"></i> Expand
                </button>
            </div>
        </div>
        
        {% if all_templates[ceremony]|length > 0 %}
            <!-- First row (always visible) -->
            <div class="row">
                {% for template in all_templates[ceremony][:4] %}
                <div class="col-md-3 col-sm-6 template-card" data-path="{{ template.url }}">
                    <div class="position-relative">
                        <img src="{{ url_for('uploaded_file', filename=template.url) }}" 
                            alt="{{ ceremony }} template" class="template-img">
                        
                        <!-- Selection overlay (hidden by default) -->
                        <div class="selection-overlay">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" data-path="{{ template.url }}">
                            </div>
                        </div>
                        
                        <!-- Action buttons -->
                        <div class="position-absolute bottom-0 end-0 p-2">
                            <button class="btn btn-sm btn-primary preview-btn" data-path="{{ template.url }}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-btn" data-path="{{ template.url }}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            {% if all_templates[ceremony]|length > 4 %}
            <!-- Additional rows (hidden by default) -->
            <div class="expanded-row">
                <div class="row">
                    {% for template in all_templates[ceremony][4:] %}
                    <div class="col-md-3 col-sm-6 template-card" data-path="{{ template.url }}">
                        <div class="position-relative">
                            <img src="{{ url_for('uploaded_file', filename=template.url) }}" 
                                alt="{{ ceremony }} template" class="template-img">
                            
                            <!-- Selection overlay (hidden by default) -->
                            <div class="selection-overlay">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" data-path="{{ template.url }}">
                                </div>
                            </div>
                            
                            <!-- Action buttons -->
                            <div class="position-absolute bottom-0 end-0 p-2">
                                <button class="btn btn-sm btn-primary preview-btn" data-path="{{ template.url }}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-danger delete-btn" data-path="{{ template.url }}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        {% else %}
            <div class="alert alert-info">
                No templates available for {{ ceremony }} ceremony.
                <a href="{{ url_for('bulk_upload_page') }}" class="alert-link">Upload some templates</a>
            </div>
        {% endif %}
        
        <!-- Management tools (hidden by default) -->
        <div class="management-tools mt-3 d-none">
            <button class="btn btn-danger delete-selected-btn" data-ceremony="{{ ceremony }}">
                <i class="fas fa-trash me-2"></i>Delete Selected
            </button>
            <button class="btn btn-warning clear-all-btn" data-ceremony="{{ ceremony }}">
                <i class="fas fa-times-circle me-2"></i>Clear All Templates
            </button>
            <button class="btn btn-secondary cancel-btn" data-ceremony="{{ ceremony }}">
                <i class="fas fa-times me-2"></i>Cancel
            </button>
        </div>
    </div>
    {% endfor %}
    
    <!-- Multi-selection interface (hidden by default) -->
    <div class="multi-selection-interface d-none">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-2">
                    <h5 class="mb-0">Selected: <span id="selectedCount">0/5</span></h5>
                </div>
                <div class="col-md-5">
                    <div id="selectedTemplatesPreview" class="d-flex overflow-auto py-2"></div>
                </div>
                <div class="col-md-3">
                    <div class="position-relative">
                        <input type="file" id="multiSourceInput" accept="image/*" class="form-control">
                        <div class="position-relative mt-2">
                            <img id="multiSourcePreview" class="img-fluid d-none" style="max-height: 100px;">
                            <div id="multiSourcePlaceholder" class="text-center p-3 border rounded">
                                <i class="fas fa-user-circle fa-2x mb-2"></i>
                                <p class="mb-0">Upload your face</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <button id="processMultipleBtn" class="btn btn-success">
                        <i class="fas fa-magic me-2"></i>Process Templates
                    </button>
                </div>
                <div class="col-md-1 text-end">
                    <button id="clearSelectionBtn" class="btn btn-outline-secondary">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading overlay -->
    <div id="loading-overlay" class="position-fixed top-0 start-0 w-100 h-100 bg-dark d-flex align-items-center justify-content-center d-none" style="opacity: 0.8; z-index: 9999;">
        <div class="text-center text-white">
            <div class="spinner-border mb-3" role="status"></div>
            <h4 id="loading-message">Processing...</h4>
        </div>
    </div>
    
    <!-- Preview Modal -->
    <div class="modal fade" id="previewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Template Preview</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="previewImage" src="" alt="Template Preview" class="img-fluid">
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-primary" id="selectTemplateBtn">
                        <i class="fas fa-check me-2"></i>Select for Face Swap
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle text-warning me-2"></i>Confirm Delete</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="deleteConfirmText">Are you sure you want to delete this template? This action cannot be undone.</p>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                        <i class="fas fa-trash me-2"></i>Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Error Modal -->
    <div class="modal fade" id="errorModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title"><i class="fas fa-exclamation-circle text-danger me-2"></i>Error</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="error-message"></p>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Function to check model status
    function checkModels() {
        fetch('/check-models')
            .then(response => response.json())
            .then(data => {
                if (data.face_detection && data.face_swap) {
                    document.getElementById('model-status-card').classList.add('d-none');
                }
            });
    }
    
    // Initialize variables
    let selectedTemplatePaths = [];
    let currentPreviewTemplate = null;
    let currentDeletePath = null;
    let currentDeleteCeremony = null;
    let currentBulkDeletePaths = [];
    let multiSourceFile = null;
    const MAX_SELECTED_TEMPLATES = 5;
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Check model status
        checkModels();
        
        // Initialize event listeners
        initExpanders();
        initManageButtons();
        initTemplateActions();
        initMultiSelectionInterface();
    });
    
    // Initialize expand/collapse functionality
    function initExpanders() {
        document.querySelectorAll('.expand-btn').forEach(button => {
            button.addEventListener('click', function() {
                const sectionId = this.getAttribute('data-section');
                const section = document.getElementById(sectionId);
                const icon = this.querySelector('i');
                
                // Toggle expanded class
                if (section.classList.contains('expanded')) {
                    section.classList.remove('expanded');
                    this.classList.remove('btn-primary');
                    this.classList.add('btn-outline-primary');
                    icon.classList.remove('fa-chevron-up');
                    icon.classList.add('fa-chevron-down');
                    this.innerHTML = '<i class="fas fa-chevron-down"></i> Expand';
                } else {
                    section.classList.add('expanded');
                    this.classList.remove('btn-outline-primary');
                    this.classList.add('btn-primary');
                    icon.classList.remove('fa-chevron-down');
                    icon.classList.add('fa-chevron-up');
                    this.innerHTML = '<i class="fas fa-chevron-up"></i> Collapse';
                }
            });
        });
    }
    
    // Initialize template management
    function initManageButtons() {
        // Manage buttons
        document.querySelectorAll('.manage-btn').forEach(button => {
            button.addEventListener('click', function() {
                const ceremony = this.getAttribute('data-ceremony');
                const section = document.getElementById(`${ceremony}-section`);
                
                if (section.classList.contains('selection-mode')) {
                    // Exit selection mode
                    section.classList.remove('selection-mode');
                    this.innerHTML = '<i class="fas fa-cog"></i> Manage';
                    this.classList.remove('btn-danger');
                    this.classList.add('btn-outline-danger');
                    
                    // Hide management tools
                    section.querySelector('.management-tools').classList.add('d-none');
                } else {
                    // Enter selection mode
                    section.classList.add('selection-mode');
                    this.innerHTML = '<i class="fas fa-times"></i> Exit';
                    this.classList.remove('btn-outline-danger');
                    this.classList.add('btn-danger');
                    
                    // Show management tools
                    section.querySelector('.management-tools').classList.remove('d-none');
                }
            });
        });
        
        // Cancel selection buttons
        document.querySelectorAll('.cancel-btn').forEach(button => {
            button.addEventListener('click', function() {
                const ceremony = this.getAttribute('data-ceremony');
                const section = document.getElementById(`${ceremony}-section`);
                const manageBtn = section.querySelector('.manage-btn');
                
                // Exit selection mode
                section.classList.remove('selection-mode');
                manageBtn.innerHTML = '<i class="fas fa-cog"></i> Manage';
                manageBtn.classList.remove('btn-danger');
                manageBtn.classList.add('btn-outline-danger');
                
                // Hide management tools
                section.querySelector('.management-tools').classList.add('d-none');
                
                // Uncheck all checkboxes
                section.querySelectorAll('.form-check-input').forEach(checkbox => {
                    checkbox.checked = false;
                });
            });
        });
        
        // Delete selected button
        document.querySelectorAll('.delete-selected-btn').forEach(button => {
            button.addEventListener('click', function() {
                const ceremony = this.getAttribute('data-ceremony');
                const section = document.getElementById(`${ceremony}-section`);
                const selectedCheckboxes = section.querySelectorAll('.form-check-input:checked');
                
                if (selectedCheckboxes.length === 0) {
                    document.getElementById('error-message').textContent = 'No templates selected for deletion';
                    new bootstrap.Modal(document.getElementById('errorModal')).show();
                    return;
                }
                
                // Get paths of selected templates
                currentBulkDeletePaths = Array.from(selectedCheckboxes).map(checkbox => 
                    checkbox.getAttribute('data-path'));
                currentDeleteCeremony = ceremony;
                
                // Update confirmation text
                document.getElementById('deleteConfirmText').textContent = 
                    `Are you sure you want to delete ${currentBulkDeletePaths.length} selected templates? This action cannot be undone.`;
                
                // Show confirmation modal
                new bootstrap.Modal(document.getElementById('deleteModal')).show();
            });
        });
        
        // Clear all templates button
        document.querySelectorAll('.clear-all-btn').forEach(button => {
            button.addEventListener('click', function() {
                const ceremony = this.getAttribute('data-ceremony');
                
                // Update confirmation text
                document.getElementById('deleteConfirmText').textContent = 
                    `Are you sure you want to delete ALL templates for the ${ceremony} ceremony? This action cannot be undone.`;
                
                // Set up for delete all operation
                currentDeleteCeremony = ceremony;
                currentBulkDeletePaths = [];
                
                // Show confirmation modal
                new bootstrap.Modal(document.getElementById('deleteModal')).show();
            });
        });
    }
    
    // Initialize template card actions
    function initTemplateActions() {
        // Preview buttons
        document.querySelectorAll('.preview-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.stopPropagation();
                const templatePath = this.getAttribute('data-path');
                const previewImage = document.getElementById('previewImage');
                previewImage.src = `/uploads/${templatePath}`;
                currentPreviewTemplate = templatePath;
                new bootstrap.Modal(document.getElementById('previewModal')).show();
            });
        });
        
        // Delete buttons
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.stopPropagation();
                currentDeletePath = this.getAttribute('data-path');
                document.getElementById('deleteConfirmText').textContent = 
                    'Are you sure you want to delete this template? This action cannot be undone.';
                new bootstrap.Modal(document.getElementById('deleteModal')).show();
            });
        });
        
        // Template card click (for preview)
        document.querySelectorAll('.template-card').forEach(card => {
            card.addEventListener('click', function() {
                // Skip if in selection mode
                const section = this.closest('.ceremony-section');
                if (section.classList.contains('selection-mode')) {
                    const checkbox = this.querySelector('.form-check-input');
                    checkbox.checked = !checkbox.checked;
                    return;
                }
                
                // Otherwise show preview
                const templatePath = this.getAttribute('data-path');
                const previewImage = document.getElementById('previewImage');
                previewImage.src = `/uploads/${templatePath}`;
                currentPreviewTemplate = templatePath;
                new bootstrap.Modal(document.getElementById('previewModal')).show();
            });
        });
        
        // Selection checkboxes
        document.querySelectorAll('.form-check-input').forEach(checkbox => {
            checkbox.addEventListener('click', function(e) {
                e.stopPropagation();
                // Handled by the cards themselves
            });
        });
        
        // Confirm delete button
        document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
            const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
            
            if (currentDeletePath) {
                // Individual template deletion
                deleteTemplate([currentDeletePath]);
                currentDeletePath = null;
            } else if (currentDeleteCeremony) {
                if (currentBulkDeletePaths.length > 0) {
                    // Bulk template deletion
                    deleteTemplate(currentBulkDeletePaths);
                } else {
                    // Clear all templates for ceremony
                    clearAllTemplates(currentDeleteCeremony);
                }
                currentDeleteCeremony = null;
                currentBulkDeletePaths = [];
            }
            
            deleteModal.hide();
        });
        
        // Select template from preview
        document.getElementById('selectTemplateBtn').addEventListener('click', function() {
            if (currentPreviewTemplate) {
                toggleTemplateSelection(currentPreviewTemplate);
                bootstrap.Modal.getInstance(document.getElementById('previewModal')).hide();
            }
        });
    }
    
    // Initialize multi-selection interface
    function initMultiSelectionInterface() {
        const multiSelectionInterface = document.querySelector('.multi-selection-interface');
        const selectedCount = document.getElementById('selectedCount');
        const selectedTemplatesPreview = document.getElementById('selectedTemplatesPreview');
        const clearSelectionBtn = document.getElementById('clearSelectionBtn');
        const processMultipleBtn = document.getElementById('processMultipleBtn');
        const multiSourceInput = document.getElementById('multiSourceInput');
        const multiSourcePreview = document.getElementById('multiSourcePreview');
        const multiSourcePlaceholder = document.getElementById('multiSourcePlaceholder');
        
        // Source image input change
        if (multiSourceInput) {
            multiSourceInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    multiSourceFile = this.files[0];
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        multiSourcePreview.src = e.target.result;
                        multiSourcePreview.classList.remove('d-none');
                        multiSourcePlaceholder.classList.add('d-none');
                    };
                    
                    reader.readAsDataURL(this.files[0]);
                }
            });
        }
        
        // Clear selection button
        if (clearSelectionBtn) {
            clearSelectionBtn.addEventListener('click', function() {
                // Clear selected templates
                document.querySelectorAll('.template-card.selected').forEach(card => {
                    card.classList.remove('selected');
                });
                
                selectedTemplatePaths = [];
                updateMultiSelectionInterface();
            });
        }
        
        // Process multiple button
        if (processMultipleBtn) {
            processMultipleBtn.addEventListener('click', function() {
                if (!multiSourceFile) {
                    document.getElementById('error-message').textContent = 'Please upload a source image first';
                    new bootstrap.Modal(document.getElementById('errorModal')).show();
                    return;
                }
                
                if (selectedTemplatePaths.length === 0) {
                    document.getElementById('error-message').textContent = 'Please select at least one template';
                    new bootstrap.Modal(document.getElementById('errorModal')).show();
                    return;
                }
                
                // Show loading overlay
                document.getElementById('loading-overlay').classList.remove('d-none');
                document.getElementById('loading-message').textContent = 'Processing templates... This may take a minute.';
                
                // Create form data for submission
                const formData = new FormData();
                formData.append('source', multiSourceFile);
                selectedTemplatePaths.forEach(path => {
                    formData.append('templates[]', path);
                });
                
                // Send request to process templates
                fetch('/multi-face-swap', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('loading-overlay').classList.add('d-none');
                    
                    if (data.success) {
                        // Redirect to results page
                        window.location.href = '/bridal-results';
                    } else {
                        document.getElementById('error-message').textContent = data.error || 'Failed to process templates';
                        new bootstrap.Modal(document.getElementById('errorModal')).show();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('loading-overlay').classList.add('d-none');
                    document.getElementById('error-message').textContent = 'Network error occurred during processing';
                    new bootstrap.Modal(document.getElementById('errorModal')).show();
                });
            });
        }
    }
    
    // Toggle template selection for multi-template processing
    function toggleTemplateSelection(templatePath) {
        const index = selectedTemplatePaths.indexOf(templatePath);
        const card = document.querySelector(`.template-card[data-path="${templatePath}"]`);
        
        if (index === -1) {
            // Template not selected, add it if under the limit
            if (selectedTemplatePaths.length < MAX_SELECTED_TEMPLATES) {
                selectedTemplatePaths.push(templatePath);
                if (card) card.classList.add('selected');
            } else {
                // Show error for maximum templates
                document.getElementById('error-message').textContent = 
                    `You can only select up to ${MAX_SELECTED_TEMPLATES} templates`;
                new bootstrap.Modal(document.getElementById('errorModal')).show();
                return;
            }
        } else {
            // Template already selected, remove it
            selectedTemplatePaths.splice(index, 1);
            if (card) card.classList.remove('selected');
        }
        
        updateMultiSelectionInterface();
    }
    
    // Update multi-selection interface
    function updateMultiSelectionInterface() {
        const multiSelectionInterface = document.querySelector('.multi-selection-interface');
        const selectedCount = document.getElementById('selectedCount');
        const selectedTemplatesPreview = document.getElementById('selectedTemplatesPreview');
        
        // Update selected count
        if (selectedCount) {
            selectedCount.textContent = `${selectedTemplatePaths.length}/${MAX_SELECTED_TEMPLATES}`;
        }
        
        // Update preview
        if (selectedTemplatesPreview) {
            // Clear previous previews
            selectedTemplatesPreview.innerHTML = '';
            
            // Add preview for each selected template
            selectedTemplatePaths.forEach(path => {
                const previewContainer = document.createElement('div');
                previewContainer.className = 'selected-preview-container';
                
                const img = document.createElement('img');
                img.src = `/uploads/${path}`;
                img.alt = 'Selected Template';
                img.className = 'selected-preview-image';
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn btn-sm btn-danger remove-selected-btn';
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.setAttribute('data-path', path);
                removeBtn.addEventListener('click', function() {
                    toggleTemplateSelection(path);
                });
                
                previewContainer.appendChild(img);
                previewContainer.appendChild(removeBtn);
                selectedTemplatesPreview.appendChild(previewContainer);
            });
        }
        
        // Show/hide the interface
        if (multiSelectionInterface) {
            if (selectedTemplatePaths.length > 0) {
                multiSelectionInterface.classList.remove('d-none');
            } else {
                multiSelectionInterface.classList.add('d-none');
            }
        }
    }
    
    // Delete template(s)
    function deleteTemplate(templatePaths) {
        fetch('/delete-templates', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ template_paths: templatePaths }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove templates from UI
                templatePaths.forEach(path => {
                    const card = document.querySelector(`.template-card[data-path="${path}"]`);
                    if (card) card.remove();
                    
                    // Remove from selected templates if needed
                    const index = selectedTemplatePaths.indexOf(path);
                    if (index > -1) {
                        selectedTemplatePaths.splice(index, 1);
                    }
                });
                
                updateMultiSelectionInterface();
            } else {
                document.getElementById('error-message').textContent = data.error || 'Failed to delete template(s)';
                new bootstrap.Modal(document.getElementById('errorModal')).show();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('error-message').textContent = 'Network error occurred during deletion';
            new bootstrap.Modal(document.getElementById('errorModal')).show();
        });
    }
    
    // Clear all templates for a ceremony
    function clearAllTemplates(ceremony) {
        fetch('/delete-templates', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                ceremony_type: ceremony,
                clear_all: true
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Get all templates for this ceremony
                const section = document.getElementById(`${ceremony}-section`);
                const cards = section.querySelectorAll('.template-card');
                
                // Remove them from UI
                cards.forEach(card => {
                    const path = card.getAttribute('data-path');
                    card.remove();
                    
                    // Remove from selected templates if needed
                    const index = selectedTemplatePaths.indexOf(path);
                    if (index > -1) {
                        selectedTemplatePaths.splice(index, 1);
                    }
                });
                
                // Add "no templates" message if not already present
                if (!section.querySelector('.alert-info')) {
                    const row = document.createElement('div');
                    row.className = 'alert alert-info';
                    row.innerHTML = `No templates available for ${ceremony} ceremony. <a href="/bulk-upload" class="alert-link">Upload some templates</a>`;
                    section.appendChild(row);
                }
                
                updateMultiSelectionInterface();
                
                // Exit selection mode
                section.classList.remove('selection-mode');
                const manageBtn = section.querySelector('.manage-btn');
                manageBtn.innerHTML = '<i class="fas fa-cog"></i> Manage';
                manageBtn.classList.remove('btn-danger');
                manageBtn.classList.add('btn-outline-danger');
                section.querySelector('.management-tools').classList.add('d-none');
            } else {
                document.getElementById('error-message').textContent = data.error || 'Failed to clear templates';
                new bootstrap.Modal(document.getElementById('errorModal')).show();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('error-message').textContent = 'Network error occurred during deletion';
            new bootstrap.Modal(document.getElementById('errorModal')).show();
        });
    }
</script>
{% endblock %}