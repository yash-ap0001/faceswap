{% extends "base.html" %}

{% block style %}
<style>
    :root {
        --primary-purple: #5e35b1;
        --secondary-purple: #7e57c2;
        --dark-purple: #4527a0;
        --light-purple: #b39ddb;
        --dark-surface: #1a1a1a;
        --card-surface: #212121;
        --border-color: #333333;
        --text-primary: #f5f5f5;
        --text-secondary: #bdbdbd;
        --accent-color: var(--light-purple);
    }
    
    body {
        background-color: var(--dark-surface);
        color: var(--text-primary);
        font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
    
    .navbar {
        background-color: var(--dark-purple) !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .card {
        background-color: var(--card-surface);
        border: 1px solid var(--border-color);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .card-header {
        background-color: rgba(0,0,0,0.2);
        border-bottom: 1px solid var(--border-color);
    }
    
    .btn-primary {
        background-color: var(--primary-purple);
        border-color: var(--primary-purple);
    }
    
    .btn-primary:hover {
        background-color: var(--secondary-purple);
        border-color: var(--secondary-purple);
    }
    
    .btn-outline-primary {
        color: var(--accent-color);
        border-color: var(--accent-color);
    }
    
    .btn-outline-primary:hover {
        background-color: var(--primary-purple);
        border-color: var(--primary-purple);
        color: white;
    }
    
    .bridal-card {
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        padding: 0;
        margin-bottom: 1rem;
    }
    
    .card-img-top {
        width: 100%;
        height: 350px;
        object-fit: cover;
        object-position: top;
        cursor: pointer;
    }
    
    .bridal-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
    
    .bridal-card.selected {
        border: 3px solid var(--bs-primary);
    }
    
    .select-badge {
        z-index: 10;
    }
    
    .image-preview-container {
        min-height: 300px;
        border: 2px dashed var(--light-purple);
        border-radius: 5px;
    }
    
    .result-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 30px;
    }
    
    .result-card {
        position: relative;
        overflow: hidden;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
    }
    
    .result-card:hover {
        transform: scale(1.03);
        box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }
    
    .result-image {
        width: 100%;
        height: 350px;
        object-fit: cover;
        object-position: top;
    }
    
    /* Result overlay removed */
    
    .pulse-animation {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(206, 147, 216, 0.7);
        }
        70% {
            box-shadow: 0 0 0 15px rgba(206, 147, 216, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(206, 147, 216, 0);
        }
    }
    
    .placeholder-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #757575;
    }
    
    /* Badge styles removed */
    
    .btn-floating {
        position: absolute;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        z-index: 10;
    }
    
    .btn-download {
        bottom: 60px;
        right: 10px;
        background-color: var(--secondary-purple);
        color: white;
    }
    
    .btn-remove {
        top: 10px;
        left: 10px;
        background-color: #f44336;
        color: white;
    }
    
    .feature-icon {
        font-size: 2rem;
        color: var(--accent-color);
        margin-bottom: 15px;
        opacity: 0.8;
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        flex-direction: column;
    }
    
    .spinner {
        width: 70px;
        height: 70px;
        border: 8px solid rgba(179, 157, 219, 0.3);
        border-top: 8px solid var(--primary-purple);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Carousel and navigation styles */
    .template-carousel {
        position: relative;
        margin-bottom: 40px;
    }
    
    .carousel-nav-buttons {
        position: absolute;
        top: 50%;
        width: 100%;
        transform: translateY(-50%);
        z-index: 10;
        display: flex;
        justify-content: space-between;
        pointer-events: none;
    }
    
    .carousel-nav-btn {
        height: 40px;
        width: 40px;
        border-radius: 50%;
        background-color: rgba(126, 87, 194, 0.8);  /* Purple color */
        border: none;
        box-shadow: 0 0 10px rgba(0,0,0,0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0.8;
        transition: all 0.3s ease;
        pointer-events: auto;
        color: white;
    }
    
    .carousel-nav-btn:hover {
        opacity: 1;
        background-color: rgba(126, 87, 194, 1);
        transform: scale(1.1);
    }
    
    .template-card {
        transition: transform 0.3s ease, opacity 0.2s ease;
    }
    
    .template-card:hover {
        transform: translateY(-5px);
    }
    
    .template-card img {
        height: 350px;
        object-fit: cover;
        width: 100%;
    }
    
    .template-actions {
        opacity: 0;
        transition: all 0.3s ease;
        z-index: 20;
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0,0,0,0.7);
        padding: 10px;
    }
    
    .template-card:hover .template-actions {
        opacity: 1;
    }
    
    .single-swap-btn, .template-select-btn {
        padding: 8px 15px;
        display: inline-block;
        transition: all 0.2s ease;
        border-radius: 5px;
        font-size: 0.9rem;
        font-weight: 500;
    }
    
    .single-swap-btn:hover, .template-select-btn:hover {
        transform: scale(1.1);
    }
    
    /* Icon buttons */
    .btn-icon {
        width: 36px;
        height: 36px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s ease;
    }
    
    .btn-icon:hover {
        transform: scale(1.1);
    }
    
    /* Template rows after the first one */
    .template-card.extra-card {
        display: none;
    }
    
    /* Template management styles */
    .template-management-tools {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 0;
    }
    
    .bulk-actions {
        display: flex;
        gap: 8px;
    }
    
    .template-select-overlay {
        position: absolute;
        top: 0;
        right: 0;
        width: auto;
        height: auto;
        z-index: 10;
        display: flex;
        align-items: flex-start;
        justify-content: flex-end;
        padding: 15px;
    }
    
    .template-select-overlay .form-check {
        background-color: white;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    
    .form-check-input:checked {
        background-color: var(--primary-purple);
        border-color: var(--primary-purple);
    }
    
    .template-checkbox {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }
    
    .delete-template-btn {
        visibility: hidden;
        opacity: 0;
        transition: visibility 0s, opacity 0.3s;
    }
    
    .bridal-card:hover .delete-template-btn {
        visibility: visible;
        opacity: 1;
    }
    
    /* View more button styles */
    /* Removed view-more button styles */
    
    /* Removed fullscreen gallery styles */
</style>
{% endblock %}

{% block content %}
<!-- Upload Photo Button (top-right) -->
<div class="position-fixed top-0 end-0 p-4" style="z-index: 1050; margin-top: 60px; margin-right: 20px;">
    <button type="button" class="btn btn-primary rounded-circle shadow-lg" data-bs-toggle="modal" data-bs-target="#uploadPhotoModal" style="width: 60px; height: 60px;">
        <i class="fas fa-upload"></i>
    </button>
</div>

<!-- Upload Photo Modal Dialog -->
<div class="modal fade" id="uploadPhotoModal" tabindex="-1" aria-labelledby="uploadPhotoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white border-0">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title" id="uploadPhotoModalLabel">Upload Your Photo</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="image-preview-container mb-4 d-flex align-items-center justify-content-center mx-auto" style="width: 200px; height: 200px;">
                    <img id="source-preview" class="img-fluid d-none rounded-circle shadow" style="width: 180px; height: 180px; object-fit: cover;" alt="Your photo preview">
                    <div id="source-placeholder" class="placeholder-container">
                        <svg width="120" height="120" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mb-3">
                            <path opacity="0.4" d="M12 22.01C17.5228 22.01 22 17.5329 22 12.01C22 6.48716 17.5228 2.01001 12 2.01001C6.47715 2.01001 2 6.48716 2 12.01C2 17.5329 6.47715 22.01 12 22.01Z" fill="rgba(126, 87, 194, 0.3)"/>
                            <path d="M12 6.94001C9.93 6.94001 8.25 8.62001 8.25 10.69C8.25 12.72 9.84 14.37 11.95 14.43C11.98 14.43 12.02 14.43 12.04 14.43C12.06 14.43 12.09 14.43 12.11 14.43C12.12 14.43 12.13 14.43 12.13 14.43C14.15 14.36 15.74 12.72 15.75 10.69C15.75 8.62001 14.07 6.94001 12 6.94001Z" fill="rgba(126, 87, 194, 0.7)"/>
                            <path d="M18.7802 19.36C17.0002 21 14.6202 22.01 12.0002 22.01C9.38022 22.01 7.00021 21 5.22021 19.36C5.46021 18.45 6.11022 17.62 7.06021 16.98C9.79022 15.16 14.2302 15.16 16.9402 16.98C17.9002 17.62 18.5402 18.45 18.7802 19.36Z" fill="rgba(126, 87, 194, 0.7)"/>
                        </svg>
                        <p class="text-center text-secondary">No photo selected yet</p>
                    </div>
                </div>
                
                <form id="upload-form" enctype="multipart/form-data">
                    <div class="upload-input">
                        <input type="file" id="source-input" name="source" accept=".jpg,.jpeg,.png" required>
                        <div class="upload-btn btn btn-outline-light w-100">
                            <i class="fas fa-cloud-upload-alt me-2"></i> Choose Photo
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-secondary mt-3 d-none" type="button" id="source-clear-btn">
                        <i class="fas fa-times me-1"></i> Remove Photo
                    </button>
                </form>
                
                <div class="alert alert-info mt-3">
                    <small><i class="fas fa-info-circle me-1"></i> Select a clear frontal photo of your face for best results</small>
                </div>
            </div>
            <div class="modal-footer border-top border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="confirmUpload">
                    <i class="fas fa-check me-1"></i> Confirm Photo
                </button>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid py-4">
    <!-- Multi-Selection Interface -->
    <div class="card mb-4 shadow d-none" id="multiSelectionInterface">
        <div class="card-header bg-dark d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-images me-2"></i> Selected Templates (<span id="selectedCount">0</span>/5)
            </h5>
            <button class="btn btn-sm btn-outline-danger" id="clearSelectionBtn">
                <i class="fas fa-times me-1"></i> Clear Selection
            </button>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-5">
                    <div class="mb-3">
                        <label for="multiSourceInput" class="form-label">Upload Your Photo</label>
                        <input type="file" class="form-control" id="multiSourceInput" accept=".jpg,.jpeg,.png">
                    </div>
                    <div class="image-preview-container mb-3" style="height: 200px; overflow: hidden;">
                        <img id="multiSourcePreview" class="img-fluid d-none" alt="Your photo preview" style="max-height: 200px;">
                        <div id="multiSourcePlaceholder" class="text-center">
                            <i class="fas fa-user-circle mb-2" style="font-size: 4rem; opacity: 0.5;"></i>
                            <p class="text-muted">No photo selected yet<br>Please upload a clear frontal photo</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-7">
                    <div class="selected-templates" id="selectedTemplatesContainer">
                        <div class="row row-cols-2 row-cols-lg-5 g-2" id="selectedTemplatesPreview">
                            <!-- Selected templates will appear here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="text-center mt-3">
                <button class="btn btn-primary btn-lg" id="processMultipleBtn" disabled>
                    <i class="fas fa-magic me-2"></i> Create Face Swaps for Selected Templates
                </button>
            </div>
        </div>
    </div>

    <!-- Selection Mode Card -->
    <div class="card mb-4 shadow">
        <div class="card-header bg-dark">
            <h5 class="mb-0">Selection Mode</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <!-- Mode Selection -->
                    <div class="btn-group w-100 mb-3" role="group" aria-label="Selection mode">
                        <input type="radio" class="btn-check" name="selection-mode" id="single-mode" autocomplete="off" checked>
                        <label class="btn btn-outline-primary" for="single-mode">
                            <i class="fas fa-user me-2"></i>Single Template Mode
                        </label>
                        
                        <input type="radio" class="btn-check" name="selection-mode" id="multi-mode" autocomplete="off">
                        <label class="btn btn-outline-primary" for="multi-mode">
                            <i class="fas fa-users me-2"></i>Multi-Template Mode
                        </label>
                    </div>
                    
                    <!-- Mode description -->
                    <div id="mode-description" class="alert alert-info">
                        <div id="single-mode-desc">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Single Template Mode:</strong> Click on any template to create a face swap with just that one image.
                        </div>
                        <div id="multi-mode-desc" class="d-none">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Multi-Template Mode:</strong> Click to select up to 5 templates across different ceremonies, then process them all at once.
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <!-- Ceremony filters -->
                    <h6 class="mb-2">Show Ceremonies:</h6>
                    <div class="d-flex flex-wrap gap-2">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="cat-haldi" value="haldi" checked>
                            <label class="form-check-label" for="cat-haldi">Haldi</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="cat-mehendi" value="mehendi" checked>
                            <label class="form-check-label" for="cat-mehendi">Mehendi</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="cat-wedding" value="wedding" checked>
                            <label class="form-check-label" for="cat-wedding">Wedding</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="cat-reception" value="reception" checked>
                            <label class="form-check-label" for="cat-reception">Reception</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Multi-Template Selection Interface -->
    <div class="card mb-4 shadow d-none" id="multiSelectionInterface">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-images me-2"></i> Multi-Template Face Swap (<span id="selectedCount">0</span>/5)</h5>
                <button type="button" class="btn btn-sm btn-light" id="clearSelectionBtn">
                    <i class="fas fa-times"></i> Clear All
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i> Process multiple templates with a single photo. Upload your photo below to create face swaps for all selected templates at once.
            </div>
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="multiSourceInput" class="form-label">Upload Your Photo</label>
                        <input type="file" class="form-control" id="multiSourceInput" accept=".jpg,.jpeg,.png">
                    </div>
                    <div class="image-preview-container mb-3" style="height: 180px; overflow: hidden;">
                        <img id="multiSourcePreview" class="img-fluid d-none" alt="Your photo preview" style="max-height: 180px;">
                        <div id="multiSourcePlaceholder" class="text-center p-4">
                            <i class="fas fa-user-circle mb-2" style="font-size: 3rem; opacity: 0.5;"></i>
                            <p class="text-muted">No photo selected yet<br>Please upload a clear frontal photo</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <h6 class="mb-3">Selected Templates</h6>
                    <div class="row row-cols-2 row-cols-lg-5 g-2" id="selectedTemplatesPreview">
                        <!-- Selected templates will appear here -->
                    </div>
                </div>
            </div>
            <div class="text-center mt-3">
                <button class="btn btn-primary btn-lg" id="processMultipleBtn" disabled>
                    <i class="fas fa-magic me-2"></i> Process All Selected Templates
                </button>
            </div>
        </div>
    </div>

    {% for ceremony in ceremony_types %}
<div class="mb-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">
            {% if ceremony == 'haldi' %}
            <i class="fas fa-sun me-2 text-warning"></i>
            {% elif ceremony == 'mehendi' %}
            <i class="fas fa-paint-brush me-2 text-success"></i>
            {% elif ceremony == 'sangeeth' %}
            <i class="fas fa-music me-2 text-info"></i>
            {% elif ceremony == 'wedding' %}
            <i class="fas fa-ring me-2 text-danger"></i>
            {% elif ceremony == 'reception' %}
            <i class="fas fa-glass-cheers me-2 text-purple"></i>
            {% endif %}
            {{ ceremony|title }} Ceremony
        </h3>
        <div class="d-flex gap-2">
            <button class="btn btn-sm btn-icon btn-outline-danger toggle-select-mode-btn" data-ceremony="{{ ceremony }}" title="Manage Templates">
                <i class="fas fa-cog"></i>
            </button>
            <button class="btn btn-sm btn-icon btn-outline-primary toggle-row-btn" data-target="{{ ceremony }}-row" title="Expand All">
                <i class="fas fa-chevron-down"></i>
            </button>
        </div>
    </div>
    
    <!-- Template Carousel with Arrow Navigation -->
    <div class="template-carousel position-relative mb-4" id="{{ ceremony }}-carousel">
        <!-- Left/Right Navigation Arrows -->
        <div class="carousel-nav-buttons">
            <button class="btn btn-dark carousel-nav-btn prev-btn" data-target="{{ ceremony }}-carousel">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="btn btn-dark carousel-nav-btn next-btn" data-target="{{ ceremony }}-carousel">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        
        <!-- Delete Tools -->
        <div class="template-management-tools mb-2">
            <div class="bulk-actions d-none" id="{{ ceremony }}-bulk-actions">
                <button class="btn btn-sm btn-danger delete-selected-btn" data-ceremony="{{ ceremony }}">
                    <i class="fas fa-trash-alt me-1"></i> Delete Selected
                </button>
                <button class="btn btn-sm btn-danger delete-all-btn" data-ceremony="{{ ceremony }}">
                    <i class="fas fa-times-circle me-1"></i> Delete All {{ ceremony|title }}
                </button>
                <button class="btn btn-sm btn-secondary cancel-select-btn" data-ceremony="{{ ceremony }}">
                    <i class="fas fa-times me-1"></i> Cancel
                </button>
            </div>
        </div>
        
        <!-- Cards Row - Showing Only a Few at a Time -->
        <div class="template-row">
            <div class="row row-cols-1 row-cols-sm-2 row-cols-md-4" id="{{ ceremony }}-cards">
                {% if all_templates[ceremony]|length > 0 %}
                    {% for template in all_templates[ceremony] %}
                        <div class="col template-card mb-4 {% if loop.index0 >= 4 %}extra-card{% endif %}" data-index="{{ loop.index0 }}">
                            <div class="card shadow-sm bridal-card position-relative" 
                                data-template-path="{{ template.url }}"
                                data-ceremony="{{ ceremony }}"
                                data-style="{{ ceremony }}">
                                <!-- Selection checkbox -->
                                <div class="template-select-overlay">
                                    <div class="form-check">
                                        <input class="form-check-input template-checkbox" type="checkbox" 
                                               value="{{ template.url }}" 
                                               id="check-{{ ceremony }}-{{ loop.index }}"
                                               data-template-path="{{ template.url }}"
                                               data-ceremony="{{ ceremony }}">
                                        <label class="form-check-label" for="check-{{ ceremony }}-{{ loop.index }}"></label>
                                    </div>
                                </div>
                                
                                <!-- Selection badge and button (initially not selected) -->
                                <div class="position-absolute top-0 end-0 mt-2 me-2 select-badge d-none">
                                    <span class="badge bg-primary rounded-pill">
                                        <i class="fas fa-check"></i> Selected
                                    </span>
                                </div>
                                
                                <img src="{{ template.url }}" class="card-img-top preview-image" alt="{{ ceremony|title }} Template" 
                                    loading="lazy" 
                                    data-template-path="{{ template.url }}" 
                                    data-ceremony="{{ ceremony }}" 
                                    style="cursor: pointer;">
                                
                                <!-- Preview hint on hover -->
                                <div class="position-absolute bottom-0 left-0 right-0 p-2 text-center preview-hint" 
                                     style="background: rgba(0,0,0,0.7); opacity: 0;">
                                    <small class="text-white">Click to select</small>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            No {{ ceremony|title }} templates available.
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- No View More Button -->
    </div>
</div>
{% endfor %}
            
            <div class="card shadow-sm mb-4" id="results-card">
                <div class="card-header bg-dark">
                    <h4 class="mb-0"><i class="fas fa-star me-2"></i>Your Bridal Looks</h4>
                </div>
                <div class="card-body">
                    <div id="empty-results" class="text-center py-5">
                        <i class="fas fa-images fa-4x mb-3 text-muted"></i>
                        <h5>No previews generated yet</h5>
                        <p class="text-muted">Upload your photo and click on any bridal template<br>or use the "Generate All Previews" button</p>
                    </div>
                    
                    <div id="result-gallery" class="result-gallery d-none">
                        <!-- Result cards will be generated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-12">
            <div class="card bg-dark shadow">
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="feature-icon">
                                <i class="fas fa-camera"></i>
                            </div>
                            <h5>Multiple Styles</h5>
                            <p class="small">Explore various traditional bridal styles</p>
                        </div>
                        <div class="col-md-3">
                            <div class="feature-icon">
                                <i class="fas fa-magic"></i>
                            </div>
                            <h5>AI Technology</h5>
                            <p class="small">Advanced face swapping algorithms</p>
                        </div>
                        <div class="col-md-3">
                            <div class="feature-icon">
                                <i class="fas fa-download"></i>
                            </div>
                            <h5>Easy Download</h5>
                            <p class="small">Save all your favorite looks</p>
                        </div>
                        <div class="col-md-3">
                            <div class="feature-icon">
                                <i class="fas fa-share-alt"></i>
                            </div>
                            <h5>Share Options</h5>
                            <p class="small">Share with friends and family</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay d-none" id="loading-overlay">
    <div class="spinner mb-3"></div>
    <h4 class="text-white mb-2">Creating Your Bridal Look</h4>
    <p class="text-light" id="loading-message">Processing template...</p>
</div>

<!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle text-warning me-2"></i>Error</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="error-message">
                An error occurred while processing your request.
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Image Preview Modal is already defined above -->

<!-- Image Preview Modal -->
<div class="modal fade" id="imagePreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Template Preview</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="previewModalImage" src="" alt="Template Preview" style="max-width: 100%; max-height: 80vh;">
            </div>
            <div class="modal-footer border-secondary justify-content-between">
                <button type="button" class="btn btn-primary" id="selectTemplateBtn">
                    <i class="fas fa-check-circle me-1"></i> Select for Face Swap
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle text-warning me-2"></i>Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="delete-confirm-message">
                Are you sure you want to delete this template? This action cannot be undone.
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Multi-selection Interface (hidden by default) -->
<div class="container-fluid fixed-bottom bg-dark p-3 d-none" id="multi-selection-interface" style="border-top: 1px solid #333; box-shadow: 0 -2px 10px rgba(0,0,0,0.2); z-index: 1000;">
    <div class="row">
        <div class="col-md-6">
            <div class="d-flex align-items-center">
                <h4 class="mb-0 me-3">Selected Templates: <span id="selected-count" class="badge bg-primary">0</span></h4>
                <button class="btn btn-sm btn-outline-secondary me-2" id="clear-selection-btn">
                    <i class="fas fa-times me-1"></i> Clear Selection
                </button>
            </div>
            <div class="row row-cols-5 g-2 mt-2" id="selected-templates-preview">
                <!-- Selected templates will be displayed here -->
            </div>
        </div>
        <div class="col-md-6">
            <div class="card bg-dark border border-secondary h-100">
                <div class="card-body p-2">
                    <div class="row h-100">
                        <div class="col-md-8">
                            <h5>Upload Your Face Image</h5>
                            <p class="text-muted small">Upload a clear face photo to apply to selected templates</p>
                            <div class="input-group mb-2">
                                <input type="file" class="form-control form-control-sm" id="multi-source-input" accept="image/jpeg,image/png,image/jpg">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="image-preview position-relative h-100 d-flex justify-content-center align-items-center" style="border: 1px dashed #6c757d; border-radius: 5px;">
                                <div id="multi-source-placeholder" class="text-center p-2">
                                    <i class="fas fa-user-circle fa-3x mb-2 text-muted"></i>
                                    <p class="text-muted small mb-0">Image preview</p>
                                </div>
                                <img id="multi-source-preview" class="img-fluid d-none" style="max-height: 100px; max-width: 100%;" alt="Source preview">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-dark border-top border-secondary p-2">
                    <button class="btn btn-primary btn-block w-100" id="process-multiple-btn" disabled>
                        <i class="fas fa-magic me-2"></i> Create Face Swaps for Selected Templates
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // DOM Elements
    const sourceInput = document.getElementById('source-input');
    const sourcePreview = document.getElementById('source-preview');
    const sourcePlaceholder = document.getElementById('source-placeholder');
    const sourceClearBtn = document.getElementById('source-clear-btn');
    const generateBtn = document.getElementById('generate-btn');
    const templateCards = document.querySelectorAll('.bridal-card');
    const emptyResults = document.getElementById('empty-results');
    
    // Multi-selection Elements will be defined below for simplicity
    
    // Variables for multi-selection
    const resultGallery = document.getElementById('result-gallery');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingMessage = document.getElementById('loading-message');
    const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
    const errorMessage = document.getElementById('error-message');
    const modelStatusCard = document.getElementById('model-status-card');
    
    // Check model status
    checkModels();
    
    // Initialize modals
    const deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    const imagePreviewModal = new bootstrap.Modal(document.getElementById('imagePreviewModal'));
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    
    // Current state for delete and preview operations
    let currentDeletePath = null;
    
    // Template selection state
    let selectedTemplates = [];
    
    // Multi-Selection Elements
    const multiSelectionInterface = document.getElementById('multiSelectionInterface');
    const selectedCount = document.getElementById('selectedCount');
    const selectedTemplatesPreview = document.getElementById('selectedTemplatesPreview');
    const clearSelectionBtn = document.getElementById('clearSelectionBtn');
    const processMultipleBtn = document.getElementById('processMultipleBtn');
    const multiSourceInput = document.getElementById('multiSourceInput');
    const multiSourcePreview = document.getElementById('multiSourcePreview');
    const multiSourcePlaceholder = document.getElementById('multiSourcePlaceholder');
    let multiSourceFile = null;
    let currentDeleteCeremony = null;
    let currentBulkDeletePaths = [];
    
    // Simplifying carousel navigation to work with our expand/collapse approach
    document.querySelectorAll('.carousel-nav-btn').forEach(button => {
        button.addEventListener('click', function() {
            const carouselId = this.getAttribute('data-target');
            console.log(`Carousel navigation button clicked for: ${carouselId}`);
            
            // Find the associated ceremony
            const ceremony = carouselId.replace('-carousel', '');
            
            // Get the scroll container for this ceremony
            const cardsContainer = document.getElementById(`${ceremony}-cards`);
            
            if (!cardsContainer) {
                console.error(`Could not find cards container for ${ceremony}`);
                return;
            }
            
            // First make sure the row is expanded
            const toggleButton = document.querySelector(`button.toggle-row-btn[data-target="${ceremony}-row"]`);
            
            if (toggleButton && !toggleButton.classList.contains('expanded')) {
                toggleButton.click();
            }
            
            // Calculate scroll amount (approximately 1 card width)
            const cardWidth = 280; // Approximate width of a card plus margin
            
            // Get the scrollable parent
            const scrollableParent = cardsContainer.closest('.template-row');
            
            if (!scrollableParent) {
                console.error('Could not find scrollable parent');
                return;
            }
            
            // Determine scroll direction
            if (this.classList.contains('prev-btn')) {
                scrollableParent.scrollBy({ left: -cardWidth * 2, behavior: 'smooth' });
            } else {
                scrollableParent.scrollBy({ left: cardWidth * 2, behavior: 'smooth' });
            }
        });
    });
    
    // Initialization is now handled by initializeCarouselsCollapsed() function
    
    // View More buttons
    // Removed view-more button event handlers (no longer needed)
    
    // Delete buttons
    document.querySelectorAll('.delete-template-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.stopPropagation();
            currentDeletePath = this.getAttribute('data-template-path');
            currentDeleteCeremony = this.getAttribute('data-ceremony');
            document.getElementById('delete-confirm-message').textContent = 
                `Are you sure you want to delete this ${currentDeleteCeremony} template? This action cannot be undone.`;
            deleteConfirmModal.show();
        });
    });
    
    // Simple expand/collapse functionality
    document.querySelectorAll('.toggle-row-btn').forEach(button => {
        button.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target');
            const ceremony = targetId.replace('-row', '');
            const container = document.getElementById(`${ceremony}-cards`);
            
            if (!container) {
                console.error(`Card container not found: ${ceremony}-cards`);
                return;
            }
            
            const extraCards = container.querySelectorAll('.template-card.extra-card');
            console.log(`Toggle row button clicked for ${ceremony}`);
            console.log(`Found ${extraCards.length} extra cards`);
            
            // Check current state (expanded or collapsed)
            const isExpanded = this.classList.contains('expanded');
            console.log(`Current state: ${isExpanded ? 'expanded' : 'collapsed'}`);
            
            if (isExpanded) {
                // Collapse - hide extra cards
                console.log('Collapsing to show only first row');
                extraCards.forEach(card => {
                    card.style.display = 'none';
                });
                
                // Update button appearance
                this.classList.remove('expanded');
                this.classList.remove('btn-primary');
                this.classList.add('btn-outline-primary');
                this.innerHTML = '<i class="fas fa-chevron-down"></i> Show All';
                this.setAttribute('title', 'Show All Templates');
            } else {
                // Expand - show all cards
                console.log('Expanding to show all cards');
                extraCards.forEach(card => {
                    card.style.display = 'block';
                });
                
                // Update button appearance
                this.classList.add('expanded');
                this.classList.remove('btn-outline-primary');
                this.classList.add('btn-primary');
                this.innerHTML = '<i class="fas fa-chevron-up"></i> Show Less';
                this.setAttribute('title', 'Show Fewer Templates');
            }
        });
    });
    
    // Initialize all sections to show only the first row
    function initializeCarouselsCollapsed() {
        console.log('Initializing all sections in collapsed state');
        
        // Hide all cards with the extra-card class
        const extraCards = document.querySelectorAll('.template-card.extra-card');
        console.log(`Found ${extraCards.length} extra cards to hide initially`);
        
        extraCards.forEach(card => {
            card.style.display = 'none';
        });
        
        // Make sure all toggle buttons are in collapsed state
        document.querySelectorAll('.toggle-row-btn').forEach(btn => {
            const icon = btn.querySelector('i');
            btn.classList.remove('expanded');
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-outline-primary');
            btn.innerHTML = '<i class="fas fa-chevron-down"></i> Show All';
            btn.setAttribute('title', 'Show All Templates');
        });
    }
    
    // Call initialization when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM content loaded - initializing template interactions");
        initializeCarouselsCollapsed();
        
        // Initialize global variables for selection
        window.currentMode = 'single'; // Default to single template mode
        window.selectedTemplates = [];
        window.multiSelectionInterface = document.getElementById('multiSelectionInterface');
        window.selectedCount = document.getElementById('selectedCount');
        window.selectedTemplatesPreview = document.getElementById('selectedTemplatesPreview');
        window.processMultipleBtn = document.getElementById('processMultipleBtn');
        window.clearSelectionBtn = document.getElementById('clearSelectionBtn');
        window.multiSourceInput = document.getElementById('multiSourceInput');
        window.multiSourcePreview = document.getElementById('multiSourcePreview');
        window.multiSourcePlaceholder = document.getElementById('multiSourcePlaceholder');
        
        // Initialize preview hint for all template cards
        const previewHints = document.querySelectorAll('.preview-hint');
        previewHints.forEach(hint => {
            const card = hint.closest('.card');
            if (card) {
                card.addEventListener('mouseenter', () => {
                    hint.style.opacity = '1';
                });
                card.addEventListener('mouseleave', () => {
                    hint.style.opacity = '0';
                });
            }
        });
        
        // Initialize selection modes
        initializeSelectionModes();
        
        // Set up event handlers for checkboxes
        document.querySelectorAll('.template-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const templatePath = this.getAttribute('data-template-path');
                const ceremonyType = this.getAttribute('data-ceremony');
                const card = this.closest('.bridal-card');
                
                console.log("Checkbox changed: ", templatePath, ceremonyType, this.checked);
                
                if (this.checked) {
                    // Add to selection
                    if (window.currentMode === 'multi') {
                        // Add to multi-selection
                        const template = {
                            path: templatePath,
                            ceremony: ceremonyType
                        };
                        addTemplateToSelection(template);
                        
                        // Mark the card as selected
                        if (card) {
                            card.classList.add('selected');
                            const badge = card.querySelector('.select-badge');
                            if (badge) badge.classList.remove('d-none');
                        }
                    } else {
                        // Single template mode - uncheck all other checkboxes
                        document.querySelectorAll('.template-checkbox').forEach(cb => {
                            if (cb !== this) {
                                cb.checked = false;
                                const otherCard = cb.closest('.bridal-card');
                                if (otherCard) {
                                    otherCard.classList.remove('selected');
                                    const badge = otherCard.querySelector('.select-badge');
                                    if (badge) badge.classList.add('d-none');
                                }
                            }
                        });
                        
                        // Mark this card as selected
                        if (card) {
                            card.classList.add('selected');
                            const badge = card.querySelector('.select-badge');
                            if (badge) badge.classList.remove('d-none');
                        }
                        
                        // Open the single swap dialog
                        prepareSingleSwap(event, templatePath, ceremonyType);
                    }
                } else {
                    // Remove from selection
                    removeTemplateFromSelection(templatePath);
                    
                    // Mark the card as not selected
                    if (card) {
                        card.classList.remove('selected');
                        const badge = card.querySelector('.select-badge');
                        if (badge) badge.classList.add('d-none');
                    }
                }
            });
        });
        
        // Remove all inline onclick handlers from template images
        document.querySelectorAll('.preview-image').forEach(img => {
            img.removeAttribute('onclick');
        });
        
        // Clear selection button
        if (clearSelectionBtn) {
            clearSelectionBtn.addEventListener('click', function() {
                clearTemplateSelection();
            });
        }
        
        // Source image preview for multi-selection
        if (multiSourceInput) {
            multiSourceInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        multiSourcePreview.src = e.target.result;
                        multiSourcePreview.classList.remove('d-none');
                        multiSourcePlaceholder.classList.add('d-none');
                        
                        // Enable process button if we have templates selected
                        if (selectedTemplates.length > 0) {
                            processMultipleBtn.disabled = false;
                        }
                    };
                    reader.readAsDataURL(this.files[0]);
                }
            });
        }
        
        // Process multiple templates button
        if (processMultipleBtn) {
            processMultipleBtn.addEventListener('click', function() {
                if (!multiSourceInput.files || !multiSourceInput.files[0]) {
                    showError('Please upload your source image first.');
                    return;
                }
                
                if (selectedTemplates.length === 0) {
                    showError('Please select at least one template.');
                    return;
                }
                
                processMultipleTemplates();
            });
        }
    });
    
    // Toggle select mode for bulk deletion
    document.querySelectorAll('.toggle-select-mode-btn').forEach(button => {
        button.addEventListener('click', function() {
            const ceremony = this.getAttribute('data-ceremony');
            const carousel = document.getElementById(`${ceremony}-carousel`);
            if (!carousel) {
                console.error(`Carousel not found: ${ceremony}-carousel`);
                return;
            }
            const selectOverlays = carousel.querySelectorAll('.template-select-overlay');
            const bulkActions = document.getElementById(`${ceremony}-bulk-actions`);
            if (!bulkActions) {
                console.error(`Bulk actions not found: ${ceremony}-bulk-actions`);
                return;
            }
            
            if (bulkActions.classList.contains('d-none')) {
                // Enter select mode
                bulkActions.classList.remove('d-none');
                this.classList.add('d-none');
                selectOverlays.forEach(overlay => overlay.classList.remove('d-none'));
            } else {
                // Exit select mode
                bulkActions.classList.add('d-none');
                this.classList.remove('d-none');
                selectOverlays.forEach(overlay => {
                    overlay.classList.add('d-none');
                    overlay.querySelector('input[type="checkbox"]').checked = false;
                });
            }
        });
    });
    
    // Cancel select mode
    document.querySelectorAll('.cancel-select-btn').forEach(button => {
        button.addEventListener('click', function() {
            const ceremony = this.getAttribute('data-ceremony');
            document.querySelector(`.toggle-select-mode-btn[data-ceremony="${ceremony}"]`).click();
        });
    });
    
    // Delete selected templates
    document.querySelectorAll('.delete-selected-btn').forEach(button => {
        button.addEventListener('click', function() {
            const ceremony = this.getAttribute('data-ceremony');
            const carousel = document.getElementById(`${ceremony}-carousel`);
            const selectedCheckboxes = carousel.querySelectorAll('.template-checkbox:checked');
            
            if (selectedCheckboxes.length === 0) {
                showError('Please select at least one template to delete.');
                return;
            }
            
            currentBulkDeletePaths = Array.from(selectedCheckboxes).map(checkbox => checkbox.value);
            currentDeleteCeremony = ceremony;
            
            document.getElementById('delete-confirm-message').textContent = 
                `Are you sure you want to delete ${selectedCheckboxes.length} template(s)? This action cannot be undone.`;
            deleteConfirmModal.show();
        });
    });
    
    // Delete all templates for a ceremony
    document.querySelectorAll('.delete-all-btn').forEach(button => {
        button.addEventListener('click', function() {
            const ceremony = this.getAttribute('data-ceremony');
            currentDeleteCeremony = ceremony;
            currentBulkDeletePaths = null; // Signal to delete all for this ceremony
            
            document.getElementById('delete-confirm-message').textContent = 
                `Are you sure you want to delete ALL ${ceremony} templates? This action cannot be undone.`;
            deleteConfirmModal.show();
        });
    });
    
    // Handle delete confirmation
    confirmDeleteBtn.addEventListener('click', function() {
        // Prepare delete request
        let deleteData = {};
        
        if (currentBulkDeletePaths === null) {
            // Delete all for ceremony
            deleteData = {
                ceremony_type: currentDeleteCeremony,
                clear_all: true
            };
        } else if (currentBulkDeletePaths.length > 0) {
            // Delete multiple paths
            deleteData = {
                template_paths: currentBulkDeletePaths
            };
        } else if (currentDeletePath) {
            // Delete single path
            deleteData = {
                template_paths: [currentDeletePath]
            };
        }
        
        // Send delete request
        fetch('/delete-templates', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(deleteData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Hide delete confirmation modal
                deleteConfirmModal.hide();
                
                // Reload page to reflect changes
                location.reload();
            } else {
                showError(data.error || 'Failed to delete template(s)');
            }
        })
        .catch(error => {
            showError('Network error: ' + error.message);
        });
    });
    
    // Removed gallery select mode (no longer needed)
    
    // Handle file input change
    sourceInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                sourcePreview.src = e.target.result;
                sourcePreview.classList.remove('d-none');
                sourcePlaceholder.classList.add('d-none');
                sourceClearBtn.classList.remove('d-none');
            };
            
            reader.readAsDataURL(this.files[0]);
        }
    });
    
    // Clear source image
    sourceClearBtn.addEventListener('click', function() {
        sourceInput.value = '';
        sourcePreview.classList.add('d-none');
        sourcePlaceholder.classList.remove('d-none');
        sourceClearBtn.classList.add('d-none');
    });
    
    // Generate all previews
    generateBtn.addEventListener('click', function() {
        if (!sourceInput.files.length) {
            showError('Please upload your photo first');
            return;
        }
        
        // Always use Pinterest templates
        const templateType = 'pinterest';
        
        // Get selected categories
        const selectedCategories = [];
        document.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
            selectedCategories.push(checkbox.value);
        });
        
        if (selectedCategories.length === 0) {
            showError('Please select at least one category');
            return;
        }
        
        // Show loading overlay
        loadingOverlay.classList.remove('d-none');
        loadingMessage.textContent = 'Preparing to generate previews...';
        
        // Clear previous results
        resultGallery.innerHTML = '';
        
        // Count for tracking progress
        let processedCount = 0;
        let totalTemplates = templateCards.length;
        
        // Process each template
        templateCards.forEach((card, index) => {
            const style = card.dataset.style;
            const category = style.charAt(0).toUpperCase() + style.slice(1); // Capitalize first letter
            
            // Skip if category not selected
            if (!selectedCategories.includes(style)) {
                processedCount++;
                updateProgressMessage(processedCount, totalTemplates);
                return;
            }
            
            setTimeout(() => {
                loadingMessage.textContent = `Processing ${category} template...`;
                
                processTemplate(card, templateType, style)
                    .then(() => {
                        processedCount++;
                        updateProgressMessage(processedCount, totalTemplates);
                        
                        if (processedCount >= totalTemplates) {
                            // All templates processed
                            emptyResults.classList.add('d-none');
                            resultGallery.classList.remove('d-none');
                            loadingOverlay.classList.add('d-none');
                        }
                    })
                    .catch(error => {
                        console.error('Error processing template:', error);
                        processedCount++;
                        updateProgressMessage(processedCount, totalTemplates);
                    });
            }, index * 200); // Stagger the requests
        });
    });
    
    // Click on individual template
    templateCards.forEach(card => {
        card.addEventListener('click', function() {
            if (!sourceInput.files.length) {
                showError('Please upload your photo first');
                return;
            }
            
            // Get selected template type
            const templateType = document.querySelector('input[name="templateType"]:checked').value;
            const style = this.dataset.style;
            
            // Show loading overlay
            loadingOverlay.classList.remove('d-none');
            loadingMessage.textContent = `Processing ${style} template...`;
            
            processTemplate(this, templateType, style)
                .then(() => {
                    emptyResults.classList.add('d-none');
                    resultGallery.classList.remove('d-none');
                    loadingOverlay.classList.add('d-none');
                })
                .catch(error => {
                    console.error('Error processing template:', error);
                    loadingOverlay.classList.add('d-none');
                    showError('Failed to process template: ' + error.message);
                });
        });
    });
    
    // Process a template and add result to gallery
    function processTemplate(templateCard, templateType, style) {
        return new Promise((resolve, reject) => {
            const imgSrc = templateCard.querySelector('img').src;
            const category = style.charAt(0).toUpperCase() + style.slice(1); // Capitalize first letter
            
            // Create form data
            const formData = new FormData();
            formData.append('source', sourceInput.files[0]);
            formData.append('style', style);
            formData.append('template_type', templateType);
            
            // Send AJAX request
            fetch('/bridal-swap', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Create result card
                    addResultCard(data.result_image, category, style);
                    resolve();
                } else {
                    showError(data.error || 'Failed to process image');
                    reject(new Error(data.error || 'Failed to process image'));
                }
            })
            .catch(error => {
                showError('Network error: ' + error.message);
                reject(error);
            });
        });
    }
    
    // Add a result card to the gallery
    function addResultCard(imagePath, category, style) {
        const existingCard = document.querySelector(`.result-card[data-style="${style}"]`);
        if (existingCard) {
            existingCard.remove();
        }
        
        const cardHtml = `
            <div class="result-card" data-style="${style}">
                <a href="/uploads/${imagePath}" target="_blank">
                    <img src="/uploads/${imagePath}" class="result-image" alt="${category} Template">
                </a>
                <a href="/uploads/${imagePath}" download="${category}_template.jpg" class="btn-floating btn-download">
                    <i class="fas fa-download"></i>
                </a>
                <button class="btn-floating btn-remove" onclick="removeResult('${style}')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        resultGallery.insertAdjacentHTML('beforeend', cardHtml);
    }
    
    // Check model status
    function checkModels() {
        fetch('/check-models')
            .then(response => response.json())
            .then(data => {
                if (!data.face_detection || !data.face_swap) {
                    modelStatusCard.classList.remove('d-none');
                    let statusMessage = 'Some models are not loaded properly.';
                    
                    if (!data.face_detection) {
                        statusMessage = 'Face detection model is not loaded.';
                    } else if (!data.face_swap) {
                        statusMessage = 'Face swap model is not loaded.';
                    }
                    
                    document.getElementById('model-status-message').textContent = statusMessage;
                }
            })
            .catch(error => {
                console.error('Error checking model status:', error);
                modelStatusCard.classList.remove('d-none');
                document.getElementById('model-status-message').textContent = 'Could not check model status.';
            });
    }
    
    // Update progress message
    function updateProgressMessage(processed, total) {
        const percent = Math.round((processed / total) * 100);
        loadingMessage.textContent = `Processing templates... ${percent}%`;
    }
    
    // Show error message
    function showError(message) {
        errorMessage.textContent = message;
        errorModal.show();
    }
    
    // Image Preview and Multi-selection Functionality
    function setupImagePreviewHandlers() {
        // Quick selection buttons
        document.querySelectorAll('.template-select-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent image preview
                e.preventDefault();
                
                const templatePath = this.getAttribute('data-template-path');
                const ceremony = this.getAttribute('data-ceremony');
                
                // Toggle selection
                const isSelected = this.classList.contains('btn-success');
                
                if (isSelected) {
                    // Remove from selection
                    removeTemplateFromSelection(templatePath);
                    this.classList.remove('btn-success');
                    this.classList.add('btn-primary');
                    this.innerHTML = '<i class="fas fa-plus"></i>';
                    this.title = "Add to selection";
                } else {
                    // Check if we have space for more
                    if (selectedTemplates.length >= 5) {
                        showError('You can only select up to 5 templates.');
                        return;
                    }
                    
                    // Add to selection
                    addTemplateToSelection({
                        path: templatePath,
                        ceremony: ceremony
                    });
                    
                    this.classList.remove('btn-primary');
                    this.classList.add('btn-success');
                    this.innerHTML = '<i class="fas fa-check"></i>';
                    this.title = "Remove from selection";
                }
            });
        });
        
        // Preview image click handler
        document.querySelectorAll('.preview-image').forEach(img => {
            img.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const templatePath = this.getAttribute('data-template-path');
                const ceremony = this.getAttribute('data-ceremony');
                
                // Show full image in modal
                const previewImg = document.getElementById('previewModalImage');
                previewImg.src = templatePath;
                currentPreviewTemplate = { 
                    path: templatePath,
                    ceremony: ceremony
                };
                
                const selectBtn = document.getElementById('selectTemplateBtn');
                selectBtn.disabled = isTemplateSelected(templatePath);
                selectBtn.innerHTML = isTemplateSelected(templatePath) ? 
                    '<i class="fas fa-check me-1"></i> Already Selected' : 
                    '<i class="fas fa-check-circle me-1"></i> Select for Face Swap';
                    
                imagePreviewModal.show();
            });
        });
        
        // Select template button in modal
        document.getElementById('selectTemplateBtn').addEventListener('click', function() {
            if (currentPreviewTemplate && selectedTemplates.length < 5) {
                selectTemplate(currentPreviewTemplate.path, currentPreviewTemplate.ceremony);
                this.disabled = true;
                this.innerHTML = '<i class="fas fa-check me-1"></i> Already Selected';
                // Don't close modal, let user continue viewing
            }
        });
        
        // Multi-source input change handler
        multiSourceInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                multiSourceFile = this.files[0];
                
                reader.onload = function(e) {
                    multiSourcePreview.src = e.target.result;
                    multiSourcePreview.classList.remove('d-none');
                    multiSourcePlaceholder.classList.add('d-none');
                    processMultipleBtn.disabled = selectedTemplates.length === 0;
                };
                
                reader.readAsDataURL(this.files[0]);
            } else {
                multiSourceFile = null;
                multiSourcePreview.classList.add('d-none');
                multiSourcePlaceholder.classList.remove('d-none');
                processMultipleBtn.disabled = true;
            }
        });
        
        // Clear all selected templates
        clearSelectionBtn.addEventListener('click', function() {
            clearSelectedTemplates();
        });
        
        // Process multiple templates button
        processMultipleBtn.addEventListener('click', async function() {
            if (!multiSourceFile || selectedTemplates.length === 0) {
                showError('Please upload an image and select at least one template.');
                return;
            }
            
            const loadingSpinner = '<span class="spinner-border spinner-border-sm me-2"></span> Processing...';
            const originalHTML = this.innerHTML;
            this.disabled = true;
            this.innerHTML = loadingSpinner;
            
            try {
                // Create FormData
                const formData = new FormData();
                formData.append('source', multiSourceFile);
                
                // Add all template paths
                selectedTemplates.forEach((template, index) => {
                    formData.append('templates[]', template.path);
                });
                
                // Send to bridal_swap with the first template, then we'll process the rest
                window.location.href = `/bridal_swap?style=${selectedTemplates[0].ceremony}&multi=true`;
                
            } catch (error) {
                console.error('Error processing images:', error);
                showError('Failed to process images. Please try again.');
                this.disabled = false;
                this.innerHTML = originalHTML;
            }
        });
    }
    
    // Select a template
    function selectTemplate(templatePath, ceremony) {
        if (selectedTemplates.length >= 5) {
            showError('You can only select up to 5 templates.');
            return;
        }
        
        if (!isTemplateSelected(templatePath)) {
            selectedTemplates.push({
                path: templatePath,
                ceremony: ceremony
            });
            
            // Mark template as selected in the gallery
            const card = document.querySelector(`.preview-image[data-template-path="${templatePath}"]`).closest('.bridal-card');
            card.classList.add('selected');
            
            // Show selection badge
            const badge = card.querySelector('.select-badge');
            if (badge) badge.classList.remove('d-none');
            
            updateSelectionInterface();
        }
    }
    
    // Add a template to the selection
    function addTemplateToSelection(template) {
        if (selectedTemplates.length >= 5) {
            showError('You can only select up to 5 templates.');
            
            // Uncheck the checkbox that was just checked
            const checkbox = document.querySelector(`.template-checkbox[data-template-path="${template.path}"]`);
            if (checkbox) checkbox.checked = false;
            
            return false;
        }
        
        if (!isTemplateSelected(template.path)) {
            selectedTemplates.push(template);
            
            // Update the selection interface
            updateSelectionInterface();
            
            // Find the card and mark it as selected
            const card = document.querySelector(`.bridal-card[data-template-path="${template.path}"]`);
            if (card) {
                card.classList.add('selected');
                
                // Show selection badge
                const badge = card.querySelector('.select-badge');
                if (badge) badge.classList.remove('d-none');
                
                // Make sure the checkbox is checked
                const checkbox = card.querySelector('.template-checkbox');
                if (checkbox) checkbox.checked = true;
                
                // Enable process button if we have a source image
                if (window.multiSourceInput && window.multiSourceInput.files && window.multiSourceInput.files[0] && window.processMultipleBtn) {
                    window.processMultipleBtn.disabled = false;
                }
                
                // Update selection button if it exists
                const selectBtn = card.querySelector('.template-select-btn');
                if (selectBtn) {
                    selectBtn.classList.remove('btn-primary');
                    selectBtn.classList.add('btn-success');
                    selectBtn.innerHTML = '<i class="fas fa-check"></i>';
                    selectBtn.title = "Remove from selection";
                }
            }
            
            return true;
        }
        
        return false;
    }
    
    // Remove a template from the selection
    function removeTemplateFromSelection(templatePath) {
        const index = selectedTemplates.findIndex(template => template.path === templatePath);
        
        if (index !== -1) {
            const removed = selectedTemplates.splice(index, 1)[0];
            
            // Update the selection interface
            updateSelectionInterface();
            
            // Find the card and unmark it
            const card = document.querySelector(`.bridal-card[data-template-path="${templatePath}"]`);
            if (card) {
                card.classList.remove('selected');
                
                // Hide selection badge
                const badge = card.querySelector('.select-badge');
                if (badge) badge.classList.add('d-none');
                
                // Make sure the checkbox is unchecked
                const checkbox = card.querySelector('.template-checkbox');
                if (checkbox) checkbox.checked = false;
                
                // Disable process button if no templates are selected
                if (selectedTemplates.length === 0 && window.processMultipleBtn) {
                    window.processMultipleBtn.disabled = true;
                }
                
                // Update selection button if it exists
                const selectBtn = card.querySelector('.template-select-btn');
                if (selectBtn) {
                    selectBtn.classList.remove('btn-success');
                    selectBtn.classList.add('btn-primary');
                    selectBtn.innerHTML = '<i class="fas fa-plus"></i>';
                    selectBtn.title = "Add to selection";
                }
            }
            
            return true;
        }
        
        return false;
    }
    
    // Check if template is already selected
    function isTemplateSelected(templatePath) {
        return selectedTemplates.some(t => t.path === templatePath);
    }
    
    // Update the multi-selection interface
    function updateSelectionInterface() {
        if (selectedTemplates.length > 0) {
            multiSelectionInterface.classList.remove('d-none');
            selectedCount.textContent = selectedTemplates.length;
            
            // Update the preview
            selectedTemplatesPreview.innerHTML = '';
            selectedTemplates.forEach((template, index) => {
                const previewCol = document.createElement('div');
                previewCol.className = 'col';
                previewCol.innerHTML = `
                    <div class="position-relative">
                        <img src="${template.path}" class="img-thumbnail" alt="Selected template ${index+1}" style="height: 100px; object-fit: cover;">
                        <button class="btn btn-sm btn-icon btn-danger position-absolute top-0 end-0 m-1 remove-template-btn" 
                                data-index="${index}">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="text-center small mt-1">${template.ceremony.charAt(0).toUpperCase() + template.ceremony.slice(1)}</div>
                    </div>
                `;
                selectedTemplatesPreview.appendChild(previewCol);
            });
            
            // Add event listeners to remove buttons
            document.querySelectorAll('.remove-template-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    if (index >= 0 && index < selectedTemplates.length) {
                        removeTemplateFromSelection(selectedTemplates[index].path);
                    }
                });
            });
            
            // Enable/disable process button based on source image
            if (multiSourceInput && multiSourceInput.files && multiSourceInput.files[0]) {
                processMultipleBtn.disabled = false;
            } else {
                processMultipleBtn.disabled = true;
            }
        } else {
            multiSelectionInterface.classList.add('d-none');
        }
    }
    
    // Remove a template by index
    function removeTemplateByIndex(index) {
        if (index >= 0 && index < selectedTemplates.length) {
            const removed = selectedTemplates.splice(index, 1)[0];
            
            // Remove selection styling from gallery
            const card = document.querySelector(`.preview-image[data-template-path="${removed.path}"]`).closest('.bridal-card');
            if (card) {
                card.classList.remove('selected');
                
                // Hide selection badge
                const badge = card.querySelector('.select-badge');
                if (badge) badge.classList.add('d-none');
            }
            
            updateSelectionInterface();
        }
    }
    
    // Clear all selected templates
    function clearSelectedTemplates() {
        // Remove all selection styling
        selectedTemplates.forEach(template => {
            const card = document.querySelector(`.preview-image[data-template-path="${template.path}"]`).closest('.bridal-card');
            if (card) {
                card.classList.remove('selected');
                
                // Hide selection badge
                const badge = card.querySelector('.select-badge');
                if (badge) badge.classList.add('d-none');
            }
        });
        
        selectedTemplates = [];
        updateSelectionInterface();
    }
    
    // Initialize the image preview and multi-selection handlers
    setupImagePreviewHandlers();
    
    // Function to show full-size image preview
    window.showFullSizePreview = function(imageElement) {
        // Don't trigger preview if in selection mode
        if (document.querySelector('.template-select-mode')) {
            return;
        }
        
        const templatePath = imageElement.getAttribute('data-template-path');
        const ceremony = imageElement.getAttribute('data-ceremony');
        
        // Set the modal image source
        const previewImage = document.getElementById('previewModalImage');
        previewImage.src = templatePath;
        
        // Update modal title with ceremony name
        document.querySelector('#imagePreviewModal .modal-title').textContent = 
            `${ceremony.charAt(0).toUpperCase() + ceremony.slice(1)} Template Preview`;
        
        // Update select button with data
        const selectBtn = document.getElementById('selectTemplateBtn');
        selectBtn.dataset.templatePath = templatePath;
        selectBtn.dataset.ceremony = ceremony;
        
        // Show the modal
        const previewModal = new bootstrap.Modal(document.getElementById('imagePreviewModal'));
        previewModal.show();
    };
    
    // Add click event to the select template button
    document.getElementById('selectTemplateBtn').addEventListener('click', function() {
        const templatePath = this.dataset.templatePath;
        const ceremony = this.dataset.ceremony;
        
        // Find the template card
        const templateCard = document.querySelector(`.template-card[data-template-path="${templatePath}"]`);
        if (templateCard) {
            // Add to selected templates (if using multi-selection)
            if (selectedTemplates.length < 5) {
                addTemplateToSelection({
                    path: templatePath,
                    ceremony: ceremony
                });
            }
            
            // Close the modal
            bootstrap.Modal.getInstance(document.getElementById('imagePreviewModal')).hide();
        }
    });
    
    // Expose removeResult to global scope
    window.removeResult = function(style) {
        const card = document.querySelector(`.result-card[data-style="${style}"]`);
        if (card) {
            card.remove();
            
            // Check if any results left
            if (resultGallery.children.length === 0) {
                resultGallery.classList.add('d-none');
                emptyResults.classList.remove('d-none');
            }
        }
    };
    
    // Function to show the full-size preview
    function showFullsizePreview(imagePath, ceremonyType) {
        // Set the image source
        document.getElementById('fullsize-preview-image').src = imagePath;
        
        // Set the title with the ceremony type
        document.getElementById('fullsize-preview-title').textContent = 
            ceremonyType.charAt(0).toUpperCase() + ceremonyType.slice(1) + ' Template';
        
        // Show the modal
        const previewModal = new bootstrap.Modal(document.getElementById('fullsizePreviewModal'));
        previewModal.show();
    }
    
    // Toggle template selection
    function toggleTemplateSelection(event, templatePath, ceremonyType) {
        // Prevent the click from triggering the parent's click event (image preview)
        event.stopPropagation();
        
        const template = {
            path: templatePath,
            ceremony: ceremonyType
        };
        
        if (isTemplateSelected(templatePath)) {
            // Already selected, remove it
            removeTemplateFromSelection(templatePath);
        } else {
            // Not selected, add it
            addTemplateToSelection(template);
        }
    }
    
    // Clear all selected templates
    function clearTemplateSelection() {
        // Remove selected class from all cards
        document.querySelectorAll('.bridal-card.selected').forEach(card => {
            card.classList.remove('selected');
            
            // Hide selection badge
            const badge = card.querySelector('.select-badge');
            if (badge) badge.classList.add('d-none');
            
            // Uncheck all checkboxes
            const checkbox = card.querySelector('.template-checkbox');
            if (checkbox) checkbox.checked = false;
            
            // Reset selection button if it exists
            const selectBtn = card.querySelector('.template-select-btn');
            if (selectBtn) {
                selectBtn.classList.remove('btn-success');
                selectBtn.classList.add('btn-primary');
                selectBtn.innerHTML = '<i class="fas fa-plus"></i>';
                selectBtn.title = "Add to selection";
            }
        });
        
        // Clear the array
        selectedTemplates.length = 0;
        
        // Update the interface
        updateSelectionInterface();
    }
    
    // Initialize the selection modes (single/multi)
    function initializeSelectionModes() {
        const singleModeRadio = document.getElementById('single-mode');
        const multiModeRadio = document.getElementById('multi-mode');
        const singleModeDesc = document.getElementById('single-mode-desc');
        const multiModeDesc = document.getElementById('multi-mode-desc');
        
        if (singleModeRadio && multiModeRadio) {
            // Single mode selection
            singleModeRadio.addEventListener('change', function() {
                if (this.checked) {
                    window.currentMode = 'single';
                    if (window.multiSelectionInterface) {
                        window.multiSelectionInterface.classList.add('d-none');
                    }
                    if (singleModeDesc) singleModeDesc.classList.remove('d-none');
                    if (multiModeDesc) multiModeDesc.classList.add('d-none');
                    
                    // Update preview hints
                    document.querySelectorAll('.preview-hint small').forEach(hint => {
                        hint.textContent = 'Click to use this template';
                    });
                    
                    // Clear any selections
                    clearTemplateSelection();
                }
            });
            
            // Multi mode selection
            multiModeRadio.addEventListener('change', function() {
                if (this.checked) {
                    window.currentMode = 'multi';
                    if (singleModeDesc) singleModeDesc.classList.add('d-none');
                    if (multiModeDesc) multiModeDesc.classList.remove('d-none');
                    
                    // Update preview hints
                    document.querySelectorAll('.preview-hint small').forEach(hint => {
                        hint.textContent = 'Click to select for multi-swap';
                    });
                    
                    // Show multi-selection interface if it exists
                    if (window.multiSelectionInterface) {
                        window.multiSelectionInterface.classList.remove('d-none');
                    }
                    
                    // Clear any selections
                    clearTemplateSelection();
                }
            });
        }
    }
    
    // Handle single template face swap
    function prepareSingleSwap(event, templatePath, ceremonyType) {
        // Prevent the click from triggering the parent's click event (image preview)
        event.stopPropagation();
        
        // Create the single swap modal if it doesn't exist
        if (!document.getElementById('singleSwapModal')) {
            createSingleSwapModal();
        }
        
        // Set the template information
        document.getElementById('single-swap-template-preview').src = templatePath;
        document.getElementById('single-swap-ceremony-type').textContent = ceremonyType.charAt(0).toUpperCase() + ceremonyType.slice(1);
        document.getElementById('single-swap-template-path').value = templatePath;
        document.getElementById('single-swap-ceremony').value = ceremonyType;
        
        // Clear previous source image
        document.getElementById('singleSourcePreview').classList.add('d-none');
        document.getElementById('singleSourcePlaceholder').classList.remove('d-none');
        document.getElementById('singleSourceInput').value = '';
        
        // Show the modal
        const singleSwapModal = new bootstrap.Modal(document.getElementById('singleSwapModal'));
        singleSwapModal.show();
    }
    
    // Create the single swap modal dynamically
    function createSingleSwapModal() {
        const modalHtml = `
        <div class="modal fade" id="singleSwapModal" tabindex="-1" aria-labelledby="singleSwapModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content bg-dark">
                    <div class="modal-header">
                        <h5 class="modal-title" id="singleSwapModalLabel">Single Face Swap</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="card bg-secondary">
                                    <div class="card-header">
                                        <h6 class="mb-0">Your Photo</h6>
                                    </div>
                                    <div class="card-body text-center">
                                        <div class="mb-3">
                                            <input type="file" class="form-control" id="singleSourceInput" accept=".jpg,.jpeg,.png">
                                        </div>
                                        <div class="image-preview-container" style="height: 200px; overflow: hidden;">
                                            <img id="singleSourcePreview" class="img-fluid d-none" alt="Your photo preview" style="max-height: 200px;">
                                            <div id="singleSourcePlaceholder" class="text-center p-4">
                                                <i class="fas fa-user-circle" style="font-size: 4rem; opacity: 0.5;"></i>
                                                <p class="text-muted">Upload your photo</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-secondary">
                                    <div class="card-header">
                                        <h6 class="mb-0">Template: <span id="single-swap-ceremony-type"></span></h6>
                                    </div>
                                    <div class="card-body text-center">
                                        <img id="single-swap-template-preview" class="img-fluid" style="max-height: 240px;" alt="Template preview">
                                        <input type="hidden" id="single-swap-template-path">
                                        <input type="hidden" id="single-swap-ceremony">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="processSingleBtn" disabled>
                            <i class="fas fa-magic me-2"></i> Create Face Swap
                        </button>
                    </div>
                </div>
            </div>
        </div>`;
        
        // Append modal to body
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Setup event listeners
        const singleSourceInput = document.getElementById('singleSourceInput');
        const singleSourcePreview = document.getElementById('singleSourcePreview');
        const singleSourcePlaceholder = document.getElementById('singleSourcePlaceholder');
        const processSingleBtn = document.getElementById('processSingleBtn');
        
        // Source image preview for single swap
        singleSourceInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    singleSourcePreview.src = e.target.result;
                    singleSourcePreview.classList.remove('d-none');
                    singleSourcePlaceholder.classList.add('d-none');
                    processSingleBtn.disabled = false;
                };
                reader.readAsDataURL(this.files[0]);
            }
        });
        
        // Process single template
        processSingleBtn.addEventListener('click', function() {
            if (!singleSourceInput.files || !singleSourceInput.files[0]) {
                showError('Please upload your source image first.');
                return;
            }
            
            processSingleTemplate();
        });
    }
    
    // Process a single template with the source face
    function processSingleTemplate() {
        // Get elements
        const processSingleBtn = document.getElementById('processSingleBtn');
        const singleSourceInput = document.getElementById('singleSourceInput');
        const templatePath = document.getElementById('single-swap-template-path').value;
        const ceremony = document.getElementById('single-swap-ceremony').value;
        
        // Show loading spinner
        const originalText = processSingleBtn.innerHTML;
        processSingleBtn.disabled = true;
        processSingleBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Processing...';
        
        // Create form data
        const formData = new FormData();
        formData.append('source', singleSourceInput.files[0]);
        formData.append('style', ceremony);
        formData.append('template_path', templatePath);
        
        // Send AJAX request
        fetch('/bridal-swap', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            processSingleBtn.innerHTML = originalText;
            processSingleBtn.disabled = false;
            
            if (data.success) {
                // Hide the modal
                bootstrap.Modal.getInstance(document.getElementById('singleSwapModal')).hide();
                
                // Show the result in a new window or redirect to result page
                window.open(data.result_image, '_blank');
            } else {
                showError(data.error || 'Failed to process image');
            }
        })
        .catch(error => {
            processSingleBtn.innerHTML = originalText;
            processSingleBtn.disabled = false;
            showError('An error occurred: ' + error.message);
        });
    }
    
    // Process multiple templates with the same source face
    function processMultipleTemplates() {
        // Show loading spinner
        const processBtn = document.getElementById('processMultipleBtn');
        const originalText = processBtn.innerHTML;
        processBtn.disabled = true;
        processBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Processing...';
        
        // Create FormData with the source image and template paths
        const formData = new FormData();
        formData.append('source', document.getElementById('multiSourceInput').files[0]);
        
        // Add all selected templates
        selectedTemplates.forEach((template, index) => {
            formData.append('templates[]', template.path);
        });
        
        // Send AJAX request to multi-face-swap endpoint
        fetch('/multi-face-swap', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            processBtn.innerHTML = originalText;
            processBtn.disabled = false;
            
            if (data.success) {
                // Redirect to results page
                window.location.href = '/bridal-results?session=' + data.session_id;
            } else {
                showError(data.error || 'Failed to process images');
            }
        })
        .catch(error => {
            processBtn.innerHTML = originalText;
            processBtn.disabled = false;
            showError('An error occurred: ' + error.message);
        });
    }
});
</script>

<!-- Fullsize Preview Modal -->
<div class="modal fade" id="fullsizePreviewModal" tabindex="-1" aria-labelledby="fullsizePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content bg-dark">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="fullsize-preview-title">Template Preview</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center p-0">
                <img id="fullsize-preview-image" src="" class="img-fluid" alt="Template Preview">
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}