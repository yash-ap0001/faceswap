{% extends "base.html" %}

{% block style %}
<style>
    :root {
        --primary-purple: #5e35b1;
        --secondary-purple: #7e57c2;
        --dark-purple: #4527a0;
        --light-purple: #b39ddb;
        --dark-surface: #1a1a1a;
        --card-surface: #212121;
        --border-color: #333333;
        --text-primary: #f5f5f5;
        --text-secondary: #bdbdbd;
        --accent-color: var(--light-purple);
    }
    
    body {
        background-color: var(--dark-surface);
        color: var(--text-primary);
        font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
    
    .navbar {
        background-color: var(--dark-purple) !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .card {
        background-color: var(--card-surface);
        border: 1px solid var(--border-color);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .card-header {
        background-color: rgba(0,0,0,0.2);
        border-bottom: 1px solid var(--border-color);
    }
    
    .btn-primary {
        background-color: var(--primary-purple);
        border-color: var(--primary-purple);
    }
    
    .btn-primary:hover {
        background-color: var(--secondary-purple);
        border-color: var(--secondary-purple);
    }
    
    .btn-outline-primary {
        color: var(--accent-color);
        border-color: var(--accent-color);
    }
    
    .btn-outline-primary:hover {
        background-color: var(--primary-purple);
        border-color: var(--primary-purple);
        color: white;
    }
    
    .bridal-card {
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    
    .bridal-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
    
    .bridal-card.selected {
        border-color: var(--accent-color);
    }
    
    .image-preview-container {
        min-height: 300px;
        border: 2px dashed var(--light-purple);
        border-radius: 5px;
    }
    
    .result-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 30px;
    }
    
    .result-card {
        position: relative;
        overflow: hidden;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
    }
    
    .result-card:hover {
        transform: scale(1.03);
        box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }
    
    .result-image {
        width: 100%;
        height: 350px;
        object-fit: cover;
    }
    
    .result-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: rgba(74, 20, 140, 0.7);
        padding: 10px;
        color: white;
    }
    
    .pulse-animation {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(206, 147, 216, 0.7);
        }
        70% {
            box-shadow: 0 0 0 15px rgba(206, 147, 216, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(206, 147, 216, 0);
        }
    }
    
    .placeholder-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #757575;
    }
    
    .category-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: var(--primary-purple);
        color: white;
        padding: 5px 10px;
        border-radius: 20px;
        font-weight: bold;
        z-index: 10;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .btn-floating {
        position: absolute;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        z-index: 10;
    }
    
    .btn-download {
        bottom: 60px;
        right: 10px;
        background-color: var(--secondary-purple);
        color: white;
    }
    
    .btn-remove {
        top: 10px;
        left: 10px;
        background-color: #f44336;
        color: white;
    }
    
    .feature-icon {
        font-size: 2rem;
        color: var(--accent-color);
        margin-bottom: 15px;
        opacity: 0.8;
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        flex-direction: column;
    }
    
    .spinner {
        width: 70px;
        height: 70px;
        border: 8px solid rgba(179, 157, 219, 0.3);
        border-top: 8px solid var(--primary-purple);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<!-- Upload Photo Button (top-right) -->
<div class="position-fixed top-0 end-0 p-4" style="z-index: 1050; margin-top: 60px; margin-right: 20px;">
    <button type="button" class="btn btn-primary rounded-circle shadow-lg" data-bs-toggle="modal" data-bs-target="#uploadPhotoModal" style="width: 60px; height: 60px;">
        <i class="fas fa-upload"></i>
    </button>
</div>

<!-- Upload Photo Modal Dialog -->
<div class="modal fade" id="uploadPhotoModal" tabindex="-1" aria-labelledby="uploadPhotoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white border-0">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title" id="uploadPhotoModalLabel">Upload Your Photo</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="image-preview-container mb-4 d-flex align-items-center justify-content-center mx-auto" style="width: 200px; height: 200px;">
                    <img id="source-preview" class="img-fluid d-none rounded-circle shadow" style="width: 180px; height: 180px; object-fit: cover;" alt="Your photo preview">
                    <div id="source-placeholder" class="placeholder-container">
                        <svg width="120" height="120" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mb-3">
                            <path opacity="0.4" d="M12 22.01C17.5228 22.01 22 17.5329 22 12.01C22 6.48716 17.5228 2.01001 12 2.01001C6.47715 2.01001 2 6.48716 2 12.01C2 17.5329 6.47715 22.01 12 22.01Z" fill="rgba(126, 87, 194, 0.3)"/>
                            <path d="M12 6.94001C9.93 6.94001 8.25 8.62001 8.25 10.69C8.25 12.72 9.84 14.37 11.95 14.43C11.98 14.43 12.02 14.43 12.04 14.43C12.06 14.43 12.09 14.43 12.11 14.43C12.12 14.43 12.13 14.43 12.13 14.43C14.15 14.36 15.74 12.72 15.75 10.69C15.75 8.62001 14.07 6.94001 12 6.94001Z" fill="rgba(126, 87, 194, 0.7)"/>
                            <path d="M18.7802 19.36C17.0002 21 14.6202 22.01 12.0002 22.01C9.38022 22.01 7.00021 21 5.22021 19.36C5.46021 18.45 6.11022 17.62 7.06021 16.98C9.79022 15.16 14.2302 15.16 16.9402 16.98C17.9002 17.62 18.5402 18.45 18.7802 19.36Z" fill="rgba(126, 87, 194, 0.7)"/>
                        </svg>
                        <p class="text-center text-secondary">No photo selected yet</p>
                    </div>
                </div>
                
                <form id="upload-form" enctype="multipart/form-data">
                    <div class="upload-input">
                        <input type="file" id="source-input" name="source" accept=".jpg,.jpeg,.png" required>
                        <div class="upload-btn btn btn-outline-light w-100">
                            <i class="fas fa-cloud-upload-alt me-2"></i> Choose Photo
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-secondary mt-3 d-none" type="button" id="source-clear-btn">
                        <i class="fas fa-times me-1"></i> Remove Photo
                    </button>
                </form>
                
                <div class="alert alert-info mt-3">
                    <small><i class="fas fa-info-circle me-1"></i> Select a clear frontal photo of your face for best results</small>
                </div>
            </div>
            <div class="modal-footer border-top border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="confirmUpload">
                    <i class="fas fa-check me-1"></i> Confirm Photo
                </button>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid py-4">
    <!-- Settings Bar -->
    <div class="card mb-4 shadow">
        <div class="card-body p-2">
            <div class="row align-items-center">
                <!-- Template type filters removed - Using only Pinterest photos now -->
                <div class="col-12">
                    <div class="d-flex gap-2 justify-content-md-end mt-3 mt-md-0">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="cat-haldi" value="haldi" checked>
                            <label class="form-check-label" for="cat-haldi">Haldi</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="cat-mehendi" value="mehendi" checked>
                            <label class="form-check-label" for="cat-mehendi">Mehendi</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="cat-wedding" value="wedding" checked>
                            <label class="form-check-label" for="cat-wedding">Wedding</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="cat-reception" value="reception" checked>
                            <label class="form-check-label" for="cat-reception">Reception</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Haldi Section -->
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="mb-0"><i class="fas fa-sun me-2 text-warning"></i>Haldi Ceremony</h3>
            <a href="#" class="text-decoration-none">More <i class="fas fa-chevron-right ms-1"></i></a>
        </div>
        <div class="row" id="haldi-templates-container">
                            <!-- Template cards will be loaded here -->
                            <div class="col-md-4 mb-4">
                                <div class="card shadow-sm bridal-card" data-style="haldi">
                                    <div class="category-badge">Haldi</div>
                                    <img src="/uploads/templates/real/weeding saree.jpg" class="card-img-top" alt="Haldi Template" style="height: 300px; object-fit: cover;">
                                    <div class="card-body">
                                        <h5 class="card-title">Haldi Ceremony</h5>
                                        <p class="card-text small">Yellow saree with traditional gold jewelry</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4 mb-4">
                                <div class="card shadow-sm bridal-card" data-style="mehendi">
                                    <div class="category-badge">Mehendi</div>
                                    <img src="/uploads/templates/real/halfhand.jpg" class="card-img-top" alt="Mehendi Template" style="height: 300px; object-fit: cover;">
                                    <div class="card-body">
                                        <h5 class="card-title">Mehendi Function</h5>
                                        <p class="card-text small">Beautiful henna designs with red bridal outfit</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4 mb-4">
                                <div class="card shadow-sm bridal-card" data-style="wedding">
                                    <div class="category-badge">Wedding</div>
                                    <img src="/uploads/templates/real/voni dress.jpg" class="card-img-top" alt="Wedding Template" style="height: 300px; object-fit: cover;">
                                    <div class="card-body">
                                        <h5 class="card-title">Wedding Ceremony</h5>
                                        <p class="card-text small">Elegant red outfit with traditional namaste pose</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4 mb-4">
                                <div class="card shadow-sm bridal-card" data-style="reception">
                                    <div class="category-badge">Reception</div>
                                    <img src="/uploads/templates/real/jewellary.jpg" class="card-img-top" alt="Reception Template" style="height: 300px; object-fit: cover;">
                                    <div class="card-body">
                                        <h5 class="card-title">Jewelry Showcase</h5>
                                        <p class="card-text small">Traditional gold jewelry with elegant saree</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4 mb-4">
                                <div class="card shadow-sm bridal-card" data-style="reception">
                                    <div class="category-badge">Reception</div>
                                    <img src="/uploads/templates/real/full dress.jpg" class="card-img-top" alt="Full Dress Template" style="height: 300px; object-fit: cover;">
                                    <div class="card-body">
                                        <h5 class="card-title">Full Bridal Attire</h5>
                                        <p class="card-text small">Complete bridal look with embroidered lehenga</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card shadow-sm mb-4" id="results-card">
                <div class="card-header bg-dark">
                    <h4 class="mb-0"><i class="fas fa-star me-2"></i>Your Bridal Looks</h4>
                </div>
                <div class="card-body">
                    <div id="empty-results" class="text-center py-5">
                        <i class="fas fa-images fa-4x mb-3 text-muted"></i>
                        <h5>No previews generated yet</h5>
                        <p class="text-muted">Upload your photo and click on any bridal template<br>or use the "Generate All Previews" button</p>
                    </div>
                    
                    <div id="result-gallery" class="result-gallery d-none">
                        <!-- Result cards will be generated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-12">
            <div class="card bg-dark shadow">
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="feature-icon">
                                <i class="fas fa-camera"></i>
                            </div>
                            <h5>Multiple Styles</h5>
                            <p class="small">Explore various traditional bridal styles</p>
                        </div>
                        <div class="col-md-3">
                            <div class="feature-icon">
                                <i class="fas fa-magic"></i>
                            </div>
                            <h5>AI Technology</h5>
                            <p class="small">Advanced face swapping algorithms</p>
                        </div>
                        <div class="col-md-3">
                            <div class="feature-icon">
                                <i class="fas fa-download"></i>
                            </div>
                            <h5>Easy Download</h5>
                            <p class="small">Save all your favorite looks</p>
                        </div>
                        <div class="col-md-3">
                            <div class="feature-icon">
                                <i class="fas fa-share-alt"></i>
                            </div>
                            <h5>Share Options</h5>
                            <p class="small">Share with friends and family</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay d-none" id="loading-overlay">
    <div class="spinner mb-3"></div>
    <h4 class="text-white mb-2">Creating Your Bridal Look</h4>
    <p class="text-light" id="loading-message">Processing template...</p>
</div>

<!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle text-warning me-2"></i>Error</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="error-message">
                An error occurred while processing your request.
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // DOM Elements
    const sourceInput = document.getElementById('source-input');
    const sourcePreview = document.getElementById('source-preview');
    const sourcePlaceholder = document.getElementById('source-placeholder');
    const sourceClearBtn = document.getElementById('source-clear-btn');
    const generateBtn = document.getElementById('generate-btn');
    const templateCards = document.querySelectorAll('.bridal-card');
    const emptyResults = document.getElementById('empty-results');
    const resultGallery = document.getElementById('result-gallery');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingMessage = document.getElementById('loading-message');
    const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
    const errorMessage = document.getElementById('error-message');
    const modelStatusCard = document.getElementById('model-status-card');
    
    // Check model status
    checkModels();
    
    // Handle file input change
    sourceInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                sourcePreview.src = e.target.result;
                sourcePreview.classList.remove('d-none');
                sourcePlaceholder.classList.add('d-none');
                sourceClearBtn.classList.remove('d-none');
            };
            
            reader.readAsDataURL(this.files[0]);
        }
    });
    
    // Clear source image
    sourceClearBtn.addEventListener('click', function() {
        sourceInput.value = '';
        sourcePreview.classList.add('d-none');
        sourcePlaceholder.classList.remove('d-none');
        sourceClearBtn.classList.add('d-none');
    });
    
    // Generate all previews
    generateBtn.addEventListener('click', function() {
        if (!sourceInput.files.length) {
            showError('Please upload your photo first');
            return;
        }
        
        // Always use Pinterest templates
        const templateType = 'pinterest';
        
        // Get selected categories
        const selectedCategories = [];
        document.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
            selectedCategories.push(checkbox.value);
        });
        
        if (selectedCategories.length === 0) {
            showError('Please select at least one category');
            return;
        }
        
        // Show loading overlay
        loadingOverlay.classList.remove('d-none');
        loadingMessage.textContent = 'Preparing to generate previews...';
        
        // Clear previous results
        resultGallery.innerHTML = '';
        
        // Count for tracking progress
        let processedCount = 0;
        let totalTemplates = templateCards.length;
        
        // Process each template
        templateCards.forEach((card, index) => {
            const style = card.dataset.style;
            const category = card.querySelector('.category-badge').textContent;
            
            // Skip if category not selected
            if (!selectedCategories.includes(style)) {
                processedCount++;
                updateProgressMessage(processedCount, totalTemplates);
                return;
            }
            
            setTimeout(() => {
                loadingMessage.textContent = `Processing ${category} template...`;
                
                processTemplate(card, templateType, style)
                    .then(() => {
                        processedCount++;
                        updateProgressMessage(processedCount, totalTemplates);
                        
                        if (processedCount >= totalTemplates) {
                            // All templates processed
                            emptyResults.classList.add('d-none');
                            resultGallery.classList.remove('d-none');
                            loadingOverlay.classList.add('d-none');
                        }
                    })
                    .catch(error => {
                        console.error('Error processing template:', error);
                        processedCount++;
                        updateProgressMessage(processedCount, totalTemplates);
                    });
            }, index * 200); // Stagger the requests
        });
    });
    
    // Click on individual template
    templateCards.forEach(card => {
        card.addEventListener('click', function() {
            if (!sourceInput.files.length) {
                showError('Please upload your photo first');
                return;
            }
            
            // Get selected template type
            const templateType = document.querySelector('input[name="templateType"]:checked').value;
            const style = this.dataset.style;
            
            // Show loading overlay
            loadingOverlay.classList.remove('d-none');
            loadingMessage.textContent = `Processing ${style} template...`;
            
            processTemplate(this, templateType, style)
                .then(() => {
                    emptyResults.classList.add('d-none');
                    resultGallery.classList.remove('d-none');
                    loadingOverlay.classList.add('d-none');
                })
                .catch(error => {
                    console.error('Error processing template:', error);
                    loadingOverlay.classList.add('d-none');
                    showError('Failed to process template: ' + error.message);
                });
        });
    });
    
    // Process a template and add result to gallery
    function processTemplate(templateCard, templateType, style) {
        return new Promise((resolve, reject) => {
            const imgSrc = templateCard.querySelector('img').src;
            const title = templateCard.querySelector('.card-title').textContent;
            const category = templateCard.querySelector('.category-badge').textContent;
            
            // Create form data
            const formData = new FormData();
            formData.append('source', sourceInput.files[0]);
            formData.append('style', style);
            formData.append('template_type', templateType);
            
            // Send AJAX request
            fetch('/bridal-swap', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Create result card
                    addResultCard(data.result_image, title, category, style);
                    resolve();
                } else {
                    showError(data.error || 'Failed to process image');
                    reject(new Error(data.error || 'Failed to process image'));
                }
            })
            .catch(error => {
                showError('Network error: ' + error.message);
                reject(error);
            });
        });
    }
    
    // Add a result card to the gallery
    function addResultCard(imagePath, title, category, style) {
        const existingCard = document.querySelector(`.result-card[data-style="${style}"]`);
        if (existingCard) {
            existingCard.remove();
        }
        
        const cardHtml = `
            <div class="result-card" data-style="${style}">
                <div class="category-badge">${category}</div>
                <a href="/uploads/${imagePath}" target="_blank">
                    <img src="/uploads/${imagePath}" class="result-image" alt="${title}">
                </a>
                <div class="result-overlay">
                    <h5 class="mb-0">${title}</h5>
                </div>
                <a href="/uploads/${imagePath}" download="${title.replace(/\s+/g, '_')}.jpg" class="btn-floating btn-download">
                    <i class="fas fa-download"></i>
                </a>
                <button class="btn-floating btn-remove" onclick="removeResult('${style}')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        resultGallery.insertAdjacentHTML('beforeend', cardHtml);
    }
    
    // Check model status
    function checkModels() {
        fetch('/check-models')
            .then(response => response.json())
            .then(data => {
                if (!data.face_detection || !data.face_swap) {
                    modelStatusCard.classList.remove('d-none');
                    let statusMessage = 'Some models are not loaded properly.';
                    
                    if (!data.face_detection) {
                        statusMessage = 'Face detection model is not loaded.';
                    } else if (!data.face_swap) {
                        statusMessage = 'Face swap model is not loaded.';
                    }
                    
                    document.getElementById('model-status-message').textContent = statusMessage;
                }
            })
            .catch(error => {
                console.error('Error checking model status:', error);
                modelStatusCard.classList.remove('d-none');
                document.getElementById('model-status-message').textContent = 'Could not check model status.';
            });
    }
    
    // Update progress message
    function updateProgressMessage(processed, total) {
        const percent = Math.round((processed / total) * 100);
        loadingMessage.textContent = `Processing templates... ${percent}%`;
    }
    
    // Show error message
    function showError(message) {
        errorMessage.textContent = message;
        errorModal.show();
    }
    
    // Expose removeResult to global scope
    window.removeResult = function(style) {
        const card = document.querySelector(`.result-card[data-style="${style}"]`);
        if (card) {
            card.remove();
            
            // Check if any results left
            if (resultGallery.children.length === 0) {
                resultGallery.classList.add('d-none');
                emptyResults.classList.remove('d-none');
            }
        }
    };
});
</script>
{% endblock %}