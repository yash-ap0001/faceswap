{% extends "base.html" %}

{% block style %}
<style>
    :root {
        --primary-purple: #5e35b1;
        --secondary-purple: #7e57c2;
        --dark-purple: #4527a0;
        --light-purple: #b39ddb;
        --dark-surface: #1a1a1a;
        --card-surface: #212121;
        --border-color: #333333;
        --text-primary: #f5f5f5;
        --text-secondary: #bdbdbd;
        --accent-color: var(--light-purple);
    }
    
    body {
        background-color: var(--dark-surface);
        color: var(--text-primary);
        font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
    
    .navbar {
        background-color: var(--dark-purple) !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .card {
        background-color: var(--card-surface);
        border: 1px solid var(--border-color);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .card-header {
        background-color: rgba(0,0,0,0.2);
        border-bottom: 1px solid var(--border-color);
    }
    
    .btn-primary {
        background-color: var(--primary-purple);
        border-color: var(--primary-purple);
    }
    
    .btn-primary:hover {
        background-color: var(--secondary-purple);
        border-color: var(--secondary-purple);
    }
    
    .btn-outline-primary {
        color: var(--accent-color);
        border-color: var(--accent-color);
    }
    
    .btn-outline-primary:hover {
        background-color: var(--primary-purple);
        border-color: var(--primary-purple);
        color: white;
    }
    
    .bridal-card {
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        height: 300px;
        overflow: hidden;
        padding: 0;
    }
    
    .card-img-top {
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: top;
    }
    
    .bridal-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
    
    .bridal-card.selected {
        border-color: var(--accent-color);
    }
    
    .image-preview-container {
        min-height: 300px;
        border: 2px dashed var(--light-purple);
        border-radius: 5px;
    }
    
    .result-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 30px;
    }
    
    .result-card {
        position: relative;
        overflow: hidden;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
    }
    
    .result-card:hover {
        transform: scale(1.03);
        box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }
    
    .result-image {
        width: 100%;
        height: 350px;
        object-fit: cover;
        object-position: top;
    }
    
    /* Result overlay removed */
    
    .pulse-animation {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(206, 147, 216, 0.7);
        }
        70% {
            box-shadow: 0 0 0 15px rgba(206, 147, 216, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(206, 147, 216, 0);
        }
    }
    
    .placeholder-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #757575;
    }
    
    /* Badge styles removed */
    
    .btn-floating {
        position: absolute;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        z-index: 10;
    }
    
    .btn-download {
        bottom: 60px;
        right: 10px;
        background-color: var(--secondary-purple);
        color: white;
    }
    
    .btn-remove {
        top: 10px;
        left: 10px;
        background-color: #f44336;
        color: white;
    }
    
    .feature-icon {
        font-size: 2rem;
        color: var(--accent-color);
        margin-bottom: 15px;
        opacity: 0.8;
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        flex-direction: column;
    }
    
    .spinner {
        width: 70px;
        height: 70px;
        border: 8px solid rgba(179, 157, 219, 0.3);
        border-top: 8px solid var(--primary-purple);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Carousel and navigation styles */
    .template-carousel {
        position: relative;
        margin-bottom: 40px;
    }
    
    .carousel-nav-buttons {
        position: absolute;
        top: 50%;
        width: 100%;
        transform: translateY(-50%);
        z-index: 10;
        display: flex;
        justify-content: space-between;
        pointer-events: none;
    }
    
    .carousel-nav-btn {
        height: 50px;
        width: 50px;
        border-radius: 50%;
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0.7;
        transition: opacity 0.3s;
        pointer-events: auto;
    }
    
    .carousel-nav-btn:hover {
        opacity: 1;
    }
    
    .template-card {
        transition: transform 0.3s ease, opacity 0.2s ease;
    }
    
    .template-card:hover {
        transform: translateY(-5px);
    }
    
    /* Template management styles */
    .template-management-tools {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 0;
    }
    
    .bulk-actions {
        display: flex;
        gap: 8px;
    }
    
    .template-select-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        z-index: 5;
        display: flex;
        align-items: flex-start;
        justify-content: flex-end;
        padding: 15px;
    }
    
    .template-select-overlay .form-check {
        background-color: white;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .template-checkbox {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }
    
    .delete-template-btn {
        visibility: hidden;
        opacity: 0;
        transition: visibility 0s, opacity 0.3s;
    }
    
    .bridal-card:hover .delete-template-btn {
        visibility: visible;
        opacity: 1;
    }
    
    /* View more button styles */
    .view-more-btn {
        transition: all 0.3s ease;
    }
    
    .view-more-btn.expanded {
        background-color: var(--primary-purple);
        color: white;
    }
    
    /* Modal styles for fullscreen gallery */
    .fullscreen-gallery-modal .modal-dialog {
        max-width: 95%;
        margin: 10px auto;
        height: 90vh;
    }
    
    .fullscreen-gallery-modal .modal-content {
        height: 100%;
    }
    
    .fullscreen-gallery-modal .modal-body {
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<!-- Upload Photo Button (top-right) -->
<div class="position-fixed top-0 end-0 p-4" style="z-index: 1050; margin-top: 60px; margin-right: 20px;">
    <button type="button" class="btn btn-primary rounded-circle shadow-lg" data-bs-toggle="modal" data-bs-target="#uploadPhotoModal" style="width: 60px; height: 60px;">
        <i class="fas fa-upload"></i>
    </button>
</div>

<!-- Upload Photo Modal Dialog -->
<div class="modal fade" id="uploadPhotoModal" tabindex="-1" aria-labelledby="uploadPhotoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white border-0">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title" id="uploadPhotoModalLabel">Upload Your Photo</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="image-preview-container mb-4 d-flex align-items-center justify-content-center mx-auto" style="width: 200px; height: 200px;">
                    <img id="source-preview" class="img-fluid d-none rounded-circle shadow" style="width: 180px; height: 180px; object-fit: cover;" alt="Your photo preview">
                    <div id="source-placeholder" class="placeholder-container">
                        <svg width="120" height="120" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mb-3">
                            <path opacity="0.4" d="M12 22.01C17.5228 22.01 22 17.5329 22 12.01C22 6.48716 17.5228 2.01001 12 2.01001C6.47715 2.01001 2 6.48716 2 12.01C2 17.5329 6.47715 22.01 12 22.01Z" fill="rgba(126, 87, 194, 0.3)"/>
                            <path d="M12 6.94001C9.93 6.94001 8.25 8.62001 8.25 10.69C8.25 12.72 9.84 14.37 11.95 14.43C11.98 14.43 12.02 14.43 12.04 14.43C12.06 14.43 12.09 14.43 12.11 14.43C12.12 14.43 12.13 14.43 12.13 14.43C14.15 14.36 15.74 12.72 15.75 10.69C15.75 8.62001 14.07 6.94001 12 6.94001Z" fill="rgba(126, 87, 194, 0.7)"/>
                            <path d="M18.7802 19.36C17.0002 21 14.6202 22.01 12.0002 22.01C9.38022 22.01 7.00021 21 5.22021 19.36C5.46021 18.45 6.11022 17.62 7.06021 16.98C9.79022 15.16 14.2302 15.16 16.9402 16.98C17.9002 17.62 18.5402 18.45 18.7802 19.36Z" fill="rgba(126, 87, 194, 0.7)"/>
                        </svg>
                        <p class="text-center text-secondary">No photo selected yet</p>
                    </div>
                </div>
                
                <form id="upload-form" enctype="multipart/form-data">
                    <div class="upload-input">
                        <input type="file" id="source-input" name="source" accept=".jpg,.jpeg,.png" required>
                        <div class="upload-btn btn btn-outline-light w-100">
                            <i class="fas fa-cloud-upload-alt me-2"></i> Choose Photo
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-secondary mt-3 d-none" type="button" id="source-clear-btn">
                        <i class="fas fa-times me-1"></i> Remove Photo
                    </button>
                </form>
                
                <div class="alert alert-info mt-3">
                    <small><i class="fas fa-info-circle me-1"></i> Select a clear frontal photo of your face for best results</small>
                </div>
            </div>
            <div class="modal-footer border-top border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="confirmUpload">
                    <i class="fas fa-check me-1"></i> Confirm Photo
                </button>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid py-4">
    <!-- Settings Bar -->
    <div class="card mb-4 shadow">
        <div class="card-body p-2">
            <div class="row align-items-center">
                <!-- Template type filters removed - Using only Pinterest photos now -->
                <div class="col-12">
                    <div class="d-flex gap-2 justify-content-md-end mt-3 mt-md-0">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="cat-haldi" value="haldi" checked>
                            <label class="form-check-label" for="cat-haldi">Haldi</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="cat-mehendi" value="mehendi" checked>
                            <label class="form-check-label" for="cat-mehendi">Mehendi</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="cat-wedding" value="wedding" checked>
                            <label class="form-check-label" for="cat-wedding">Wedding</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="cat-reception" value="reception" checked>
                            <label class="form-check-label" for="cat-reception">Reception</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    {% for ceremony in ceremony_types %}
<div class="mb-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">
            {% if ceremony == 'haldi' %}
            <i class="fas fa-sun me-2 text-warning"></i>
            {% elif ceremony == 'mehendi' %}
            <i class="fas fa-paint-brush me-2 text-success"></i>
            {% elif ceremony == 'sangeeth' %}
            <i class="fas fa-music me-2 text-info"></i>
            {% elif ceremony == 'wedding' %}
            <i class="fas fa-ring me-2 text-danger"></i>
            {% elif ceremony == 'reception' %}
            <i class="fas fa-glass-cheers me-2 text-purple"></i>
            {% endif %}
            {{ ceremony|title }} Ceremony
        </h3>
        <button class="btn btn-sm btn-outline-primary toggle-row-btn" data-target="{{ ceremony }}-row">
            <i class="fas fa-chevron-down"></i> Expand All
        </button>
    </div>
    
    <!-- Template Carousel with Arrow Navigation -->
    <div class="template-carousel position-relative mb-4" id="{{ ceremony }}-carousel">
        <!-- Left/Right Navigation Arrows -->
        <div class="carousel-nav-buttons">
            <button class="btn btn-dark carousel-nav-btn prev-btn" data-target="{{ ceremony }}-carousel">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="btn btn-dark carousel-nav-btn next-btn" data-target="{{ ceremony }}-carousel">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        
        <!-- Delete Tools -->
        <div class="template-management-tools mb-2">
            <button class="btn btn-sm btn-outline-danger toggle-select-mode-btn" data-ceremony="{{ ceremony }}">
                <i class="fas fa-trash me-1"></i> Manage Templates
            </button>
            <div class="bulk-actions d-none" id="{{ ceremony }}-bulk-actions">
                <button class="btn btn-sm btn-danger delete-selected-btn" data-ceremony="{{ ceremony }}">
                    <i class="fas fa-trash-alt me-1"></i> Delete Selected
                </button>
                <button class="btn btn-sm btn-danger delete-all-btn" data-ceremony="{{ ceremony }}">
                    <i class="fas fa-times-circle me-1"></i> Delete All {{ ceremony|title }}
                </button>
                <button class="btn btn-sm btn-secondary cancel-select-btn" data-ceremony="{{ ceremony }}">
                    <i class="fas fa-times me-1"></i> Cancel
                </button>
            </div>
        </div>
        
        <!-- Cards Row - Showing Only a Few at a Time -->
        <div class="template-row">
            <div class="row" id="{{ ceremony }}-cards">
                {% if all_templates[ceremony]|length > 0 %}
                    {% for template in all_templates[ceremony] %}
                        <div class="col-md-4 template-card mb-4" data-index="{{ loop.index0 }}" data-template-path="{{ template.url }}">
                            <div class="card shadow-sm bridal-card position-relative" data-style="{{ ceremony }}">
                                <!-- Selection checkbox (hidden by default) -->
                                <div class="template-select-overlay d-none">
                                    <div class="form-check">
                                        <input class="form-check-input template-checkbox" type="checkbox" value="{{ template.url }}" id="check-{{ ceremony }}-{{ loop.index }}">
                                        <label class="form-check-label" for="check-{{ ceremony }}-{{ loop.index }}"></label>
                                    </div>
                                </div>
                                
                                <img src="{{ template.url }}" class="card-img-top" alt="{{ ceremony|title }} Template">
                                <!-- Individual delete button (visible on hover) -->
                                <button class="btn btn-sm btn-outline-danger delete-template-btn position-absolute bottom-0 end-0 m-2" 
                                        data-template-path="{{ template.url }}" data-ceremony="{{ ceremony }}">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            No {{ ceremony|title }} templates available.
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- View More Button -->
        <div class="text-center mt-3">
            <button class="btn btn-outline-primary view-more-btn" data-ceremony="{{ ceremony }}">
                <i class="fas fa-images me-1"></i> View All {{ ceremony|title }} Templates
            </button>
        </div>
    </div>
</div>
{% endfor %}
            
            <div class="card shadow-sm mb-4" id="results-card">
                <div class="card-header bg-dark">
                    <h4 class="mb-0"><i class="fas fa-star me-2"></i>Your Bridal Looks</h4>
                </div>
                <div class="card-body">
                    <div id="empty-results" class="text-center py-5">
                        <i class="fas fa-images fa-4x mb-3 text-muted"></i>
                        <h5>No previews generated yet</h5>
                        <p class="text-muted">Upload your photo and click on any bridal template<br>or use the "Generate All Previews" button</p>
                    </div>
                    
                    <div id="result-gallery" class="result-gallery d-none">
                        <!-- Result cards will be generated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-12">
            <div class="card bg-dark shadow">
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="feature-icon">
                                <i class="fas fa-camera"></i>
                            </div>
                            <h5>Multiple Styles</h5>
                            <p class="small">Explore various traditional bridal styles</p>
                        </div>
                        <div class="col-md-3">
                            <div class="feature-icon">
                                <i class="fas fa-magic"></i>
                            </div>
                            <h5>AI Technology</h5>
                            <p class="small">Advanced face swapping algorithms</p>
                        </div>
                        <div class="col-md-3">
                            <div class="feature-icon">
                                <i class="fas fa-download"></i>
                            </div>
                            <h5>Easy Download</h5>
                            <p class="small">Save all your favorite looks</p>
                        </div>
                        <div class="col-md-3">
                            <div class="feature-icon">
                                <i class="fas fa-share-alt"></i>
                            </div>
                            <h5>Share Options</h5>
                            <p class="small">Share with friends and family</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay d-none" id="loading-overlay">
    <div class="spinner mb-3"></div>
    <h4 class="text-white mb-2">Creating Your Bridal Look</h4>
    <p class="text-light" id="loading-message">Processing template...</p>
</div>

<!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle text-warning me-2"></i>Error</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="error-message">
                An error occurred while processing your request.
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Fullscreen Gallery Modal -->
<div class="modal fade fullscreen-gallery-modal" id="fullGalleryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="fullGalleryTitle">All Templates</h5>
                <div class="d-flex ms-auto me-2">
                    <div class="form-check form-switch me-3">
                        <input class="form-check-input" type="checkbox" id="gallerySelectAll">
                        <label class="form-check-label" for="gallerySelectAll">Select All</label>
                    </div>
                    <button type="button" id="galleryDeleteSelected" class="btn btn-sm btn-danger me-2 d-none">
                        <i class="fas fa-trash-alt me-1"></i> Delete Selected
                    </button>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="fullGalleryBody">
                <div class="container-fluid">
                    <div class="row" id="fullGalleryGrid">
                        <!-- Templates will be inserted here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle text-warning me-2"></i>Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="delete-confirm-message">
                Are you sure you want to delete this template? This action cannot be undone.
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // DOM Elements
    const sourceInput = document.getElementById('source-input');
    const sourcePreview = document.getElementById('source-preview');
    const sourcePlaceholder = document.getElementById('source-placeholder');
    const sourceClearBtn = document.getElementById('source-clear-btn');
    const generateBtn = document.getElementById('generate-btn');
    const templateCards = document.querySelectorAll('.bridal-card');
    const emptyResults = document.getElementById('empty-results');
    const resultGallery = document.getElementById('result-gallery');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingMessage = document.getElementById('loading-message');
    const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
    const errorMessage = document.getElementById('error-message');
    const modelStatusCard = document.getElementById('model-status-card');
    
    // Check model status
    checkModels();
    
    // Initialize modals
    const fullGalleryModal = new bootstrap.Modal(document.getElementById('fullGalleryModal'));
    const deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    
    // Current state for delete operations
    let currentDeletePath = null;
    let currentDeleteCeremony = null;
    let currentBulkDeletePaths = [];
    
    // Initialize carousel navigation
    document.querySelectorAll('.carousel-nav-btn').forEach(button => {
        button.addEventListener('click', function() {
            const carouselId = this.getAttribute('data-target');
            const carouselEl = document.getElementById(carouselId);
            const cardRow = carouselEl.querySelector('.row');
            const cards = cardRow.querySelectorAll('.template-card');
            
            // Get visible cards
            const visibleCards = Array.from(cards).filter(card => 
                !card.classList.contains('d-none'));
            
            // Skip if no cards
            if (visibleCards.length === 0) return;
            
            // Get current visible indices
            const visibleIndices = visibleCards.map(card => 
                parseInt(card.getAttribute('data-index')));
            
            // Determine navigation direction
            const isNext = this.classList.contains('next-btn');
            const currentPage = Math.floor(Math.min(...visibleIndices) / 3);
            const totalPages = Math.ceil(cards.length / 3);
            let newPage = isNext ? currentPage + 1 : currentPage - 1;
            
            // Ensure page is in bounds
            if (newPage < 0) newPage = totalPages - 1;
            if (newPage >= totalPages) newPage = 0;
            
            // Update display
            const startIdx = newPage * 3;
            const endIdx = startIdx + 3;
            
            cards.forEach(card => {
                const cardIndex = parseInt(card.getAttribute('data-index'));
                if (cardIndex >= startIdx && cardIndex < endIdx) {
                    card.classList.remove('d-none');
                } else {
                    card.classList.add('d-none');
                }
            });
        });
    });
    
    // Initialize each carousel to show first 3 cards
    document.querySelectorAll('.template-carousel').forEach(carousel => {
        const cards = carousel.querySelectorAll('.template-card');
        cards.forEach((card, index) => {
            if (index < 3) {
                card.classList.remove('d-none');
            } else {
                card.classList.add('d-none');
            }
        });
    });
    
    // View More buttons
    document.querySelectorAll('.view-more-btn').forEach(button => {
        button.addEventListener('click', function() {
            const ceremony = this.getAttribute('data-ceremony');
            const carousel = document.getElementById(`${ceremony}-carousel`);
            const cards = carousel.querySelectorAll('.template-card');
            
            // Prepare gallery modal
            document.getElementById('fullGalleryTitle').textContent = 
                `All ${ceremony.charAt(0).toUpperCase() + ceremony.slice(1)} Templates`;
            
            // Fill gallery grid
            const galleryGrid = document.getElementById('fullGalleryGrid');
            galleryGrid.innerHTML = '';
            
            cards.forEach(card => {
                const templatePath = card.getAttribute('data-template-path');
                const clonedCard = card.cloneNode(true);
                clonedCard.classList.remove('d-none');
                
                // Add selection checkbox
                const selectOverlay = document.createElement('div');
                selectOverlay.className = 'template-select-overlay gallery-select d-none';
                selectOverlay.innerHTML = `
                    <div class="form-check">
                        <input class="form-check-input gallery-checkbox" type="checkbox" 
                               value="${templatePath}" data-ceremony="${ceremony}">
                    </div>
                `;
                
                clonedCard.querySelector('.card').appendChild(selectOverlay);
                galleryGrid.appendChild(clonedCard);
            });
            
            // Show modal
            fullGalleryModal.show();
        });
    });
    
    // Delete buttons
    document.querySelectorAll('.delete-template-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.stopPropagation();
            currentDeletePath = this.getAttribute('data-template-path');
            currentDeleteCeremony = this.getAttribute('data-ceremony');
            document.getElementById('delete-confirm-message').textContent = 
                `Are you sure you want to delete this ${currentDeleteCeremony} template? This action cannot be undone.`;
            deleteConfirmModal.show();
        });
    });
    
    // Toggle select mode for bulk deletion
    document.querySelectorAll('.toggle-select-mode-btn').forEach(button => {
        button.addEventListener('click', function() {
            const ceremony = this.getAttribute('data-ceremony');
            const carousel = document.getElementById(`${ceremony}-carousel`);
            const selectOverlays = carousel.querySelectorAll('.template-select-overlay');
            const bulkActions = document.getElementById(`${ceremony}-bulk-actions`);
            
            if (bulkActions.classList.contains('d-none')) {
                // Enter select mode
                bulkActions.classList.remove('d-none');
                this.classList.add('d-none');
                selectOverlays.forEach(overlay => overlay.classList.remove('d-none'));
            } else {
                // Exit select mode
                bulkActions.classList.add('d-none');
                this.classList.remove('d-none');
                selectOverlays.forEach(overlay => {
                    overlay.classList.add('d-none');
                    overlay.querySelector('input[type="checkbox"]').checked = false;
                });
            }
        });
    });
    
    // Cancel select mode
    document.querySelectorAll('.cancel-select-btn').forEach(button => {
        button.addEventListener('click', function() {
            const ceremony = this.getAttribute('data-ceremony');
            document.querySelector(`.toggle-select-mode-btn[data-ceremony="${ceremony}"]`).click();
        });
    });
    
    // Delete selected templates
    document.querySelectorAll('.delete-selected-btn').forEach(button => {
        button.addEventListener('click', function() {
            const ceremony = this.getAttribute('data-ceremony');
            const carousel = document.getElementById(`${ceremony}-carousel`);
            const selectedCheckboxes = carousel.querySelectorAll('.template-checkbox:checked');
            
            if (selectedCheckboxes.length === 0) {
                showError('Please select at least one template to delete.');
                return;
            }
            
            currentBulkDeletePaths = Array.from(selectedCheckboxes).map(checkbox => checkbox.value);
            currentDeleteCeremony = ceremony;
            
            document.getElementById('delete-confirm-message').textContent = 
                `Are you sure you want to delete ${selectedCheckboxes.length} template(s)? This action cannot be undone.`;
            deleteConfirmModal.show();
        });
    });
    
    // Delete all templates for a ceremony
    document.querySelectorAll('.delete-all-btn').forEach(button => {
        button.addEventListener('click', function() {
            const ceremony = this.getAttribute('data-ceremony');
            currentDeleteCeremony = ceremony;
            currentBulkDeletePaths = null; // Signal to delete all for this ceremony
            
            document.getElementById('delete-confirm-message').textContent = 
                `Are you sure you want to delete ALL ${ceremony} templates? This action cannot be undone.`;
            deleteConfirmModal.show();
        });
    });
    
    // Handle delete confirmation
    confirmDeleteBtn.addEventListener('click', function() {
        // Prepare delete request
        let deleteData = {};
        
        if (currentBulkDeletePaths === null) {
            // Delete all for ceremony
            deleteData = {
                ceremony_type: currentDeleteCeremony,
                clear_all: true
            };
        } else if (currentBulkDeletePaths.length > 0) {
            // Delete multiple paths
            deleteData = {
                template_paths: currentBulkDeletePaths
            };
        } else if (currentDeletePath) {
            // Delete single path
            deleteData = {
                template_paths: [currentDeletePath]
            };
        }
        
        // Send delete request
        fetch('/delete-templates', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(deleteData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Hide modals
                deleteConfirmModal.hide();
                fullGalleryModal.hide();
                
                // Reload page to reflect changes
                location.reload();
            } else {
                showError(data.error || 'Failed to delete template(s)');
            }
        })
        .catch(error => {
            showError('Network error: ' + error.message);
        });
    });
    
    // Gallery select mode
    const gallerySelectAll = document.getElementById('gallerySelectAll');
    const galleryDeleteSelected = document.getElementById('galleryDeleteSelected');
    
    gallerySelectAll.addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.gallery-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        
        galleryDeleteSelected.classList.toggle('d-none', !this.checked);
    });
    
    // Enable delete button when gallery items are selected
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('gallery-checkbox')) {
            const anyChecked = document.querySelector('.gallery-checkbox:checked') !== null;
            galleryDeleteSelected.classList.toggle('d-none', !anyChecked);
        }
    });
    
    // Gallery delete selected
    galleryDeleteSelected.addEventListener('click', function() {
        const selectedCheckboxes = document.querySelectorAll('.gallery-checkbox:checked');
        
        if (selectedCheckboxes.length === 0) {
            showError('Please select at least one template to delete.');
            return;
        }
        
        currentBulkDeletePaths = Array.from(selectedCheckboxes).map(checkbox => checkbox.value);
        currentDeleteCeremony = selectedCheckboxes[0].getAttribute('data-ceremony');
        
        document.getElementById('delete-confirm-message').textContent = 
            `Are you sure you want to delete ${selectedCheckboxes.length} template(s)? This action cannot be undone.`;
        deleteConfirmModal.show();
    });
    
    // Handle file input change
    sourceInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                sourcePreview.src = e.target.result;
                sourcePreview.classList.remove('d-none');
                sourcePlaceholder.classList.add('d-none');
                sourceClearBtn.classList.remove('d-none');
            };
            
            reader.readAsDataURL(this.files[0]);
        }
    });
    
    // Clear source image
    sourceClearBtn.addEventListener('click', function() {
        sourceInput.value = '';
        sourcePreview.classList.add('d-none');
        sourcePlaceholder.classList.remove('d-none');
        sourceClearBtn.classList.add('d-none');
    });
    
    // Generate all previews
    generateBtn.addEventListener('click', function() {
        if (!sourceInput.files.length) {
            showError('Please upload your photo first');
            return;
        }
        
        // Always use Pinterest templates
        const templateType = 'pinterest';
        
        // Get selected categories
        const selectedCategories = [];
        document.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
            selectedCategories.push(checkbox.value);
        });
        
        if (selectedCategories.length === 0) {
            showError('Please select at least one category');
            return;
        }
        
        // Show loading overlay
        loadingOverlay.classList.remove('d-none');
        loadingMessage.textContent = 'Preparing to generate previews...';
        
        // Clear previous results
        resultGallery.innerHTML = '';
        
        // Count for tracking progress
        let processedCount = 0;
        let totalTemplates = templateCards.length;
        
        // Process each template
        templateCards.forEach((card, index) => {
            const style = card.dataset.style;
            const category = style.charAt(0).toUpperCase() + style.slice(1); // Capitalize first letter
            
            // Skip if category not selected
            if (!selectedCategories.includes(style)) {
                processedCount++;
                updateProgressMessage(processedCount, totalTemplates);
                return;
            }
            
            setTimeout(() => {
                loadingMessage.textContent = `Processing ${category} template...`;
                
                processTemplate(card, templateType, style)
                    .then(() => {
                        processedCount++;
                        updateProgressMessage(processedCount, totalTemplates);
                        
                        if (processedCount >= totalTemplates) {
                            // All templates processed
                            emptyResults.classList.add('d-none');
                            resultGallery.classList.remove('d-none');
                            loadingOverlay.classList.add('d-none');
                        }
                    })
                    .catch(error => {
                        console.error('Error processing template:', error);
                        processedCount++;
                        updateProgressMessage(processedCount, totalTemplates);
                    });
            }, index * 200); // Stagger the requests
        });
    });
    
    // Click on individual template
    templateCards.forEach(card => {
        card.addEventListener('click', function() {
            if (!sourceInput.files.length) {
                showError('Please upload your photo first');
                return;
            }
            
            // Get selected template type
            const templateType = document.querySelector('input[name="templateType"]:checked').value;
            const style = this.dataset.style;
            
            // Show loading overlay
            loadingOverlay.classList.remove('d-none');
            loadingMessage.textContent = `Processing ${style} template...`;
            
            processTemplate(this, templateType, style)
                .then(() => {
                    emptyResults.classList.add('d-none');
                    resultGallery.classList.remove('d-none');
                    loadingOverlay.classList.add('d-none');
                })
                .catch(error => {
                    console.error('Error processing template:', error);
                    loadingOverlay.classList.add('d-none');
                    showError('Failed to process template: ' + error.message);
                });
        });
    });
    
    // Process a template and add result to gallery
    function processTemplate(templateCard, templateType, style) {
        return new Promise((resolve, reject) => {
            const imgSrc = templateCard.querySelector('img').src;
            const category = style.charAt(0).toUpperCase() + style.slice(1); // Capitalize first letter
            
            // Create form data
            const formData = new FormData();
            formData.append('source', sourceInput.files[0]);
            formData.append('style', style);
            formData.append('template_type', templateType);
            
            // Send AJAX request
            fetch('/bridal-swap', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Create result card
                    addResultCard(data.result_image, category, style);
                    resolve();
                } else {
                    showError(data.error || 'Failed to process image');
                    reject(new Error(data.error || 'Failed to process image'));
                }
            })
            .catch(error => {
                showError('Network error: ' + error.message);
                reject(error);
            });
        });
    }
    
    // Add a result card to the gallery
    function addResultCard(imagePath, category, style) {
        const existingCard = document.querySelector(`.result-card[data-style="${style}"]`);
        if (existingCard) {
            existingCard.remove();
        }
        
        const cardHtml = `
            <div class="result-card" data-style="${style}">
                <a href="/uploads/${imagePath}" target="_blank">
                    <img src="/uploads/${imagePath}" class="result-image" alt="${category} Template">
                </a>
                <a href="/uploads/${imagePath}" download="${category}_template.jpg" class="btn-floating btn-download">
                    <i class="fas fa-download"></i>
                </a>
                <button class="btn-floating btn-remove" onclick="removeResult('${style}')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        resultGallery.insertAdjacentHTML('beforeend', cardHtml);
    }
    
    // Check model status
    function checkModels() {
        fetch('/check-models')
            .then(response => response.json())
            .then(data => {
                if (!data.face_detection || !data.face_swap) {
                    modelStatusCard.classList.remove('d-none');
                    let statusMessage = 'Some models are not loaded properly.';
                    
                    if (!data.face_detection) {
                        statusMessage = 'Face detection model is not loaded.';
                    } else if (!data.face_swap) {
                        statusMessage = 'Face swap model is not loaded.';
                    }
                    
                    document.getElementById('model-status-message').textContent = statusMessage;
                }
            })
            .catch(error => {
                console.error('Error checking model status:', error);
                modelStatusCard.classList.remove('d-none');
                document.getElementById('model-status-message').textContent = 'Could not check model status.';
            });
    }
    
    // Update progress message
    function updateProgressMessage(processed, total) {
        const percent = Math.round((processed / total) * 100);
        loadingMessage.textContent = `Processing templates... ${percent}%`;
    }
    
    // Show error message
    function showError(message) {
        errorMessage.textContent = message;
        errorModal.show();
    }
    
    // Expose removeResult to global scope
    window.removeResult = function(style) {
        const card = document.querySelector(`.result-card[data-style="${style}"]`);
        if (card) {
            card.remove();
            
            // Check if any results left
            if (resultGallery.children.length === 0) {
                resultGallery.classList.add('d-none');
                emptyResults.classList.remove('d-none');
            }
        }
    };
});
</script>
{% endblock %}