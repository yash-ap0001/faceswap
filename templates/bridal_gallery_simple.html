{% extends "base.html" %}

{% block style %}
<style>
    /* Basic styling */
    body {
        background-color: #1e1e2f;
        color: #ffffff;
    }
    
    .ceremony-header {
        background-color: rgba(94, 53, 177, 0.2);
        border-left: 4px solid #7e57c2;
        padding: 10px 15px;
        margin-bottom: 20px;
        border-radius: 0 4px 4px 0;
    }
    
    .template-img {
        height: 350px;
        width: 100%;
        object-fit: cover;
        border-radius: 8px;
        transition: transform 0.2s;
        cursor: pointer;
    }
    
    .template-img:hover {
        transform: scale(1.03);
    }
    
    .template-card {
        margin-bottom: 1.5rem;
    }
    
    /* Hide additional templates by default */
    .hidden-template {
        display: none;
    }
    
    /* Template card actions */
    .template-actions {
        position: absolute;
        bottom: 10px;
        right: 10px;
        opacity: 0;
        transition: opacity 0.2s;
    }
    
    .template-card:hover .template-actions {
        opacity: 1;
    }
    
    /* Preview modal */
    .modal-content {
        background-color: #1e1e2f;
        border: 1px solid #2e2e4f;
    }
    
    .modal-header, .modal-footer {
        border-color: #2e2e4f;
    }
    
    /* Multi-selection bar */
    .multi-selection-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: #2e2e4f;
        padding: 15px;
        z-index: 1000;
        transform: translateY(100%);
        transition: transform 0.3s;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
    }
    
    .multi-selection-bar.active {
        transform: translateY(0);
    }
    
    .selected-preview {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 4px;
        margin-right: 10px;
        border: 2px solid #5e35b1;
    }
    
    /* Selected template indicator */
    .selected-indicator {
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: #5e35b1;
        color: white;
        width: 25px;
        height: 25px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        display: none;
    }
    
    .template-container.selected .selected-indicator {
        display: flex;
    }
    
    .template-container.selected .template-img {
        border: 3px solid #5e35b1;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header with navigation buttons -->
    <div class="row mb-4">
        <div class="col-md-6">
            <h1 class="mb-0">Bridal Gallery</h1>
            <p class="text-muted">Browse template images for different ceremonies</p>
        </div>
        <div class="col-md-6 text-end">
            <a href="{{ url_for('bridal_swap') }}" class="btn btn-primary">
                <i class="fas fa-exchange-alt me-2"></i>Single Face Swap
            </a>
            <a href="{{ url_for('bridal_multi_swap') }}" class="btn btn-info ms-2">
                <i class="fas fa-images me-2"></i>Multi-Template Swap
            </a>
            <a href="{{ url_for('bulk_upload_page') }}" class="btn btn-secondary ms-2">
                <i class="fas fa-upload me-2"></i>Upload Templates
            </a>
        </div>
    </div>
    
    <!-- Model status card -->
    <div class="row mb-4" id="model-status-container">
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <i class="fas fa-exclamation-triangle me-2"></i>Model Status
                </div>
                <div class="card-body">
                    <p class="card-text">Loading face swap models... This may take a moment.</p>
                    <button class="btn btn-sm btn-warning" id="check-models-btn">
                        <i class="fas fa-sync-alt me-2"></i>Check Status
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Ceremonies -->
    {% for ceremony in ceremony_types %}
    <div class="row mb-5">
        <div class="col-12">
            <div class="ceremony-header d-flex justify-content-between align-items-center">
                <h2>
                    {% if ceremony == 'haldi' %}
                    <i class="fas fa-sun me-2 text-warning"></i>
                    {% elif ceremony == 'mehendi' %}
                    <i class="fas fa-paint-brush me-2 text-success"></i>
                    {% elif ceremony == 'sangeeth' %}
                    <i class="fas fa-music me-2 text-info"></i>
                    {% elif ceremony == 'wedding' %}
                    <i class="fas fa-heart me-2 text-danger"></i>
                    {% elif ceremony == 'reception' %}
                    <i class="fas fa-glass-cheers me-2 text-primary"></i>
                    {% else %}
                    <i class="fas fa-camera me-2"></i>
                    {% endif %}
                    {{ ceremony.capitalize() }} Ceremony
                </h2>
                <div>
                    <button class="btn btn-sm btn-outline-danger manage-btn" data-ceremony="{{ ceremony }}">
                        <i class="fas fa-cog"></i> Manage
                    </button>
                    <button class="btn btn-sm btn-outline-primary toggle-view-btn" data-ceremony="{{ ceremony }}">
                        <i class="fas fa-chevron-down"></i> Show All
                    </button>
                </div>
            </div>
            
            {% if all_templates[ceremony]|length > 0 %}
                <div class="row" id="{{ ceremony }}-templates">
                    {% for template in all_templates[ceremony] %}
                    <div class="col-md-3 col-sm-6 template-card {% if loop.index > 4 %}hidden-template {{ ceremony }}-hidden{% endif %}">
                        <div class="template-container position-relative" data-path="{{ template.url }}">
                            <img src="{{ template.url }}" 
                                alt="{{ ceremony }} template" class="template-img"
                                onclick="previewTemplate('{{ template.url }}', '{{ template.url }}')">
                            
                            <!-- Selection indicator -->
                            <div class="selected-indicator">
                                <i class="fas fa-check"></i>
                            </div>
                            
                            <!-- Template actions -->
                            <div class="template-actions">
                                <button class="btn btn-sm btn-primary preview-btn" 
                                        onclick="event.stopPropagation(); previewTemplate('{{ template.url }}', '{{ template.url }}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-danger delete-btn" 
                                        onclick="event.stopPropagation(); confirmDelete('{{ template.url }}', '{{ ceremony }}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button class="btn btn-sm btn-success select-btn" 
                                        onclick="event.stopPropagation(); toggleTemplateSelection(this, '{{ template.url }}')">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                {% if all_templates[ceremony]|length > 4 %}
                <div class="text-center mt-3 {% if all_templates[ceremony]|length <= 4 %}d-none{% endif %}">
                    <button class="btn btn-outline-light show-more-btn" data-ceremony="{{ ceremony }}" onclick="toggleTemplates('{{ ceremony }}')">
                        <i class="fas fa-angle-down me-2"></i>Show More ({{ all_templates[ceremony]|length - 4 }} more)
                    </button>
                </div>
                {% endif %}
            {% else %}
                <div class="alert alert-info">
                    No templates available for {{ ceremony }} ceremony.
                    <a href="{{ url_for('bulk_upload_page') }}" class="alert-link">Upload some templates</a>
                </div>
            {% endif %}
            
            <!-- Management tools (hidden by default) -->
            <div class="management-tools mt-3 d-none" id="{{ ceremony }}-management">
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle me-2"></i>Select templates to delete or click the buttons below.
                </div>
                <button class="btn btn-danger delete-selected-btn" data-ceremony="{{ ceremony }}">
                    <i class="fas fa-trash me-2"></i>Delete Selected
                </button>
                <button class="btn btn-warning clear-all-btn" data-ceremony="{{ ceremony }}">
                    <i class="fas fa-times-circle me-2"></i>Clear All Templates
                </button>
                <button class="btn btn-secondary cancel-management-btn" data-ceremony="{{ ceremony }}">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
    
    <!-- Multi-selection bar -->
    <div class="multi-selection-bar" id="multiSelectionBar">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-1">
                    <h5 class="mb-0">Selected: <span id="selectedCount">0/5</span></h5>
                </div>
                <div class="col-md-5">
                    <div id="selectedTemplatesPreview" class="d-flex overflow-auto"></div>
                </div>
                <div class="col-md-4">
                    <div class="input-group">
                        <input type="file" class="form-control" id="sourceImageInput" accept="image/*">
                        <button class="btn btn-primary" id="processSelectedBtn" disabled>
                            <i class="fas fa-magic me-2"></i>Process All
                        </button>
                    </div>
                    <div id="sourceImagePreview" class="mt-2 d-none">
                        <img src="" alt="Source image preview" style="height: 60px;">
                    </div>
                </div>
                <div class="col-md-2 text-end">
                    <button class="btn btn-outline-light" id="clearSelectionBtn">
                        <i class="fas fa-times me-2"></i>Clear All
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Preview Modal -->
    <div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Template Preview</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="previewModalImg" src="" alt="Template Preview" class="img-fluid">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" id="selectInPreviewBtn">
                        <i class="fas fa-check me-2"></i>Select for Face Swap
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle text-warning me-2"></i>Confirm Delete
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="deleteConfirmMessage">Are you sure you want to delete this template?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                        <i class="fas fa-trash me-2"></i>Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading overlay -->
    <div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-none" 
         style="background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center;">
        <div class="text-center text-white">
            <div class="spinner-border mb-3" role="status"></div>
            <h4 id="loadingMessage">Processing templates...</h4>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Global variables
    let selectedTemplates = [];
    let currentDeletePath = null;
    let currentDeleteCeremony = null;
    let bulkDeletePaths = [];
    let sourceFile = null;
    const MAX_SELECTIONS = 5;
    let previewTemplatePath = null;
    
    // DOM elements
    const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    const multiSelectionBar = document.getElementById('multiSelectionBar');
    const selectedCountSpan = document.getElementById('selectedCount');
    const previewModalImg = document.getElementById('previewModalImg');
    const selectedTemplatesPreview = document.getElementById('selectedTemplatesPreview');
    const sourceImageInput = document.getElementById('sourceImageInput');
    const sourceImagePreview = document.getElementById('sourceImagePreview');
    const processSelectedBtn = document.getElementById('processSelectedBtn');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const selectInPreviewBtn = document.getElementById('selectInPreviewBtn');
    const clearSelectionBtn = document.getElementById('clearSelectionBtn');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingMessage = document.getElementById('loadingMessage');
    const checkModelsBtn = document.getElementById('check-models-btn');
    
    // Initialize on document load
    document.addEventListener('DOMContentLoaded', function() {
        initManagementButtons();
        initSelectionHandling();
        checkModelsStatus();
    });
    
    // Preview a template
    function previewTemplate(imageUrl, templatePath) {
        previewTemplatePath = templatePath;
        previewModalImg.src = imageUrl;
        previewModal.show();
    }
    
    // Toggle showing all templates for a ceremony
    function toggleTemplates(ceremony) {
        const hiddenTemplates = document.querySelectorAll(`.${ceremony}-hidden`);
        const button = document.querySelector(`.show-more-btn[data-ceremony="${ceremony}"]`);
        
        if (hiddenTemplates.length === 0) return;
        
        const isShowing = hiddenTemplates[0].style.display === 'block';
        
        hiddenTemplates.forEach(template => {
            template.style.display = isShowing ? 'none' : 'block';
        });
        
        if (button) {
            if (isShowing) {
                button.innerHTML = `<i class="fas fa-angle-down me-2"></i>Show More (${hiddenTemplates.length} more)`;
            } else {
                button.innerHTML = `<i class="fas fa-angle-up me-2"></i>Show Less`;
            }
        }
    }
    
    // Toggle template selection
    function toggleTemplateSelection(button, templatePath) {
        const container = button.closest('.template-container');
        const isSelected = container.classList.contains('selected');
        
        if (isSelected) {
            // Remove from selection
            container.classList.remove('selected');
            selectedTemplates = selectedTemplates.filter(path => path !== templatePath);
        } else {
            // Add to selection if under the limit
            if (selectedTemplates.length >= MAX_SELECTIONS) {
                alert(`You can only select up to ${MAX_SELECTIONS} templates.`);
                return;
            }
            
            container.classList.add('selected');
            selectedTemplates.push(templatePath);
        }
        
        updateSelectionUI();
    }
    
    // Update UI based on selection state
    function updateSelectionUI() {
        // Update count
        selectedCountSpan.textContent = `${selectedTemplates.length}/${MAX_SELECTIONS}`;
        
        // Update preview
        selectedTemplatesPreview.innerHTML = '';
        selectedTemplates.forEach(path => {
            const previewImg = document.createElement('img');
            previewImg.src = path;
            previewImg.alt = 'Selected template';
            previewImg.className = 'selected-preview';
            previewImg.onclick = function() {
                const containers = document.querySelectorAll(`.template-container[data-path="${path}"]`);
                if (containers.length > 0) {
                    containers[0].classList.remove('selected');
                }
                selectedTemplates = selectedTemplates.filter(p => p !== path);
                updateSelectionUI();
            };
            selectedTemplatesPreview.appendChild(previewImg);
        });
        
        // Show/hide the selection bar
        if (selectedTemplates.length > 0) {
            multiSelectionBar.classList.add('active');
        } else {
            multiSelectionBar.classList.remove('active');
        }
        
        // Enable/disable process button
        processSelectedBtn.disabled = selectedTemplates.length === 0 || !sourceFile;
    }
    
    // Confirm template deletion
    function confirmDelete(templatePath, ceremony) {
        currentDeletePath = templatePath;
        currentDeleteCeremony = ceremony;
        document.getElementById('deleteConfirmMessage').textContent = 
            `Are you sure you want to delete this ${ceremony} template?`;
        deleteModal.show();
    }
    
    // Initialize management buttons
    function initManagementButtons() {
        // Manage buttons
        document.querySelectorAll('.manage-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const ceremony = this.getAttribute('data-ceremony');
                const managementTools = document.getElementById(`${ceremony}-management`);
                const isManaging = !managementTools.classList.contains('d-none');
                
                if (isManaging) {
                    // Exit management mode
                    managementTools.classList.add('d-none');
                    this.innerHTML = '<i class="fas fa-cog"></i> Manage';
                    this.classList.remove('btn-danger');
                    this.classList.add('btn-outline-danger');
                    
                    // Uncheck all templates in this ceremony
                    document.querySelectorAll(`#${ceremony}-templates .template-container`).forEach(container => {
                        container.classList.remove('selected');
                    });
                } else {
                    // Enter management mode
                    managementTools.classList.remove('d-none');
                    this.innerHTML = '<i class="fas fa-times"></i> Exit';
                    this.classList.remove('btn-outline-danger');
                    this.classList.add('btn-danger');
                }
            });
        });
        
        // Cancel management buttons
        document.querySelectorAll('.cancel-management-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const ceremony = this.getAttribute('data-ceremony');
                const managementTools = document.getElementById(`${ceremony}-management`);
                const manageBtn = document.querySelector(`.manage-btn[data-ceremony="${ceremony}"]`);
                
                // Exit management mode
                managementTools.classList.add('d-none');
                manageBtn.innerHTML = '<i class="fas fa-cog"></i> Manage';
                manageBtn.classList.remove('btn-danger');
                manageBtn.classList.add('btn-outline-danger');
                
                // Uncheck all templates in this ceremony
                document.querySelectorAll(`#${ceremony}-templates .template-container`).forEach(container => {
                    container.classList.remove('selected');
                });
            });
        });
        
        // Delete selected button
        document.querySelectorAll('.delete-selected-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const ceremony = this.getAttribute('data-ceremony');
                const selectedContainers = document.querySelectorAll(`#${ceremony}-templates .template-container.selected`);
                
                if (selectedContainers.length === 0) {
                    alert('No templates selected for deletion.');
                    return;
                }
                
                bulkDeletePaths = Array.from(selectedContainers).map(container => 
                    container.getAttribute('data-path'));
                currentDeleteCeremony = ceremony;
                
                document.getElementById('deleteConfirmMessage').textContent = 
                    `Are you sure you want to delete ${bulkDeletePaths.length} selected ${ceremony} templates?`;
                deleteModal.show();
            });
        });
        
        // Clear all button
        document.querySelectorAll('.clear-all-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const ceremony = this.getAttribute('data-ceremony');
                currentDeleteCeremony = ceremony;
                bulkDeletePaths = [];
                
                document.getElementById('deleteConfirmMessage').textContent = 
                    `Are you sure you want to delete ALL templates for the ${ceremony} ceremony?`;
                deleteModal.show();
            });
        });
        
        // Toggle view buttons
        document.querySelectorAll('.toggle-view-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const ceremony = this.getAttribute('data-ceremony');
                toggleTemplates(ceremony);
                
                // Update button text
                const hiddenTemplates = document.querySelectorAll(`.${ceremony}-hidden`);
                if (hiddenTemplates.length === 0) return;
                
                const isShowing = hiddenTemplates[0].style.display === 'block';
                if (isShowing) {
                    this.innerHTML = '<i class="fas fa-chevron-up"></i> Show Less';
                } else {
                    this.innerHTML = '<i class="fas fa-chevron-down"></i> Show All';
                }
            });
        });
    }
    
    // Initialize selection handling
    function initSelectionHandling() {
        // Source image input
        sourceImageInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                sourceFile = this.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    sourceImagePreview.classList.remove('d-none');
                    sourceImagePreview.querySelector('img').src = e.target.result;
                };
                
                reader.readAsDataURL(this.files[0]);
                
                // Enable/disable process button
                processSelectedBtn.disabled = selectedTemplates.length === 0;
            }
        });
        
        // Process selected button
        processSelectedBtn.addEventListener('click', function() {
            if (selectedTemplates.length === 0) {
                alert('Please select at least one template');
                return;
            }
            
            if (!sourceFile) {
                alert('Please upload a source image');
                return;
            }
            
            // Show loading overlay
            loadingOverlay.classList.remove('d-none');
            loadingMessage.textContent = 'Processing templates... This may take a minute.';
            
            // Create form data
            const formData = new FormData();
            formData.append('source', sourceFile);
            selectedTemplates.forEach(path => {
                formData.append('templates[]', path);
            });
            
            // Submit the form
            fetch('/multi_face_swap', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                loadingOverlay.classList.add('d-none');
                
                if (data.success) {
                    window.location.href = '/bridal_results';
                } else {
                    alert(data.error || 'Failed to process templates');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                loadingOverlay.classList.add('d-none');
                alert('An error occurred during processing');
            });
        });
        
        // Clear selection button
        clearSelectionBtn.addEventListener('click', function() {
            selectedTemplates = [];
            document.querySelectorAll('.template-container.selected').forEach(container => {
                container.classList.remove('selected');
            });
            updateSelectionUI();
        });
        
        // Select from preview
        selectInPreviewBtn.addEventListener('click', function() {
            if (previewTemplatePath) {
                const containers = document.querySelectorAll(`.template-container[data-path="${previewTemplatePath}"]`);
                if (containers.length > 0) {
                    toggleTemplateSelection(containers[0].querySelector('.select-btn'), previewTemplatePath);
                }
                previewModal.hide();
            }
        });
        
        // Confirm delete button
        confirmDeleteBtn.addEventListener('click', function() {
            if (currentDeletePath) {
                // Delete single template
                deleteTemplates([currentDeletePath]);
                currentDeletePath = null;
            } else if (currentDeleteCeremony) {
                if (bulkDeletePaths.length > 0) {
                    // Delete multiple templates
                    deleteTemplates(bulkDeletePaths);
                } else {
                    // Clear all templates for ceremony
                    clearAllTemplates(currentDeleteCeremony);
                }
                currentDeleteCeremony = null;
                bulkDeletePaths = [];
            }
            
            deleteModal.hide();
        });
    }
    
    // Delete templates
    function deleteTemplates(templatePaths) {
        loadingOverlay.classList.remove('d-none');
        loadingMessage.textContent = 'Deleting templates...';
        
        fetch('/delete-templates', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ template_paths: templatePaths }),
        })
        .then(response => response.json())
        .then(data => {
            loadingOverlay.classList.add('d-none');
            
            if (data.success) {
                // Remove from DOM
                templatePaths.forEach(path => {
                    const containers = document.querySelectorAll(`.template-container[data-path="${path}"]`);
                    containers.forEach(container => {
                        const card = container.closest('.template-card');
                        if (card) card.remove();
                    });
                    
                    // Remove from selected templates if needed
                    selectedTemplates = selectedTemplates.filter(p => p !== path);
                });
                
                updateSelectionUI();
                
                // Reload the page to ensure everything is in sync
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            } else {
                alert(data.error || 'Failed to delete template(s)');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            loadingOverlay.classList.add('d-none');
            alert('An error occurred during deletion');
        });
    }
    
    // Clear all templates for a ceremony
    function clearAllTemplates(ceremony) {
        loadingOverlay.classList.remove('d-none');
        loadingMessage.textContent = `Clearing all ${ceremony} templates...`;
        
        fetch('/delete-templates', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                ceremony_type: ceremony,
                clear_all: true
            }),
        })
        .then(response => response.json())
        .then(data => {
            loadingOverlay.classList.add('d-none');
            
            if (data.success) {
                // Remove all templates for this ceremony from the DOM
                const ceremonyContainer = document.getElementById(`${ceremony}-templates`);
                if (ceremonyContainer) {
                    ceremonyContainer.innerHTML = '';
                    
                    // Add "no templates" message
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-info col-12';
                    alertDiv.innerHTML = `No templates available for ${ceremony} ceremony. <a href="/bulk-upload" class="alert-link">Upload some templates</a>`;
                    ceremonyContainer.appendChild(alertDiv);
                }
                
                // Remove from selected templates if needed
                selectedTemplates = selectedTemplates.filter(path => {
                    const containers = document.querySelectorAll(`.template-container[data-path="${path}"]`);
                    if (containers.length === 0) return true; // Keep if not in DOM
                    
                    // Check if any container is in this ceremony
                    for (const container of containers) {
                        const card = container.closest('.template-card');
                        if (card && ceremonyContainer.contains(card)) {
                            return false; // Remove if in this ceremony
                        }
                    }
                    
                    return true; // Keep if not in this ceremony
                });
                
                updateSelectionUI();
                
                // Hide management tools
                const managementTools = document.getElementById(`${ceremony}-management`);
                if (managementTools) {
                    managementTools.classList.add('d-none');
                }
                
                // Reset manage button
                const manageBtn = document.querySelector(`.manage-btn[data-ceremony="${ceremony}"]`);
                if (manageBtn) {
                    manageBtn.innerHTML = '<i class="fas fa-cog"></i> Manage';
                    manageBtn.classList.remove('btn-danger');
                    manageBtn.classList.add('btn-outline-danger');
                }
                
                // Hide show more button
                const showMoreBtn = document.querySelector(`.show-more-btn[data-ceremony="${ceremony}"]`);
                if (showMoreBtn) {
                    showMoreBtn.parentElement.classList.add('d-none');
                }
            } else {
                alert(data.error || 'Failed to clear templates');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            loadingOverlay.classList.add('d-none');
            alert('An error occurred during deletion');
        });
    }
    
    // Check models status
    function checkModelsStatus() {
        fetch('/check-models')
            .then(response => response.json())
            .then(data => {
                if (data.face_detection && data.face_swap) {
                    document.getElementById('model-status-container').classList.add('d-none');
                }
            })
            .catch(error => {
                console.error('Error checking model status:', error);
            });
        
        // Add event listener to check button
        checkModelsBtn.addEventListener('click', function() {
            fetch('/check-models')
                .then(response => response.json())
                .then(data => {
                    if (data.face_detection && data.face_swap) {
                        document.getElementById('model-status-container').classList.add('d-none');
                        alert('Models loaded successfully!');
                    } else {
                        alert('Models are still loading. Please wait a moment and try again.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to check model status');
                });
        });
    }
</script>
{% endblock %}