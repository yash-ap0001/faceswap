{% extends "base.html" %}

{% block title %}Download Enhancement Models{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card bg-dark text-white">
                <div class="card-header bg-purple">
                    <h5 class="mb-0">Download Enhancement Models</h5>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <p>This page allows you to download advanced image enhancement models for better face swap results.</p>
                        <p>The following models will be downloaded:</p>
                        <ul>
                            <li><strong>GPEN</strong> - Face reconstruction models (256px and 512px versions)</li>
                            <li><strong>GFPGAN</strong> - Face restoration model</li>
                            <li><strong>CodeFormer</strong> - Face enhancement model</li>
                            <li><strong>ESRGAN</strong> - General image upscaling model</li>
                        </ul>
                        <p><small class="text-muted">Note: These models require around 2GB of disk space in total.</small></p>
                    </div>
                    
                    <div class="model-status mb-4">
                        <h6>Current Enhancement Model Status:</h6>
                        <div id="status-container" class="mb-3">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span class="ms-2">Checking model status...</span>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button id="download-btn" class="btn btn-primary" onclick="downloadModels()">
                            <i class="fas fa-download me-2"></i>Download Enhancement Models
                        </button>
                    </div>
                    
                    <div id="download-progress" class="mt-4 d-none">
                        <div class="alert alert-info">
                            <div class="d-flex align-items-center">
                                <div class="spinner-border spinner-border-sm me-2" role="status">
                                    <span class="visually-hidden">Downloading...</span>
                                </div>
                                <span>Downloading enhancement models... This may take several minutes.</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="download-result" class="mt-4 d-none">
                        <!-- Success or error message will appear here -->
                    </div>
                    
                    <div id="download-log" class="mt-4 d-none">
                        <h6>Download Log:</h6>
                        <pre class="bg-dark text-light p-3 rounded" style="max-height: 200px; overflow-y: auto;"><code id="log-content"></code></pre>
                    </div>
                </div>
                <div class="card-footer">
                    <a href="/" class="btn btn-outline-light">
                        <i class="fas fa-arrow-left me-2"></i>Back to Home
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Check model status on page load
    document.addEventListener('DOMContentLoaded', function() {
        checkModelStatus();
    });
    
    // Check which enhancement models are available
    async function checkModelStatus() {
        try {
            const response = await fetch('/check-models');
            if (!response.ok) throw new Error('Failed to check model status');
            
            const data = await response.json();
            const statusContainer = document.getElementById('status-container');
            
            if (data.enhancement_models) {
                let statusHtml = '<ul class="list-group">';
                
                for (const [modelName, isAvailable] of Object.entries(data.enhancement_models)) {
                    const statusClass = isAvailable ? 'text-success' : 'text-danger';
                    const statusIcon = isAvailable ? 'fas fa-check-circle' : 'fas fa-times-circle';
                    const statusText = isAvailable ? 'Available' : 'Not Downloaded';
                    
                    statusHtml += `
                        <li class="list-group-item bg-dark text-white border-secondary">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>${formatModelName(modelName)}</span>
                                <span class="${statusClass}">
                                    <i class="${statusIcon} me-1"></i>${statusText}
                                </span>
                            </div>
                        </li>
                    `;
                }
                
                statusHtml += '</ul>';
                statusContainer.innerHTML = statusHtml;
                
                // Check if all models are already available
                const allAvailable = Object.values(data.enhancement_models).every(status => status);
                if (allAvailable) {
                    document.getElementById('download-btn').disabled = true;
                    document.getElementById('download-btn').innerHTML = '<i class="fas fa-check me-2"></i>All Models Downloaded';
                }
            } else {
                statusContainer.innerHTML = '<div class="alert alert-warning">Unable to check model status</div>';
            }
        } catch (error) {
            console.error('Error checking model status:', error);
            document.getElementById('status-container').innerHTML = 
                `<div class="alert alert-danger">Error checking model status: ${error.message}</div>`;
        }
    }
    
    // Format model name for display
    function formatModelName(modelName) {
        switch(modelName) {
            case 'gpen_256': return 'GPEN Face Enhancement (256px)';
            case 'gpen_512': return 'GPEN Face Enhancement (512px)';
            case 'gfpgan': return 'GFPGAN Face Restoration';
            case 'codeformer': return 'CodeFormer Face Enhancement';
            case 'esrgan': return 'ESRGAN Image Upscaling';
            default: return modelName;
        }
    }
    
    // Download enhancement models
    async function downloadModels() {
        try {
            // Show progress
            document.getElementById('download-btn').disabled = true;
            document.getElementById('download-progress').classList.remove('d-none');
            document.getElementById('download-result').classList.add('d-none');
            document.getElementById('download-log').classList.add('d-none');
            
            const response = await fetch('/download-enhancement-models', {
                method: 'POST'
            });
            
            const data = await response.json();
            document.getElementById('download-progress').classList.add('d-none');
            document.getElementById('download-result').classList.remove('d-none');
            
            if (data.success) {
                document.getElementById('download-result').innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>${data.message}
                    </div>
                `;
                
                // Show available models
                if (data.available_models && data.available_models.length > 0) {
                    let modelsList = '<div class="mt-3"><h6>Downloaded Models:</h6><ul>';
                    data.available_models.forEach(model => {
                        modelsList += `<li>${formatModelName(model)}</li>`;
                    });
                    modelsList += '</ul></div>';
                    document.getElementById('download-result').innerHTML += modelsList;
                }
                
                // Update download button
                document.getElementById('download-btn').innerHTML = '<i class="fas fa-check me-2"></i>Models Downloaded';
                
                // Show log if available
                if (data.log) {
                    document.getElementById('download-log').classList.remove('d-none');
                    document.getElementById('log-content').textContent = data.log;
                }
                
                // Refresh model status
                setTimeout(checkModelStatus, 1000);
                
            } else {
                document.getElementById('download-result').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>${data.message}
                    </div>
                `;
                document.getElementById('download-btn').disabled = false;
                
                // Show log if available
                if (data.log) {
                    document.getElementById('download-log').classList.remove('d-none');
                    document.getElementById('log-content').textContent = data.log;
                }
            }
        } catch (error) {
            console.error('Error downloading models:', error);
            document.getElementById('download-progress').classList.add('d-none');
            document.getElementById('download-result').classList.remove('d-none');
            document.getElementById('download-result').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>Error downloading models: ${error.message}
                </div>
            `;
            document.getElementById('download-btn').disabled = false;
        }
    }
</script>
{% endblock %}