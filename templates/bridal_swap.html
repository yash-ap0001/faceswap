{% extends "base.html" %}

{% block head %}
{{ super() }}
<style>
    .template-card {
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        border: 2px solid transparent;
    }
    
    .template-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    
    .tab-content {
        min-height: 300px;
    }
    
    .template-checkbox-wrapper {
        z-index: 5;
        display: none;
    }
    
    .template-checkbox {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }
    
    .template-card.selected {
        border: 2px solid #8e44ad !important;
    }
    
    /* Selected template styling */
    .template-card.selected-template {
        border: 3px solid #9c27b0 !important;
        box-shadow: 0 0 15px rgba(156, 39, 176, 0.6);
    }
    
    .selected-glow {
        filter: drop-shadow(0 0 5px rgba(156, 39, 176, 0.8));
    }
    
    #template-preview-container {
        transition: all 0.3s ease;
    }
    
    /* Template selection mode styles */
    .template-checkbox-wrapper {
        display: none;
        z-index: 10;
    }
    
    body.template-selection-mode .template-checkbox-wrapper {
        display: block;
    }
    
    .template-card.selected {
        border: 3px solid #8e44ad !important;
        box-shadow: 0 0 10px rgba(142, 68, 173, 0.6);
    }
    
    /* Multi-results display */
    .multi-results-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
    }
    
    .multi-result-card {
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .multi-result-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    }
    
    .multi-result-img {
        width: 100%;
        height: 350px;
        object-fit: cover;
    }
    
    .multi-result-footer {
        padding: 10px;
        background-color: rgba(0, 0, 0, 0.7);
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-dark">
                <h1 class="h3 mb-0 text-center">
                    <i class="fas fa-user-bride me-2"></i>Indian Bridal Face Swap
                </h1>
            </div>
            <div class="card-body">
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    Upload your photo to see yourself in traditional Indian bridal attire for different ceremonies.
                </div>
                
                <div id="model-status-alert" class="alert alert-warning d-none" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="model-status-message">Checking model status...</span>
                </div>

                <form id="upload-form" enctype="multipart/form-data">
                    <div class="row mb-4">
                        <div class="col-md-6 mb-3 mb-md-0">
                            <div class="card h-100">
                                <div class="card-header bg-dark">
                                    <h5 class="mb-0">Your Photo</h5>
                                </div>
                                <div class="card-body d-flex flex-column">
                                    <p class="text-muted small">Upload a clear photo of your face looking directly at the camera</p>
                                    <div class="image-preview-container mb-3 flex-grow-1 d-flex align-items-center justify-content-center">
                                        <img id="source-preview" class="img-preview d-none" alt="Your photo preview">
                                        <div id="source-placeholder" class="placeholder-container">
                                            <i class="fas fa-user fa-4x text-muted"></i>
                                            <p class="text-muted mt-2">Your photo will appear here</p>
                                        </div>
                                    </div>
                                    <div class="input-group">
                                        <input type="file" class="form-control" id="source-input" name="source" accept=".jpg,.jpeg,.png" required>
                                        <button class="btn btn-outline-secondary" type="button" id="source-clear-btn">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-dark">
                                    <h5 class="mb-0">Choose Bridal Style</h5>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted small">Select a traditional Indian bridal style</p>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Event Type</label>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="bridalStyle" id="haldi" value="haldi" checked>
                                            <label class="form-check-label" for="haldi">
                                                <strong>Haldi Ceremony</strong> - Yellow saree with marigold decorations
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="bridalStyle" id="mehendi" value="mehendi">
                                            <label class="form-check-label" for="mehendi">
                                                <strong>Mehendi Function</strong> - Green lehenga with henna designs
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="bridalStyle" id="wedding" value="wedding">
                                            <label class="form-check-label" for="wedding">
                                                <strong>Wedding Ceremony</strong> - Traditional red bridal lehenga
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="radio" name="bridalStyle" id="reception" value="reception">
                                            <label class="form-check-label" for="reception">
                                                <strong>Reception</strong> - Stylish maroon designer gown/lehenga
                                            </label>
                                        </div>
                                    </div>

                                    <!-- We're now getting Pinterest images directly based on ceremony, so no template type selection needed -->
                                    <div class="mb-3">
                                        <p class="text-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            All templates are curated from Pinterest based on the selected ceremony type.
                                        </p>
                                    </div>
                                    
                                    <!-- Template preview container -->
                                    <div id="template-preview-container" class="mt-3 d-none">
                                        <div class="card bg-dark">
                                            <div class="card-header py-1">
                                                <h6 class="mb-0 small">Selected Template</h6>
                                            </div>
                                            <div class="card-body p-2 text-center">
                                                <img id="template-preview" class="img-fluid" style="max-height: 150px;" alt="Selected template">
                                                <input type="hidden" id="template-url" name="template_url">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center">
                        <button type="submit" id="swap-btn" class="btn btn-primary">
                            <i class="fas fa-magic me-2"></i>Create Bridal Look
                        </button>
                    </div>
                </form>

                <!-- Single Template Result -->
                <div id="result-container" class="mt-4 d-none">
                    <h4 class="text-center mb-3">Your Bridal Look</h4>
                    <div class="text-center mb-3">
                        <img id="result-image" class="img-fluid result-image" alt="Bridal face swap result">
                    </div>
                    <div class="text-center">
                        <a id="download-btn" class="btn btn-success me-2" download>
                            <i class="fas fa-download me-2"></i>Download
                        </a>
                        <button id="try-again-btn" class="btn btn-secondary">
                            <i class="fas fa-redo me-2"></i>Try Another Style
                        </button>
                    </div>
                </div>
                
                <!-- Multi-Template Results -->
                <div id="multi-results-container" class="mt-4 d-none">
                    <h4 class="text-center mb-3">Your Multiple Bridal Looks</h4>
                    <div class="multi-results-container"></div>
                    <div class="text-center mt-4">
                        <button id="multi-try-again-btn" class="btn btn-secondary">
                            <i class="fas fa-redo me-2"></i>Try Different Templates
                        </button>
                    </div>
                </div>

                <div id="loading-container" class="text-center my-4 d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Creating your bridal look... Please wait.</p>
                </div>

                <div id="error-container" class="alert alert-danger mt-4 d-none" role="alert">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <span id="error-message"></span>
                </div>
            </div>
        </div>

        <!-- Available Templates Section -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-dark d-flex justify-content-between align-items-center">
                <h2 class="h4 mb-0">Available Templates</h2>
                <div class="btn-group">
                    <button id="toggleSelectionModeBtn" class="btn btn-outline-light btn-sm me-2">
                        <i class="fas fa-check-square"></i> Multi-Select
                    </button>
                    <button id="processSelectedBtn" class="btn btn-primary btn-sm me-2 d-none">
                        <i class="fas fa-magic"></i> Process Selected (<span id="selectedCount">0</span>)
                    </button>
                    <button id="refreshTemplatesBtn" class="btn btn-outline-light btn-sm">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="templateTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="haldi-tab" data-bs-toggle="tab" data-bs-target="#haldi-templates" type="button" role="tab">Haldi</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="mehendi-tab" data-bs-toggle="tab" data-bs-target="#mehendi-templates" type="button" role="tab">Mehendi</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="wedding-tab" data-bs-toggle="tab" data-bs-target="#wedding-templates" type="button" role="tab">Wedding</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="reception-tab" data-bs-toggle="tab" data-bs-target="#reception-templates" type="button" role="tab">Reception</button>
                    </li>
                </ul>
                
                <!-- Multi-selection controls -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <button id="toggleSelectionModeBtn" type="button" class="btn btn-outline-light btn-sm">
                        <i class="fas fa-check-square"></i> Multi-Select
                    </button>
                    <div id="selectionCountWrapper" class="d-none">
                        <span class="badge bg-primary rounded-pill me-2">
                            <span id="selectedCount">0</span> selected
                        </span>
                    </div>
                    <button id="processSelectedBtn" type="button" class="btn btn-success btn-sm d-none" disabled>
                        <i class="fas fa-magic me-1"></i> Process Selected Templates
                    </button>
                </div>
                
                <div class="tab-content pt-4" id="templateTabContent">
                    <div class="tab-pane fade show active" id="haldi-templates" role="tabpanel">
                        <div class="template-container row g-3">
                            <div class="col-12 text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="mehendi-templates" role="tabpanel">
                        <div class="template-container row g-3">
                            <div class="col-12 text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="wedding-templates" role="tabpanel">
                        <div class="template-container row g-3">
                            <div class="col-12 text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="reception-templates" role="tabpanel">
                        <div class="template-container row g-3">
                            <div class="col-12 text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing bridal swap page');
    
    // DOM Elements
    const uploadForm = document.getElementById('upload-form');
    const sourceInput = document.getElementById('source-input');
    const sourcePreview = document.getElementById('source-preview');
    const sourcePlaceholder = document.getElementById('source-placeholder');
    const sourceClearBtn = document.getElementById('source-clear-btn');
    const swapBtn = document.getElementById('swap-btn');
    const resultContainer = document.getElementById('result-container');
    const resultImage = document.getElementById('result-image');
    const downloadBtn = document.getElementById('download-btn');
    const tryAgainBtn = document.getElementById('try-again-btn');
    const loadingContainer = document.getElementById('loading-container');
    const errorContainer = document.getElementById('error-container');
    const errorMessage = document.getElementById('error-message');
    const modelStatusAlert = document.getElementById('model-status-alert');
    const modelStatusMessage = document.getElementById('model-status-message');
    const templatePreviewContainer = document.getElementById('template-preview-container');
    const templatePreview = document.getElementById('template-preview');
    const templateUrlInput = document.getElementById('template-url');
    
    // Function to use a template (called when a template is selected)
    function useTemplate(templateCard) {
        if (!templateCard) {
            console.error('No template card provided');
            return;
        }
        
        console.log('Using template:', templateCard.dataset);
        
        // Extract template info
        const templatePath = templateCard.dataset.templatePath;
        const ceremonyType = templateCard.dataset.ceremony;
        
        if (!templatePath) {
            console.error('Template path is missing');
            return;
        }
        
        // Apply visual selection to this template
        document.querySelectorAll('.template-card').forEach(card => {
            card.classList.remove('selected-template');
        });
        templateCard.classList.add('selected-template');
        
        // Show a subtle highlight on the selected template
        const templateImg = templateCard.querySelector('img');
        if (templateImg) {
            document.querySelectorAll('.template-img').forEach(img => {
                img.classList.remove('selected-glow');
            });
            templateImg.classList.add('selected-glow');
        }
        
        // Visual feedback in the upload form
        if (templatePreviewContainer) {
            templatePreviewContainer.classList.remove('d-none');
            if (templatePreview) {
                templatePreview.src = templatePath;
                templatePreview.alt = `Selected ${ceremonyType} template`;
                
                // Add ceremony type as a data attribute
                templatePreview.dataset.ceremony = ceremonyType;
            }
        }
        
        // Update hidden form field
        if (templateUrlInput) {
            templateUrlInput.value = templatePath;
        }
        
        // Enable the swap button if both source and template are selected
        if (sourceInput && sourceInput.files.length > 0) {
            if (swapBtn) {
                swapBtn.disabled = false;
            }
        }
    }
    
    // Initialize template features
    const refreshTemplatesBtn = document.getElementById('refreshTemplatesBtn');
    if (refreshTemplatesBtn) {
        console.log('Adding click listener to refresh templates button');
        refreshTemplatesBtn.addEventListener('click', loadAllTemplates);
    }
    
    // Set up bridal style radio buttons
    document.querySelectorAll('input[name="bridalStyle"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const selectedStyle = this.value;
            // Show the corresponding tab
            const tab = document.getElementById(`${selectedStyle}-tab`);
            if (tab) {
                console.log(`Showing tab for ${selectedStyle}`);
                new bootstrap.Tab(tab).show();
            }
        });
    });
    
    // Function to initialize the page
    function initializePage() {
        console.log('Initializing bridal swap page components');
        
        // Set up ceremony tab navigation
        setupCeremonyTabs();
        
        // Load templates for all ceremonies
        loadAllTemplates();
        
        // Check for model status
        checkModels();
        
        console.log('Page initialization complete');
    }
    
    // Initialize the page by setting up everything
    initializePage();
    
    // Setup ceremony tabs with event listeners
    function setupCeremonyTabs() {
        const tabs = document.querySelectorAll('.nav-link[data-bs-toggle="tab"]');
        console.log('Setting up', tabs.length, 'ceremony tabs');
        
        tabs.forEach(tab => {
            // Extract ceremony type from tab href
            const href = tab.getAttribute('data-bs-target');
            const ceremonyType = href ? href.replace('#', '').replace('-templates', '') : null;
            
            if (ceremonyType) {
                console.log(`Setting up tab for ${ceremonyType} ceremony`);
                
                // Add click handler to ensure templates are loaded when tab is clicked
                tab.addEventListener('click', function() {
                    console.log(`${ceremonyType} tab clicked`);
                    // Force reload templates for this ceremony
                    loadTemplates(ceremonyType);
                });
            }
        });
    }
    
    // File input change handlers
    sourceInput.addEventListener('change', function() {
        handleFileInputChange(this, sourcePreview, sourcePlaceholder);
    });

    // Clear button handlers
    sourceClearBtn.addEventListener('click', function() {
        clearFileInput(sourceInput, sourcePreview, sourcePlaceholder);
    });

    // Try again button handler
    tryAgainBtn.addEventListener('click', function() {
        resultContainer.classList.add('d-none');
        errorContainer.classList.add('d-none');
    });

    // Form submission
    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!sourceInput.files.length) {
            showError('Please select your photo.');
            return;
        }
        
        if (!templateUrlInput.value) {
            showError('Please select a template from the available templates section.');
            return;
        }

        // Get selected bridal style
        const selectedStyle = document.querySelector('input[name="bridalStyle"]:checked').value;

        // Check file sizes
        const maxSize = 16 * 1024 * 1024; // 16MB
        if (sourceInput.files[0].size > maxSize) {
            showError('File size exceeds the maximum limit of 16MB.');
            return;
        }

        // Check file types
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png'];
        if (!allowedTypes.includes(sourceInput.files[0].type)) {
            showError('Only JPG, JPEG and PNG files are allowed.');
            return;
        }

        // Show loading
        loadingContainer.classList.remove('d-none');
        errorContainer.classList.add('d-none');
        resultContainer.classList.add('d-none');
        swapBtn.disabled = true;

        // Create form data
        const formData = new FormData();
        formData.append('source', sourceInput.files[0]);
        formData.append('style', selectedStyle);
        formData.append('template_url', templateUrlInput.value);

        // Send AJAX request
        fetch('/bridal-swap', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            loadingContainer.classList.add('d-none');
            swapBtn.disabled = false;

            if (data.success) {
                resultImage.src = `/uploads/${data.result_image}`;
                downloadBtn.href = `/uploads/${data.result_image}`;
                downloadBtn.download = data.result_image;
                resultContainer.classList.remove('d-none');
                window.scrollTo({
                    top: resultContainer.offsetTop,
                    behavior: 'smooth'
                });
            } else {
                showError(data.error || 'An unknown error occurred.');
            }
        })
        .catch(error => {
            loadingContainer.classList.add('d-none');
            swapBtn.disabled = false;
            showError('Network error: ' + error.message);
        });
    });

    // Helper functions
    function handleFileInputChange(input, preview, placeholder) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.classList.remove('d-none');
                placeholder.classList.add('d-none');
            };
            
            reader.readAsDataURL(input.files[0]);
        }
    }

    function clearFileInput(input, preview, placeholder) {
        input.value = '';
        preview.classList.add('d-none');
        placeholder.classList.remove('d-none');
    }

    function showError(message) {
        errorMessage.textContent = message;
        errorContainer.classList.remove('d-none');
        window.scrollTo({
            top: errorContainer.offsetTop,
            behavior: 'smooth'
        });
    }
    
    // Multi-template selection functionality
    const toggleSelectionModeBtn = document.getElementById('toggleSelectionModeBtn');
    const processSelectedBtn = document.getElementById('processSelectedBtn');
    const selectedCount = document.getElementById('selectedCount');
    let isSelectionMode = false;
    
    if (toggleSelectionModeBtn) {
        toggleSelectionModeBtn.addEventListener('click', function() {
            isSelectionMode = !isSelectionMode;
            document.body.classList.toggle('template-selection-mode', isSelectionMode);
            
            const selectionCountWrapper = document.getElementById('selectionCountWrapper');
            
            if (isSelectionMode) {
                toggleSelectionModeBtn.innerHTML = '<i class="fas fa-times"></i> Cancel Selection';
                toggleSelectionModeBtn.classList.remove('btn-outline-light');
                toggleSelectionModeBtn.classList.add('btn-outline-danger');
                processSelectedBtn.classList.remove('d-none');
                if (selectionCountWrapper) selectionCountWrapper.classList.remove('d-none');
                
                // Clear any existing selections when entering selection mode
                document.querySelectorAll('.template-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                });
                document.querySelectorAll('.template-card').forEach(card => {
                    card.classList.remove('selected');
                });
                updateSelectedCount();
            } else {
                toggleSelectionModeBtn.innerHTML = '<i class="fas fa-check-square"></i> Multi-Select';
                toggleSelectionModeBtn.classList.add('btn-outline-light');
                toggleSelectionModeBtn.classList.remove('btn-outline-danger');
                processSelectedBtn.classList.add('d-none');
                if (selectionCountWrapper) selectionCountWrapper.classList.add('d-none');
            }
        });
    }
    
    // Function to update selected count
    function updateSelectedCount() {
        const count = document.querySelectorAll('.template-checkbox:checked').length;
        if (selectedCount) {
            selectedCount.textContent = count;
        }
        
        // Enable/disable the process button based on selection count
        if (processSelectedBtn) {
            if (count > 0 && count <= 5) {
                processSelectedBtn.disabled = false;
            } else {
                processSelectedBtn.disabled = (count === 0 || count > 5);
            }
            
            if (count > 5) {
                processSelectedBtn.title = 'Please select a maximum of 5 templates';
            } else {
                processSelectedBtn.title = '';
            }
        }
    }
    
    // Add event listener to all checkboxes (for future checkboxes as well)
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('template-checkbox')) {
            const card = e.target.closest('.template-card');
            if (card) {
                card.classList.toggle('selected', e.target.checked);
                updateSelectedCount();
            }
        }
    });
    
    // Add event listener to the process selected button
    if (processSelectedBtn) {
        processSelectedBtn.addEventListener('click', function() {
            processSelectedTemplates();
        });
    }
    
    // Function to process selected templates
    function processSelectedTemplates() {
        // Check if source image is selected
        if (!sourceInput.files.length) {
            showError('Please upload your photo first.');
            return;
        }
        
        const selectedTemplates = Array.from(document.querySelectorAll('.template-card.selected')).map(card => ({
            path: card.dataset.templatePath,
            ceremony: card.dataset.ceremony,
            url: card.dataset.templateUrl,
        }));
        
        if (selectedTemplates.length === 0) {
            showError('Please select at least one template.');
            return;
        }
        
        if (selectedTemplates.length > 5) {
            showError('Please select a maximum of 5 templates.');
            return;
        }
        
        // Show loading state
        loadingContainer.classList.remove('d-none');
        resultContainer.classList.add('d-none');
        document.getElementById('multi-results-container').classList.add('d-none');
        errorContainer.classList.add('d-none');
        
        // Create form data with source image and selected templates
        const formData = new FormData();
        formData.append('source', sourceInput.files[0]);
        
        // Add all selected template paths
        selectedTemplates.forEach((template, index) => {
            formData.append(`template_${index}`, template.path);
            formData.append(`ceremony_${index}`, template.ceremony);
        });
        
        formData.append('template_count', selectedTemplates.length);
        
        // Send AJAX request
        fetch('/bridal-swap-multi', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            loadingContainer.classList.add('d-none');
            
            if (data.success) {
                // Display all results
                displayMultiResults(data.results, selectedTemplates);
            } else {
                showError(data.error || 'An unknown error occurred.');
            }
        })
        .catch(error => {
            loadingContainer.classList.add('d-none');
            showError('Network error: ' + error.message);
        });
    }
    
    // Function to display multiple results
    function displayMultiResults(results, selectedTemplates) {
        const multiResultsContainer = document.getElementById('multi-results-container');
        const multiResultsGrid = multiResultsContainer.querySelector('.multi-results-container');
        
        if (!multiResultsContainer || !multiResultsGrid) {
            console.error('Multi-results container not found');
            return;
        }
        
        // Clear previous results
        multiResultsGrid.innerHTML = '';
        
        // Create a card for each result
        results.forEach((result, index) => {
            const template = selectedTemplates[index];
            
            const resultCard = document.createElement('div');
            resultCard.className = 'multi-result-card';
            resultCard.innerHTML = `
                <div class="position-relative">
                    <img src="${result.result_path}" class="multi-result-img" alt="Result for ${template.ceremony}">
                    <div class="multi-result-footer">
                        <h5 class="mb-1">${template.ceremony.charAt(0).toUpperCase() + template.ceremony.slice(1)} Ceremony</h5>
                        <a href="${result.result_path}" class="btn btn-sm btn-success" download>
                            <i class="fas fa-download"></i> Download
                        </a>
                    </div>
                </div>
            `;
            
            multiResultsGrid.appendChild(resultCard);
        });
        
        // Show the results container
        multiResultsContainer.classList.remove('d-none');
        
        // Scroll to results
        window.scrollTo({
            top: multiResultsContainer.offsetTop,
            behavior: 'smooth'
        });
        
        // Add event listener to try again button
        const multiTryAgainBtn = document.getElementById('multi-try-again-btn');
        if (multiTryAgainBtn) {
            multiTryAgainBtn.addEventListener('click', function() {
                // Reset selection mode and clear results
                if (toggleSelectionModeBtn) {
                    toggleSelectionModeBtn.click(); // This will turn off selection mode
                }
                multiResultsContainer.classList.add('d-none');
            });
        }
    }

    function checkModels() {
        fetch('/check-models')
            .then(response => response.json())
            .then(data => {
                if (!data.face_detection || !data.face_swap) {
                    modelStatusAlert.classList.remove('d-none');
                    modelStatusMessage.textContent = 'Some models are not loaded properly. The application may not work correctly.';
                    
                    if (!data.face_detection) {
                        modelStatusMessage.textContent = 'Face detection model is not loaded. Please check server logs.';
                    } else if (!data.face_swap) {
                        modelStatusMessage.textContent = 'Face swap model is not loaded. Please check server logs.';
                    }
                } else {
                    modelStatusAlert.classList.add('d-none');
                }
            })
            .catch(error => {
                modelStatusAlert.classList.remove('d-none');
                modelStatusMessage.textContent = 'Could not check model status. There might be connection issues.';
            });
    }
    
    // Load all ceremony type templates
    function loadAllTemplates() {
        console.log('loadAllTemplates called');
        const ceremonyTypes = ['haldi', 'mehendi', 'wedding', 'reception'];
        console.log('Loading templates for ceremony types:', ceremonyTypes);
        ceremonyTypes.forEach(type => loadTemplates(type));
    }
    
    // Function to load templates for a specific ceremony type
    function loadTemplates(ceremonyType) {
        console.log(`Loading templates for ${ceremonyType}`);
        const templateContainer = document.querySelector(`#${ceremonyType}-templates .template-container`);
        
        if (!templateContainer) {
            console.error(`Template container for ${ceremonyType} not found`);
            return;
        }
        
        // Display loading state
        templateContainer.innerHTML = '<div class="col-12 text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Loading templates...</p></div>';
        
        // Add a timestamp to prevent caching
        const timestamp = Date.now();
        const apiUrl = `/api/templates?ceremony_type=${ceremonyType}&_t=${timestamp}`;
        console.log(`Fetching templates from: ${apiUrl}`);
        
        // Fetch templates for this ceremony type
        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Failed to fetch templates: ${response.status} ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(`Received template data for ${ceremonyType}:`, data);
                
                // Clear loading state
                templateContainer.innerHTML = '';
                
                // Ensure data has the expected format
                if (!data || !data.templates || data.templates.length === 0) {
                    // Display no templates message
                    templateContainer.innerHTML = `
                        <div class="col-12 text-center py-5">
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-circle me-2"></i>
                                No templates found for ${ceremonyType} ceremony.
                                <div class="mt-3">
                                    <a href="/bulk-upload" class="btn btn-sm btn-outline-dark">
                                        <i class="fas fa-upload me-1"></i> Upload Templates
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // Use templates from the response
                const templates = data.templates;
                
                // Show template count info
                templateContainer.innerHTML = `
                    <div class="col-12 mb-3">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Found ${templates.length} templates for ${ceremonyType} ceremony.
                            <span class="small text-muted ms-2">Last updated: ${new Date().toLocaleTimeString()}</span>
                        </div>
                    </div>
                `;
                
                // Display all templates
                templates.forEach((template, index) => {
                    const col = document.createElement('div');
                    col.className = 'col-md-3 col-sm-4 col-6 mb-3';
                    
                    const card = document.createElement('div');
                    card.className = 'card h-100 bg-dark template-card';
                    card.dataset.templateUrl = template.url;
                    card.dataset.templateId = template.id || '';
                    card.dataset.templatePath = template.path || template.url;
                    card.dataset.templateType = 'pinterest';
                    card.dataset.ceremony = ceremonyType;
                    
                    card.innerHTML = `
                        <div class="position-relative overflow-hidden" style="height: 350px;">
                            <img src="${template.url}" class="card-img-top template-img" 
                                alt="${ceremonyType} template" style="height: 350px; object-fit: cover;">
                            
                            <div class="position-absolute top-0 end-0 m-2 template-checkbox-wrapper">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input template-checkbox" 
                                        id="template-check-${ceremonyType}-${index}">
                                </div>
                            </div>
                            
                            <div class="position-absolute bottom-0 start-0 end-0 p-2 bg-dark bg-opacity-75">
                                <button type="button" class="btn btn-sm btn-primary w-100 select-template-btn">
                                    <i class="fas fa-magic me-1"></i> Use This Template
                                </button>
                            </div>
                        </div>
                    `;
                    
                    templateContainer.appendChild(col);
                    col.appendChild(card);
                    
                    // Add click event to the card
                    card.addEventListener('click', function() {
                        useTemplate(this);
                    });
                    
                    // Add click event to the select button
                    const selectBtn = card.querySelector('.select-template-btn');
                    if (selectBtn) {
                        selectBtn.addEventListener('click', function(e) {
                            e.stopPropagation(); // Prevent the card click event
                            useTemplate(this.closest('.template-card'));
                        });
                    }
                });
            })
            .catch(error => {
                console.error('Error loading templates:', error);
                templateContainer.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            Error loading templates: ${error.message}
                        </div>
                    </div>
                `;
            });
    }
});
</script>
{% endblock %}