{% extends "base.html" %}

{% block style %}
<style>
    .template-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .template-card {
        cursor: pointer;
        transition: all 0.3s ease;
        border: 3px solid transparent;
        border-radius: 10px;
        overflow: hidden;
        background-color: #212121;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .template-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.3);
    }
    
    .template-card.selected {
        border-color: #7e57c2;
    }
    
    .template-img-container {
        position: relative;
        height: 280px;
        overflow: hidden;
    }
    
    .template-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.5s ease;
    }
    
    .template-card:hover .template-img {
        transform: scale(1.05);
    }
    
    .template-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.8rem;
    }
    
    .template-info {
        padding: 12px;
    }
    
    .image-preview-container {
        height: 200px;
        border: 2px dashed #7e57c2;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 20px;
        overflow: hidden;
    }
    
    .preview-img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }
    
    .results-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
    }
    
    .result-card {
        border-radius: 10px;
        overflow: hidden;
        background-color: #212121;
        position: relative;
        transition: all 0.3s ease;
    }
    
    .result-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.3);
    }
    
    .result-img-container {
        height: 320px;
        overflow: hidden;
    }
    
    .result-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .result-controls {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: rgba(0, 0, 0, 0.7);
        padding: 10px;
        display: flex;
        justify-content: space-between;
        transition: opacity 0.3s ease;
        opacity: 0;
    }
    
    .result-card:hover .result-controls {
        opacity: 1;
    }
    
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
    }
    
    .spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 4px solid #7e57c2;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .ceremony-header {
        padding-bottom: 10px;
        margin-bottom: 20px;
        border-bottom: 1px solid #444;
    }
    
    .ceremony-icon {
        display: inline-flex;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
    }
    
    .ceremony-haldi {
        background-color: #ffc107;
        color: #212121;
    }
    
    .ceremony-mehendi {
        background-color: #4caf50;
        color: white;
    }
    
    .ceremony-sangeeth {
        background-color: #2196f3;
        color: white;
    }
    
    .ceremony-wedding {
        background-color: #f44336;
        color: white;
    }
    
    .ceremony-reception {
        background-color: #9c27b0;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-dark">
                    <h1 class="h3 mb-0">
                        <i class="fas fa-magic me-2"></i>Bridal Face Swap Studio
                    </h1>
                </div>
                <div class="card-body">
                    <!-- Photo Upload Section -->
                    <div class="row mb-4">
                        <div class="col-md-6 mx-auto">
                            <div class="card h-100">
                                <div class="card-header bg-dark">
                                    <h5 class="mb-0">Upload Your Photo</h5>
                                </div>
                                <div class="card-body">
                                    <div class="image-preview-container mb-3">
                                        <img id="source-preview" class="preview-img d-none" alt="Your photo preview">
                                        <div id="source-placeholder" class="text-center">
                                            <i class="fas fa-user-circle mb-2" style="font-size: 4rem; opacity: 0.5;"></i>
                                            <p class="text-muted">No photo selected yet<br>Please upload a clear frontal photo</p>
                                        </div>
                                    </div>
                                    
                                    <div class="input-group">
                                        <input type="file" class="form-control" id="source-input" accept=".jpg,.jpeg,.png" required>
                                        <button class="btn btn-outline-secondary" type="button" id="source-clear-btn">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ceremony Selector -->
                    <div class="mb-4">
                        <div class="card">
                            <div class="card-header bg-dark">
                                <h5 class="mb-0">Choose Ceremony Type</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex flex-wrap justify-content-center gap-3">
                                    {% for ceremony in ['haldi', 'mehendi', 'sangeeth', 'wedding', 'reception'] %}
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input ceremony-checkbox" type="checkbox" 
                                               id="ceremony-{{ ceremony }}" value="{{ ceremony }}" 
                                               {% if ceremony == 'wedding' %}checked{% endif %}>
                                        <label class="form-check-label" for="ceremony-{{ ceremony }}">
                                            {{ ceremony|title }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="templates-container">
                        <!-- Template sections will be populated here -->
                    </div>
                    
                    <div class="text-center mt-4">
                        <button id="process-all-btn" class="btn btn-primary btn-lg" disabled>
                            <i class="fas fa-magic me-2"></i>Create All Selected Looks
                        </button>
                    </div>
                    
                    <div id="error-container" class="alert alert-danger mt-4 d-none" role="alert">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <span id="error-message"></span>
                    </div>
                </div>
            </div>
            
            <!-- Results Section -->
            <div id="results-section" class="card shadow-sm mb-4 d-none">
                <div class="card-header bg-dark">
                    <h2 class="h4 mb-0">Your Bridal Looks</h2>
                </div>
                <div class="card-body">
                    <div id="results-container" class="results-gallery">
                        <!-- Result cards will be inserted here -->
                    </div>
                    
                    <div class="text-center mt-4">
                        <button id="download-all-btn" class="btn btn-success">
                            <i class="fas fa-download me-2"></i>Download All
                        </button>
                        <button id="try-more-btn" class="btn btn-secondary ms-2">
                            <i class="fas fa-redo me-2"></i>Try More Styles
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // DOM Elements
    const sourceInput = document.getElementById('source-input');
    const sourcePreview = document.getElementById('source-preview');
    const sourcePlaceholder = document.getElementById('source-placeholder');
    const sourceClearBtn = document.getElementById('source-clear-btn');
    const processAllBtn = document.getElementById('process-all-btn');
    const resultsSection = document.getElementById('results-section');
    const resultsContainer = document.getElementById('results-container');
    const downloadAllBtn = document.getElementById('download-all-btn');
    const tryMoreBtn = document.getElementById('try-more-btn');
    const errorContainer = document.getElementById('error-container');
    const errorMessage = document.getElementById('error-message');
    const modelStatusAlert = document.getElementById('model-status-alert');
    const modelStatusMessage = document.getElementById('model-status-message');
    const templatesContainer = document.getElementById('templates-container');
    const ceremonyCheckboxes = document.querySelectorAll('.ceremony-checkbox');
    
    // State variables
    let uploadedFile = null;
    let selectedTemplates = [];
    let processedResults = [];
    
    // Check if models are loaded
    checkModelsStatus();
    
    // Initialize template sections based on selected ceremonies
    updateTemplateSections();
    
    // Check for template updates from bulk upload page
    checkForTemplateUpdates();
    
    // Set up periodic checking for template updates (every 5 seconds)
    setInterval(checkForTemplateUpdates, 5000);
    
    // Also check for updates every time the page becomes visible again
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            checkForTemplateUpdates();
        }
    });
    
    // File input change handler
    sourceInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            uploadedFile = this.files[0];
            
            reader.onload = function(e) {
                sourcePreview.src = e.target.result;
                sourcePreview.classList.remove('d-none');
                sourcePlaceholder.classList.add('d-none');
                updateProcessButtonState();
            };
            
            reader.readAsDataURL(this.files[0]);
        }
    });
    
    // Clear button handler
    sourceClearBtn.addEventListener('click', function() {
        sourceInput.value = '';
        sourcePreview.classList.add('d-none');
        sourcePlaceholder.classList.remove('d-none');
        uploadedFile = null;
        updateProcessButtonState();
    });
    
    // Ceremony checkbox change handler
    ceremonyCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateTemplateSections();
            updateSelectedTemplates();
        });
    });
    
    // Process all button handler
    processAllBtn.addEventListener('click', async function() {
        if (!uploadedFile || selectedTemplates.length === 0) {
            showError('Please upload a photo and select at least one template.');
            return;
        }
        
        // Reset results
        processedResults = [];
        resultsContainer.innerHTML = '';
        
        // Process each selected template
        for (const template of selectedTemplates) {
            await processTemplate(template);
        }
        
        // Show results section
        resultsSection.classList.remove('d-none');
        resultsSection.scrollIntoView({ behavior: 'smooth' });
    });
    
    // Try more styles button handler
    tryMoreBtn.addEventListener('click', function() {
        resultsSection.classList.add('d-none');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
    
    // Download all button handler
    downloadAllBtn.addEventListener('click', function() {
        for (const result of processedResults) {
            const link = document.createElement('a');
            link.href = result.url;
            link.download = result.filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    });
    
    // Helper Functions
    function updateTemplateSections() {
        templatesContainer.innerHTML = '';
        
        const selectedCeremonies = Array.from(ceremonyCheckboxes)
            .filter(checkbox => checkbox.checked)
            .map(checkbox => checkbox.value);
            
        if (selectedCeremonies.length === 0) {
            templatesContainer.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Please select at least one ceremony type to see templates.
                </div>
            `;
            return;
        }
        
        // Create sections for each selected ceremony
        for (const ceremony of selectedCeremonies) {
            const ceremonySection = document.createElement('div');
            ceremonySection.className = 'mb-5';
            ceremonySection.innerHTML = `
                <div class="ceremony-header d-flex align-items-center">
                    <div class="ceremony-icon ceremony-${ceremony}">
                        <i class="fas fa-${getCeremonyIcon(ceremony)}"></i>
                    </div>
                    <h3 class="mb-0">${capitalize(ceremony)} Ceremony</h3>
                </div>
                <div class="template-gallery" id="${ceremony}-templates">
                    <!-- Templates will be loaded here -->
                    <div class="loading-placeholder text-center py-5 w-100">
                        <div class="spinner-border text-secondary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading templates...</p>
                    </div>
                </div>
            `;
            templatesContainer.appendChild(ceremonySection);
            
            // Load templates for this ceremony
            loadTemplates(ceremony);
        }
    }
    
    function loadTemplates(ceremony) {
        // Add cache busting parameter
        const timestamp = Date.now();
        fetch(`/api/templates?ceremony=${ceremony}&_t=${timestamp}`)
            .then(response => response.json())
            .then(data => {
                const galleryEl = document.getElementById(`${ceremony}-templates`);
                
                if (!data.templates || data.templates.length === 0) {
                    galleryEl.innerHTML = `
                        <div class="alert alert-info w-100">
                            No templates available for ${capitalize(ceremony)} ceremony.
                        </div>
                    `;
                    return;
                }
                
                // Add template count information with timestamp
                const countInfoEl = document.createElement('div');
                countInfoEl.className = 'mb-3 small text-muted';
                countInfoEl.innerHTML = `
                    <i class="fas fa-info-circle me-1"></i>
                    Found ${data.templates.length} templates for ${capitalize(ceremony)} ceremony.
                    <span class="ms-2">Last updated: ${new Date().toLocaleTimeString()}</span>
                `;
                
                galleryEl.innerHTML = '';
                galleryEl.appendChild(countInfoEl);
                
                // Add templates to the gallery
                data.templates.forEach(template => {
                    const templateCard = document.createElement('div');
                    templateCard.className = 'template-card';
                    templateCard.dataset.ceremony = ceremony;
                    // No longer tracking template type since we only use Pinterest templates
                    templateCard.dataset.path = template.path;
                    
                    templateCard.innerHTML = `
                        <div class="template-img-container">
                            <img src="${template.url}" class="template-img" alt="${capitalize(ceremony)} Template">
                            <!-- Template badge removed - no need to show template type -->
                        </div>
                        <div class="template-info">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">${capitalize(ceremony)} Template</h6>
                                <div class="form-check">
                                    <input class="form-check-input template-checkbox" type="checkbox" 
                                           value="${template.id}" id="template-${template.id}"
                                           data-ceremony="${ceremony}">
                                </div>
                            </div>
                        </div>
                    `;
                    
                    galleryEl.appendChild(templateCard);
                    
                    // Add click handler to toggle selection
                    const checkbox = templateCard.querySelector('.template-checkbox');
                    templateCard.addEventListener('click', function(e) {
                        if (e.target !== checkbox) {
                            checkbox.checked = !checkbox.checked;
                            toggleTemplateSelection(templateCard, checkbox.checked);
                            updateSelectedTemplates();
                        }
                    });
                    
                    checkbox.addEventListener('change', function() {
                        toggleTemplateSelection(templateCard, this.checked);
                        updateSelectedTemplates();
                    });
                });
            })
            .catch(error => {
                console.error('Error loading templates:', error);
                const galleryEl = document.getElementById(`${ceremony}-templates`);
                galleryEl.innerHTML = `
                    <div class="alert alert-danger w-100">
                        Error loading templates: ${error.message}
                    </div>
                `;
            });
    }
    
    function toggleTemplateSelection(templateCard, isSelected) {
        if (isSelected) {
            templateCard.classList.add('selected');
        } else {
            templateCard.classList.remove('selected');
        }
    }
    
    function updateSelectedTemplates() {
        const checkboxes = document.querySelectorAll('.template-checkbox:checked');
        selectedTemplates = Array.from(checkboxes).map(checkbox => ({
            id: checkbox.value,
            ceremony: checkbox.dataset.ceremony,
            type: checkbox.dataset.type,
            element: checkbox.closest('.template-card')
        }));
        
        updateProcessButtonState();
    }
    
    function updateProcessButtonState() {
        processAllBtn.disabled = !uploadedFile || selectedTemplates.length === 0;
    }
    
    async function processTemplate(template) {
        // Create result card placeholder
        const resultCard = document.createElement('div');
        resultCard.className = 'result-card';
        resultCard.innerHTML = `
            <div class="result-img-container">
                <div class="loading-overlay">
                    <div class="spinner"></div>
                </div>
                <img class="result-img" alt="${capitalize(template.ceremony)} face swap">
            </div>
            <div class="result-controls">
                <span class="text-white">${capitalize(template.ceremony)} ${capitalize(template.type)}</span>
                <button class="btn btn-sm btn-outline-light download-btn">
                    <i class="fas fa-download"></i>
                </button>
            </div>
        `;
        
        resultsContainer.appendChild(resultCard);
        
        // Process the template
        try {
            const formData = new FormData();
            formData.append('source', uploadedFile);
            formData.append('style', template.ceremony);
            formData.append('template_type', template.type);
            
            const response = await fetch('/bridal-swap', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.error || 'Failed to process template');
            }
            
            // Update the result card
            const resultImg = resultCard.querySelector('.result-img');
            resultImg.src = `/uploads/${data.result_image}`;
            
            // Store result for download all function
            processedResults.push({
                url: `/uploads/${data.result_image}`,
                filename: data.result_image
            });
            
            // Add download handler
            const downloadBtn = resultCard.querySelector('.download-btn');
            downloadBtn.addEventListener('click', function() {
                const link = document.createElement('a');
                link.href = `/uploads/${data.result_image}`;
                link.download = data.result_image;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
            
            // Remove loading overlay
            const loadingOverlay = resultCard.querySelector('.loading-overlay');
            loadingOverlay.remove();
        } catch (error) {
            // Show error in the result card
            resultCard.innerHTML = `
                <div class="alert alert-danger m-0">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Error: ${error.message}
                </div>
            `;
        }
    }
    
    function checkModelsStatus() {
        fetch('/check-models')
            .then(response => response.json())
            .then(data => {
                if (!data.face_detection_model || !data.face_swap_model) {
                    modelStatusAlert.classList.remove('d-none');
                    modelStatusMessage.textContent = 'Face detection or face swap model not loaded. Some features may not work properly.';
                } else {
                    modelStatusAlert.classList.add('d-none');
                }
            })
            .catch(error => {
                console.error('Error checking model status:', error);
                modelStatusAlert.classList.remove('d-none');
                modelStatusMessage.textContent = 'Error checking model status: ' + error.message;
            });
    }
    
    function showError(message) {
        errorMessage.textContent = message;
        errorContainer.classList.remove('d-none');
        errorContainer.scrollIntoView({ behavior: 'smooth' });
    }
    
    function capitalize(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
    }
    
    // Function to check localStorage for updates from the bulk upload page
    function checkForTemplateUpdates() {
        const shouldRefresh = localStorage.getItem('refreshTemplates') === 'true';
        const updateTimestamp = localStorage.getItem('updateTimestamp');
        const lastProcessedTimestamp = localStorage.getItem('lastProcessedMultiTimestamp') || '0';
        
        // Check if either the refresh flag is set or there's a new timestamp
        if (shouldRefresh || (updateTimestamp && updateTimestamp !== lastProcessedTimestamp)) {
            console.log('Template update detected from bulk upload page');
            console.log('Update timestamp:', updateTimestamp);
            console.log('Last processed timestamp:', lastProcessedTimestamp);
            
            const updatedCeremony = localStorage.getItem('lastUpdatedCeremony');
            
            // Update the processed timestamp to avoid redundant refreshes
            localStorage.setItem('lastProcessedMultiTimestamp', updateTimestamp || Date.now().toString());
            
            // Clear the flag immediately to avoid repeated refreshes
            localStorage.removeItem('refreshTemplates');
            
            // Add debugging information to the console
            console.log('Refreshing templates after upload detected');
            
            // Refresh all templates for all ceremonies
            const ceremonyTypes = ['haldi', 'mehendi', 'sangeeth', 'wedding', 'reception'];
            ceremonyTypes.forEach(ceremony => loadTemplates(ceremony));
        }
    }
    
    function getCeremonyIcon(ceremony) {
        switch (ceremony) {
            case 'haldi': return 'sun';
            case 'mehendi': return 'paint-brush';
            case 'sangeeth': return 'music';
            case 'wedding': return 'heart';
            case 'reception': return 'glass-cheers';
            default: return 'circle';
        }
    }
});
</script>
{% endblock %}