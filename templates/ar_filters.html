{% extends 'base.html' %}

{% block title %}AR Filters - Real-time Preview{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">AR Filters</h1>
    <p class="lead">Try on virtual bridal looks with real-time preview</p>

    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    Live Camera Preview
                </div>
                <div class="card-body p-0">
                    <div class="position-relative" style="min-height: 400px;">
                        <video id="webcam" class="w-100" style="max-height: 500px;" autoplay playsinline></video>
                        <canvas id="overlay" class="position-absolute top-0 start-0 w-100 h-100" style="display:none;"></canvas>
                        <div id="loading-indicator" class="position-absolute top-50 start-50 translate-middle text-center" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Processing...</p>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <button id="start-camera" class="btn btn-primary">Start Camera</button>
                    <button id="take-photo" class="btn btn-success ms-2" disabled>Capture</button>
                    <button id="clear-filter" class="btn btn-danger ms-2" disabled>Clear Filter</button>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    Available Filters
                </div>
                <div class="card-body">
                    <div class="list-group filter-options">
                        <button class="list-group-item list-group-item-action filter-option" data-ceremony="haldi">
                            <strong>Haldi</strong> - Turmeric Glow
                        </button>
                        <button class="list-group-item list-group-item-action filter-option" data-ceremony="mehendi">
                            <strong>Mehendi</strong> - Traditional Henna
                        </button>
                        <button class="list-group-item list-group-item-action filter-option" data-ceremony="sangeeth">
                            <strong>Sangeeth</strong> - Celebration Ready
                        </button>
                        <button class="list-group-item list-group-item-action filter-option" data-ceremony="wedding">
                            <strong>Wedding</strong> - Bridal Look
                        </button>
                        <button class="list-group-item list-group-item-action filter-option" data-ceremony="reception">
                            <strong>Reception</strong> - Evening Glamour
                        </button>
                    </div>
                </div>
            </div>

            <div class="card mt-4" id="result-card" style="display:none;">
                <div class="card-header bg-success text-white">
                    Your Result
                </div>
                <div class="card-body p-0 text-center">
                    <img id="result-image" class="img-fluid" src="" alt="Filter Result">
                </div>
                <div class="card-footer">
                    <a id="download-result" class="btn btn-primary" download="ar-filter-result.jpg">Download</a>
                    <button id="share-result" class="btn btn-info ms-2">Share</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const webcamElement = document.getElementById('webcam');
        const overlayCanvas = document.getElementById('overlay');
        const startCameraBtn = document.getElementById('start-camera');
        const takePhotoBtn = document.getElementById('take-photo');
        const clearFilterBtn = document.getElementById('clear-filter');
        const filterOptions = document.querySelectorAll('.filter-option');
        const resultCard = document.getElementById('result-card');
        const resultImage = document.getElementById('result-image');
        const downloadLink = document.getElementById('download-result');
        const loadingIndicator = document.getElementById('loading-indicator');
        
        let currentStream = null;
        let selectedFilter = null;
        let overlayCtx = overlayCanvas.getContext('2d');
        
        // Start webcam when button is clicked
        startCameraBtn.addEventListener('click', async () => {
            try {
                const constraints = {
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    }
                };
                
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                webcamElement.srcObject = currentStream;
                
                // Wait for video to be ready
                webcamElement.onloadedmetadata = () => {
                    // Set canvas dimensions to match video
                    overlayCanvas.width = webcamElement.videoWidth;
                    overlayCanvas.height = webcamElement.videoHeight;
                    overlayCanvas.style.display = 'block';
                    
                    // Enable buttons
                    takePhotoBtn.disabled = false;
                    clearFilterBtn.disabled = false;
                    startCameraBtn.disabled = true;
                };
                
            } catch (error) {
                console.error('Error accessing camera:', error);
                alert('Error accessing camera. Please ensure you have granted camera permissions.');
            }
        });
        
        // Filter selection logic
        filterOptions.forEach(option => {
            option.addEventListener('click', () => {
                // Clear previous selection
                filterOptions.forEach(opt => opt.classList.remove('active'));
                
                // Set new selection
                option.classList.add('active');
                selectedFilter = option.dataset.ceremony;
                
                // If camera is active, apply virtual filter preview
                if (currentStream) {
                    applyFilterPreview(selectedFilter);
                }
            });
        });
        
        // Apply a visual filter to the canvas overlay based on ceremony type
        function applyFilterPreview(ceremony) {
            // Clear previous overlay
            overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            
            // Apply different visual effects based on ceremony
            switch(ceremony) {
                case 'haldi':
                    // Yellowish golden overlay for Haldi
                    overlayCtx.fillStyle = 'rgba(255, 215, 0, 0.2)';
                    overlayCtx.fillRect(0, 0, overlayCanvas.width, overlayCanvas.height);
                    break;
                case 'mehendi':
                    // Reddish-orange overlay for Mehendi
                    overlayCtx.fillStyle = 'rgba(220, 80, 60, 0.15)';
                    overlayCtx.fillRect(0, 0, overlayCanvas.width, overlayCanvas.height);
                    break;
                case 'sangeeth':
                    // Purplish overlay for Sangeeth
                    overlayCtx.fillStyle = 'rgba(120, 80, 200, 0.15)';
                    overlayCtx.fillRect(0, 0, overlayCanvas.width, overlayCanvas.height);
                    break;
                case 'wedding':
                    // Elegant red overlay for Wedding
                    overlayCtx.fillStyle = 'rgba(180, 30, 30, 0.15)';
                    overlayCtx.fillRect(0, 0, overlayCanvas.width, overlayCanvas.height);
                    break;
                case 'reception':
                    // Soft blue-silver overlay for Reception
                    overlayCtx.fillStyle = 'rgba(70, 130, 180, 0.15)';
                    overlayCtx.fillRect(0, 0, overlayCanvas.width, overlayCanvas.height);
                    break;
            }
            
            // Add some decorative elements based on ceremony type
            if (ceremony === 'wedding' || ceremony === 'reception') {
                drawFrameBorder(ceremony);
            }
        }
        
        // Draw a decorative border based on ceremony type
        function drawFrameBorder(ceremony) {
            const borderWidth = 20;
            overlayCtx.lineWidth = borderWidth;
            
            if (ceremony === 'wedding') {
                // Elegant border for wedding
                overlayCtx.strokeStyle = 'rgba(180, 30, 30, 0.3)';
            } else {
                // Reception border
                overlayCtx.strokeStyle = 'rgba(70, 130, 180, 0.3)';
            }
            
            overlayCtx.strokeRect(
                borderWidth/2, 
                borderWidth/2, 
                overlayCanvas.width - borderWidth, 
                overlayCanvas.height - borderWidth
            );
        }
        
        // Take photo with current filter
        takePhotoBtn.addEventListener('click', () => {
            if (!selectedFilter) {
                alert('Please select a filter first');
                return;
            }
            
            // Show loading indicator
            loadingIndicator.style.display = 'block';
            
            // Create a temporary canvas to combine video and overlay
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = webcamElement.videoWidth;
            tempCanvas.height = webcamElement.videoHeight;
            const tempCtx = tempCanvas.getContext('2d');
            
            // Draw the video frame
            tempCtx.drawImage(webcamElement, 0, 0, tempCanvas.width, tempCanvas.height);
            
            // Draw the overlay
            tempCtx.drawImage(overlayCanvas, 0, 0);
            
            // Display result
            setTimeout(() => {
                // Convert to data URL
                const dataUrl = tempCanvas.toDataURL('image/jpeg');
                
                // Set as result image
                resultImage.src = dataUrl;
                downloadLink.href = dataUrl;
                
                // Show result card
                resultCard.style.display = 'block';
                
                // Hide loading indicator
                loadingIndicator.style.display = 'none';
                
                // In a real implementation, we would send the image to the server
                // for actual face swap processing here
            }, 1000); // Simulated processing delay
        });
        
        // Clear filter
        clearFilterBtn.addEventListener('click', () => {
            // Clear overlay
            overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            
            // Clear selection
            filterOptions.forEach(opt => opt.classList.remove('active'));
            selectedFilter = null;
            
            // Hide result card
            resultCard.style.display = 'none';
        });
        
        // Share result (placeholder functionality)
        document.getElementById('share-result').addEventListener('click', () => {
            if (navigator.share) {
                // Use Web Share API if available
                fetch(resultImage.src)
                    .then(res => res.blob())
                    .then(blob => {
                        const file = new File([blob], "ar-filter.jpg", { type: "image/jpeg" });
                        navigator.share({
                            title: 'My Virtual Bridal Look',
                            text: 'Check out my virtual bridal look created with AR Filters!',
                            files: [file]
                        }).catch(err => {
                            console.error('Share failed:', err);
                            alert('Could not share the image. You can download it instead.');
                        });
                    });
            } else {
                alert('Sharing not supported on this browser. You can download the image instead.');
            }
        });
    });
</script>
{% endblock %}