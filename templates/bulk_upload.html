{% extends 'base.html' %}

{% block title %}Template Management{% endblock %}

{% block content %}
<div class="container mt-4">
    <h4 class="mb-4 text-center">Template Management</h4>
    
    <div class="row g-4">
        <!-- Upload Section -->
        <div class="col-lg-6">
            <div class="bg-dark p-4 rounded shadow-sm border-0">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="m-0">Upload Templates</h5>
                </div>
                
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="images" class="form-label small">Select Images</label>
                        <input type="file" class="form-control form-control-sm bg-dark text-light border-secondary" id="images" name="files" multiple accept="image/*" required>
                        <div class="form-text text-muted small mt-1">First image becomes main template</div>
                        <div id="fileListContainer" class="mt-2"></div>
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col-md-8">
                            <select class="form-select form-select-sm bg-dark text-light border-secondary" id="ceremonyType" name="ceremony_type" required>
                                <option value="" disabled selected>Select ceremony</option>
                                <option value="haldi">Haldi</option>
                                <option value="mehendi">Mehendi</option>
                                <option value="sangeeth">Sangeeth</option>
                                <option value="wedding">Wedding</option>
                                <option value="reception">Reception</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <button type="button" id="uploadSelected" class="btn btn-sm btn-primary w-100">Upload</button>
                        </div>
                    </div>
                </form>
                
                <div id="uploadStatus" class="my-3" style="display: none;">
                    <div class="progress" style="height: 4px;">
                        <div id="uploadProgress" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div id="statusMessage" class="mt-2 small text-light"></div>
                </div>

                <div id="uploadResult" class="my-3" style="display: none;">
                    <div id="successMessage" class="p-2 rounded bg-success bg-opacity-10 text-success small"></div>
                </div>
            </div>
        </div>
        
        <!-- Template Management -->
        <div class="col-lg-6">
            <div class="bg-dark p-4 rounded shadow-sm border-0">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="m-0">Manage Templates</h5>
                    <div class="d-flex gap-2">
                        <button id="selectAllTemplates" class="btn btn-sm btn-outline-secondary px-2">
                            <i class="fas fa-check-square me-1"></i>Select All
                        </button>
                        <button id="deleteSelected" class="btn btn-sm btn-danger px-2">
                            <i class="fas fa-trash-alt me-1"></i>Delete
                        </button>
                        <button id="refreshTemplates" class="btn btn-sm btn-outline-light px-2">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                
                <div id="deleteStatus" class="mb-3" style="display: none;">
                    <div class="progress" style="height: 4px;">
                        <div id="deleteProgress" class="progress-bar progress-bar-striped progress-bar-animated bg-danger" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div id="deleteStatusMessage" class="mt-2 small text-light"></div>
                </div>
                
                <div class="btn-group w-100 mb-3" role="group" aria-label="Ceremony selection">
                    <input type="radio" class="btn-check" name="ceremonyTab" id="haldi-tab-radio" value="haldi" checked>
                    <label class="btn btn-outline-secondary btn-sm" for="haldi-tab-radio">Haldi</label>
                    
                    <input type="radio" class="btn-check" name="ceremonyTab" id="mehendi-tab-radio" value="mehendi">
                    <label class="btn btn-outline-secondary btn-sm" for="mehendi-tab-radio">Mehendi</label>
                    
                    <input type="radio" class="btn-check" name="ceremonyTab" id="sangeeth-tab-radio" value="sangeeth">
                    <label class="btn btn-outline-secondary btn-sm" for="sangeeth-tab-radio">Sangeeth</label>
                    
                    <input type="radio" class="btn-check" name="ceremonyTab" id="wedding-tab-radio" value="wedding">
                    <label class="btn btn-outline-secondary btn-sm" for="wedding-tab-radio">Wedding</label>
                    
                    <input type="radio" class="btn-check" name="ceremonyTab" id="reception-tab-radio" value="reception">
                    <label class="btn btn-outline-secondary btn-sm" for="reception-tab-radio">Reception</label>
                </div>
                
                <div class="tab-content" id="deleteTabContent">
                    <div class="tab-pane fade show active" id="haldi-delete" role="tabpanel">
                        <div id="haldi-templates" class="row g-2 template-container">
                            <div class="col-12 text-center loading-placeholder py-4">
                                <div class="spinner-border spinner-border-sm text-secondary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="mehendi-delete" role="tabpanel">
                        <div id="mehendi-templates" class="row g-2 template-container">
                            <div class="col-12 text-center loading-placeholder py-4">
                                <div class="spinner-border spinner-border-sm text-secondary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="sangeeth-delete" role="tabpanel">
                        <div id="sangeeth-templates" class="row g-2 template-container">
                            <div class="col-12 text-center loading-placeholder py-4">
                                <div class="spinner-border spinner-border-sm text-secondary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="wedding-delete" role="tabpanel">
                        <div id="wedding-templates" class="row g-2 template-container">
                            <div class="col-12 text-center loading-placeholder py-4">
                                <div class="spinner-border spinner-border-sm text-secondary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="reception-delete" role="tabpanel">
                        <div id="reception-templates" class="row g-2 template-container">
                            <div class="col-12 text-center loading-placeholder py-4">
                                <div class="spinner-border spinner-border-sm text-secondary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden container for image data processing -->
    <div id="imagePreview" class="d-none"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize key UI elements
    const uploadForm = document.getElementById('uploadForm');
    const imageInput = document.getElementById('images');
    const imagePreview = document.getElementById('imagePreview');
    const uploadStatus = document.getElementById('uploadStatus');
    const uploadProgress = document.getElementById('uploadProgress');
    const statusMessage = document.getElementById('statusMessage');
    const uploadResult = document.getElementById('uploadResult');
    const successMessage = document.getElementById('successMessage');
    const deleteButton = document.getElementById('deleteSelected');
    const deleteStatus = document.getElementById('deleteStatus');
    const deleteProgress = document.getElementById('deleteProgress');
    const deleteStatusMessage = document.getElementById('deleteStatusMessage');
    const selectAllTemplatesButton = document.getElementById('selectAllTemplates');
    
    // File input change handler - show count without previews
    imageInput.addEventListener('change', function() {
        const fileCount = this.files.length;
        const uploadSelectedButton = document.getElementById('uploadSelected');
        
        // Clear previous data
        imagePreview.innerHTML = '';
        
        // Create hidden elements for files (all selected by default)
        for (let i = 0; i < this.files.length; i++) {
            const file = this.files[i];
            const hiddenElement = document.createElement('div');
            hiddenElement.className = 'd-none';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'image-checkbox';
            checkbox.checked = true; // All files are selected by default
            checkbox.dataset.fileName = file.name;
            checkbox.dataset.fileIndex = i;
            
            hiddenElement.appendChild(checkbox);
            imagePreview.appendChild(hiddenElement);
        }
        
        // Update button state based on file count
        if (fileCount > 0) {
            uploadSelectedButton.textContent = `Upload (${fileCount})`;
            uploadSelectedButton.disabled = false;
        } else {
            uploadSelectedButton.textContent = 'Upload';
            uploadSelectedButton.disabled = true;
        }
        
        // Show file count indicator
        const fileListContainer = document.getElementById('fileListContainer');
        if (fileListContainer && fileCount > 0) {
            fileListContainer.innerHTML = '';
            
            const fileCountBadge = document.createElement('div');
            fileCountBadge.className = 'd-inline-block py-1 px-2 mt-1 rounded bg-dark border border-secondary';
            fileCountBadge.innerHTML = `
                <small>
                    <i class="fas fa-image text-primary me-1"></i>
                    <span class="text-light">${fileCount} file${fileCount !== 1 ? 's' : ''} selected</span>
                </small>
            `;
            fileListContainer.appendChild(fileCountBadge);
        } else if (fileListContainer) {
            fileListContainer.innerHTML = '';
        }
    });

    // Get upload button
    const uploadSelectedButton = document.getElementById('uploadSelected');
    
    // Upload handler function
    function uploadCheckedImages() {
        const ceremonyType = document.getElementById('ceremonyType').value;
        
        if (!ceremonyType) {
            alert('Please select a ceremony type');
            return;
        }
        
        const checkedBoxes = document.querySelectorAll('.image-checkbox:checked');
        
        if (checkedBoxes.length === 0) {
            alert('Please select at least one image');
            return;
        }
        
        // Disable form controls during upload
        uploadSelectedButton.disabled = true;
        document.getElementById('ceremonyType').disabled = true;
        imageInput.disabled = true;
        
        // Prepare form data
        const formData = new FormData();
        formData.append('ceremony_type', ceremonyType);
        
        // Find selected files
        const uploadingFileNames = [];
        Array.from(imageInput.files).forEach(file => {
            const isSelected = Array.from(checkedBoxes).some(
                checkbox => checkbox.dataset.fileName === file.name
            );
            
            if (isSelected) {
                formData.append('files', file);
                formData.append('file_categories', ceremonyType);
                uploadingFileNames.push(file.name);
            }
        });
        
        // Show upload progress
        uploadStatus.style.display = 'block';
        uploadResult.style.display = 'none';
        uploadProgress.style.width = '0%';
        statusMessage.textContent = `Uploading ${uploadingFileNames.length} template${uploadingFileNames.length !== 1 ? 's' : ''} to ${ceremonyType}...`;
        
        // Animated progress bar
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += 5;
            if (progress >= 90) clearInterval(progressInterval);
            uploadProgress.style.width = progress + '%';
        }, 200);
        
        // Upload API call
        fetch('/upload-bulk-templates', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            clearInterval(progressInterval);
            uploadProgress.style.width = '100%';
            
            // Re-enable form controls
            uploadSelectedButton.disabled = false;
            document.getElementById('ceremonyType').disabled = false;
            imageInput.disabled = false;
            
            if (data.success) {
                statusMessage.textContent = 'Upload complete!';
                
                // Show success message
                uploadResult.style.display = 'block';
                successMessage.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <div>
                            <strong>Uploaded ${data.uploaded_count || uploadingFileNames.length} template${(data.uploaded_count || uploadingFileNames.length) !== 1 ? 's' : ''}</strong>
                        </div>
                    </div>
                `;
                
                // Reset form
                imageInput.value = '';
                imagePreview.innerHTML = '';
                document.getElementById('fileListContainer').innerHTML = '';
                uploadSelectedButton.textContent = 'Upload';
                uploadSelectedButton.disabled = true;
                
                // Refresh the template display
                refreshTemplates(ceremonyType);
                
                // Select the corresponding tab
                document.querySelector(`input[name="ceremonyTab"][value="${ceremonyType}"]`).checked = true;
                document.querySelectorAll('.tab-pane').forEach(tab => {
                    tab.classList.remove('show', 'active');
                });
                document.getElementById(`${ceremonyType}-delete`).classList.add('show', 'active');
                
                // Set localStorage flags for cross-page notifications
                const timestamp = Date.now().toString();
                localStorage.setItem('refreshTemplates', 'true');
                localStorage.setItem('lastUpdatedCeremony', ceremonyType);
                localStorage.setItem('updateTimestamp', timestamp);
                
                // Hide upload status after delay
                setTimeout(() => {
                    uploadStatus.style.display = 'none';
                }, 3000);
            } else {
                statusMessage.textContent = 'Error: ' + (data.error || 'Unknown error occurred');
            }
        })
        .catch(error => {
            clearInterval(progressInterval);
            uploadProgress.style.width = '100%';
            statusMessage.textContent = 'Error: ' + error.message;
            
            // Re-enable form controls on error
            formControls.forEach(control => { if (control) control.disabled = false; });
        });
    }
    
    // Button and form submit handlers
    uploadSelectedButton.addEventListener('click', uploadCheckedImages);
    uploadForm.addEventListener('submit', (e) => {
        e.preventDefault();
        uploadCheckedImages();
    });
    
    // Set up ceremony tab radio buttons
    const ceremonyRadios = document.querySelectorAll('input[name="ceremonyTab"]');
    ceremonyRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.checked) {
                const ceremony = this.value;
                
                // Update tab visibility
                document.querySelectorAll('.tab-pane').forEach(tab => {
                    tab.classList.remove('show', 'active');
                });
                
                const tabPane = document.getElementById(`${ceremony}-delete`);
                if (tabPane) {
                    tabPane.classList.add('show', 'active');
                }
                
                // Load templates for this ceremony type
                refreshTemplates(ceremony);
            }
        });
    });
    
    // Template deletion functionality
    function deleteSelectedTemplates() {
        const checkedTemplates = document.querySelectorAll('.template-checkbox:checked');
        
        if (checkedTemplates.length === 0) {
            alert('Please select at least one template to delete');
            return;
        }
        
        if (!confirm(`Delete ${checkedTemplates.length} selected template${checkedTemplates.length !== 1 ? 's' : ''}?`)) {
            return;
        }
        
        // Get selected ceremony for refreshing later
        const selectedCeremony = document.querySelector('input[name="ceremonyTab"]:checked').value;
        
        // Collect template paths to delete
        const templatePaths = Array.from(checkedTemplates).map(checkbox => checkbox.dataset.templatePath);
        
        // Disable delete button during operation
        deleteButton.disabled = true;
        
        // Show delete progress UI
        deleteStatus.style.display = 'block';
        deleteProgress.style.width = '0%';
        deleteStatusMessage.textContent = `Deleting ${templatePaths.length} template${templatePaths.length !== 1 ? 's' : ''}...`;
        
        // Animated progress
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += 10;
            if (progress >= 90) clearInterval(progressInterval);
            deleteProgress.style.width = progress + '%';
        }, 150);
        
        // Delete API call
        fetch('/delete-templates', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ template_paths: templatePaths })
        })
        .then(response => response.json())
        .then(data => {
            clearInterval(progressInterval);
            deleteProgress.style.width = '100%';
            deleteButton.disabled = false;
            
            if (data.success) {
                deleteStatusMessage.textContent = `Successfully deleted ${templatePaths.length} template${templatePaths.length !== 1 ? 's' : ''}`;
                
                // Refresh templates
                refreshTemplates(selectedCeremony);
                
                // Notify other pages
                const timestamp = Date.now().toString();
                localStorage.setItem('refreshTemplates', 'true');
                localStorage.setItem('lastUpdatedCeremony', selectedCeremony);
                localStorage.setItem('updateTimestamp', timestamp);
                
                // Hide status after delay
                setTimeout(() => {
                    deleteStatus.style.display = 'none';
                }, 3000);
            } else {
                deleteStatusMessage.textContent = 'Error: ' + (data.error || 'Failed to delete templates');
            }
        })
        .catch(error => {
            clearInterval(progressInterval);
            deleteProgress.style.width = '100%';
            deleteStatusMessage.textContent = 'Error: ' + error.message;
            deleteButton.disabled = false;
        });
    }
    
    // Delete button handler
    deleteButton.addEventListener('click', deleteSelectedTemplates);
    
    // Select all templates for deletion
    selectAllTemplatesButton.addEventListener('click', function() {
        const currentCeremony = document.querySelector('input[name="ceremonyTab"]:checked').value;
        const templateCheckboxes = document.querySelectorAll(`.template-checkbox[data-ceremony="${currentCeremony}"]`);
        
        templateCheckboxes.forEach(checkbox => {
            checkbox.checked = true;
        });
    });
    
    // Template refresh functionality
    function refreshTemplates(ceremonyType) {
        const templateContainer = document.getElementById(`${ceremonyType}-templates`);
        if (!templateContainer) return;
        
        const loadingPlaceholder = templateContainer.querySelector('.loading-placeholder');
        if (loadingPlaceholder) {
            loadingPlaceholder.style.display = 'block';
        }
        
        // Remove existing template cards
        Array.from(templateContainer.children).forEach(child => {
            if (!child.classList.contains('loading-placeholder')) {
                child.remove();
            }
        });
        
        // Fetch templates from API
        fetch(`/api/templates?ceremony_type=${ceremonyType}`)
            .then(response => response.json())
            .then(data => {
                if (loadingPlaceholder) {
                    loadingPlaceholder.style.display = 'none';
                }
                
                if (data.templates && data.templates.length > 0) {
                    data.templates.forEach(template => {
                        // Create template card with checkbox for bulk selection
                        const col = document.createElement('div');
                        col.className = 'col-4 col-md-3 mb-2';
                        
                        const card = document.createElement('div');
                        card.className = 'card h-100 bg-dark border-0 shadow-sm';
                        
                        // Add checkbox for bulk selection
                        const checkboxWrapper = document.createElement('div');
                        checkboxWrapper.className = 'form-check position-absolute top-0 start-0 m-1';
                        checkboxWrapper.style.zIndex = '10';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'form-check-input template-checkbox';
                        checkbox.dataset.templatePath = template.path;
                        checkbox.dataset.ceremony = ceremonyType;
                        
                        checkboxWrapper.appendChild(checkbox);
                        
                        // Image container
                        const imgWrapper = document.createElement('div');
                        imgWrapper.className = 'position-relative';
                        
                        const img = document.createElement('img');
                        img.src = template.url;
                        img.className = 'card-img-top';
                        img.alt = template.name;
                        img.style.height = '80px';
                        img.style.objectFit = 'cover';
                        
                        // Add "Main" badge if needed
                        if (template.is_main) {
                            const badge = document.createElement('div');
                            badge.className = 'position-absolute top-0 end-0 m-1';
                            badge.innerHTML = `<span class="badge bg-primary">Main</span>`;
                            imgWrapper.appendChild(badge);
                        }
                        
                        imgWrapper.appendChild(img);
                        
                        // Simple footer with filename (truncated)
                        const cardFooter = document.createElement('div');
                        cardFooter.className = 'p-1 bg-dark text-center';
                        cardFooter.innerHTML = `
                            <small class="text-light text-truncate d-block" style="font-size: 0.7rem;">${template.name.substring(0, 15)}${template.name.length > 15 ? '...' : ''}</small>
                        `;
                        
                        // Assemble card
                        card.appendChild(checkboxWrapper);
                        card.appendChild(imgWrapper);
                        card.appendChild(cardFooter);
                        col.appendChild(card);
                        templateContainer.appendChild(col);
                    });
                } else {
                    // Empty state
                    const emptyMessage = document.createElement('div');
                    emptyMessage.className = 'col-12 text-center small text-muted py-4';
                    emptyMessage.innerHTML = '<p class="mb-0">No templates available</p>';
                    templateContainer.appendChild(emptyMessage);
                }
            })
            .catch(error => {
                if (loadingPlaceholder) {
                    loadingPlaceholder.style.display = 'none';
                }
                
                const errorMessage = document.createElement('div');
                errorMessage.className = 'col-12 text-center text-danger py-3';
                errorMessage.innerHTML = '<p>Error loading templates</p>';
                templateContainer.appendChild(errorMessage);
                
                console.error('Template loading error:', error);
            });
    }
    
    // Refresh button handler
    document.getElementById('refreshTemplates').addEventListener('click', function() {
        const selectedCeremony = document.querySelector('input[name="ceremonyTab"]:checked').value;
        refreshTemplates(selectedCeremony);
    });
    
    // Don't load templates automatically - wait for refresh button click
});
</script>
{% endblock %}