{% extends 'base.html' %}

{% block title %}Bulk Template Upload{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="card bg-dark text-light">
        <div class="card-header bg-primary text-white">
            <h2>Bulk Template Upload</h2>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <p>Upload multiple images for a specific ceremony type. These will be added as Pinterest template options.</p>
                <p>The first image uploaded will be set as the main template for the selected ceremony type.</p>
            </div>

            <form id="uploadForm" enctype="multipart/form-data">
                <div class="mb-3">
                    <label for="ceremonyType" class="form-label">Ceremony Type</label>
                    <select class="form-select" id="ceremonyType" name="ceremony_type" required>
                        <option value="" disabled selected>Select ceremony type</option>
                        <option value="haldi">Haldi</option>
                        <option value="mehendi">Mehendi</option>
                        <option value="sangeeth">Sangeeth</option>
                        <option value="wedding">Wedding</option>
                        <option value="reception">Reception</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="images" class="form-label">Select Images</label>
                    <input type="file" class="form-control" id="images" name="files" multiple accept="image/*" required>
                    <div class="form-text text-light">You can select multiple images at once. Supported formats: JPG, PNG</div>
                </div>

                <div class="mb-3">
                    <button type="submit" class="btn btn-primary">Upload Templates</button>
                </div>
            </form>

            <div id="uploadStatus" class="mt-4" style="display: none;">
                <div class="progress mb-3">
                    <div id="uploadProgress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                </div>
                <div id="statusMessage" class="alert alert-info"></div>
            </div>

            <div id="uploadResult" class="mt-4" style="display: none;">
                <div id="successMessage" class="alert alert-success"></div>
                <div class="text-center mt-3">
                    <a href="/bridal-gallery" class="btn btn-outline-light">View Bridal Gallery</a>
                    <a href="/bridal-swap" class="btn btn-outline-primary">Try Face Swap</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Preview Section -->
    <div class="card bg-dark text-light mt-4">
        <div class="card-header bg-primary text-white">
            <h3>Image Preview</h3>
        </div>
        <div class="card-body">
            <div id="imagePreview" class="row g-3">
                <div class="col-12 text-center text-muted">
                    <p>Selected images will appear here</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadForm = document.getElementById('uploadForm');
    const imageInput = document.getElementById('images');
    const imagePreview = document.getElementById('imagePreview');
    const uploadStatus = document.getElementById('uploadStatus');
    const uploadProgress = document.getElementById('uploadProgress');
    const statusMessage = document.getElementById('statusMessage');
    const uploadResult = document.getElementById('uploadResult');
    const successMessage = document.getElementById('successMessage');

    // Show image previews when files are selected
    imageInput.addEventListener('change', function() {
        imagePreview.innerHTML = '';
        
        if (this.files.length === 0) {
            imagePreview.innerHTML = '<div class="col-12 text-center text-muted"><p>Selected images will appear here</p></div>';
            return;
        }

        for (let i = 0; i < this.files.length; i++) {
            const file = this.files[i];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const col = document.createElement('div');
                col.className = 'col-md-4 col-sm-6';
                
                const card = document.createElement('div');
                card.className = 'card h-100 bg-secondary';
                
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'card-img-top';
                img.alt = 'Preview';
                img.style.height = '200px';
                img.style.objectFit = 'cover';
                
                const cardBody = document.createElement('div');
                cardBody.className = 'card-body';
                
                const fileName = document.createElement('p');
                fileName.className = 'card-text small text-truncate';
                fileName.textContent = file.name;
                
                // Add category selection for each image
                const categoryLabel = document.createElement('label');
                categoryLabel.className = 'form-label mt-2 mb-1';
                categoryLabel.textContent = 'Ceremony Type:';
                
                const categorySelect = document.createElement('select');
                categorySelect.className = 'form-select form-select-sm individual-category';
                categorySelect.dataset.fileName = file.name;
                
                // Add options
                const categories = ['haldi', 'mehendi', 'sangeeth', 'wedding', 'reception'];
                const mainCategory = document.getElementById('ceremonyType').value;
                
                // Create a default option
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Select ceremony';
                categorySelect.appendChild(defaultOption);
                
                // Add ceremony type options
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                    // Pre-select the main category if it's set
                    if (category === mainCategory) {
                        option.selected = true;
                    }
                    categorySelect.appendChild(option);
                });
                
                cardBody.appendChild(fileName);
                cardBody.appendChild(categoryLabel);
                cardBody.appendChild(categorySelect);
                card.appendChild(img);
                card.appendChild(cardBody);
                col.appendChild(card);
                imagePreview.appendChild(col);
            };
            
            reader.readAsDataURL(file);
        }
    });

    // Handle form submission
    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Get all image categories from the preview section
        const individualCategorySelects = document.querySelectorAll('.individual-category');
        const defaultCeremonyType = document.getElementById('ceremonyType').value;
        
        if (!defaultCeremonyType) {
            alert('Please select a default ceremony type');
            return;
        }
        
        if (imageInput.files.length === 0) {
            alert('Please select at least one image');
            return;
        }
        
        // Create a map of file name to ceremony type
        const imageCategories = {};
        individualCategorySelects.forEach(select => {
            const fileName = select.dataset.fileName;
            const category = select.value || defaultCeremonyType; // Fallback to default if not set
            imageCategories[fileName] = category;
        });
        
        // Create customized FormData with category information
        const formData = new FormData();
        formData.append('ceremony_type', defaultCeremonyType);
        
        // Add each file with its category
        for (let i = 0; i < imageInput.files.length; i++) {
            const file = imageInput.files[i];
            const category = imageCategories[file.name] || defaultCeremonyType;
            formData.append('files', file);
            formData.append('file_categories', category);
        }
        
        // Show upload status
        uploadStatus.style.display = 'block';
        uploadResult.style.display = 'none';
        uploadProgress.style.width = '0%';
        statusMessage.textContent = 'Uploading images...';
        statusMessage.className = 'alert alert-info';
        
        // Create a progress animation
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += 5;
            if (progress >= 90) {
                clearInterval(progressInterval);
            }
            uploadProgress.style.width = progress + '%';
        }, 300);
        
        // Submit the form
        fetch('/upload-bulk-templates', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            clearInterval(progressInterval);
            uploadProgress.style.width = '100%';
            
            if (data.success) {
                statusMessage.textContent = 'Upload complete!';
                statusMessage.className = 'alert alert-success';
                
                // Show success message
                uploadResult.style.display = 'block';
                successMessage.innerHTML = `
                    <strong>Success!</strong> Uploaded ${data.uploaded_count} images across ${data.categories_updated.length} 
                    ceremony types: ${data.categories_updated.join(', ')}.
                    ${data.main_template_updated ? '<p>Main templates have been updated.</p>' : ''}
                `;
                
                // Reset form
                uploadForm.reset();
                imagePreview.innerHTML = '<div class="col-12 text-center text-muted"><p>Selected images will appear here</p></div>';
            } else {
                statusMessage.textContent = 'Error: ' + (data.error || 'Unknown error occurred');
                statusMessage.className = 'alert alert-danger';
            }
        })
        .catch(error => {
            clearInterval(progressInterval);
            uploadProgress.style.width = '100%';
            statusMessage.textContent = 'Error: ' + error.message;
            statusMessage.className = 'alert alert-danger';
        });
    });
});
</script>
{% endblock %}