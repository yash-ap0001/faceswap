{% extends 'base.html' %}

{% block title %}Bulk Template Upload{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="card bg-dark text-light">
        <div class="card-header bg-primary text-white">
            <h2>Bulk Template Upload</h2>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <p>Upload multiple images for a specific ceremony type. These will be added as Pinterest template options.</p>
                <p>The first image uploaded will be set as the main template for the selected ceremony type.</p>
            </div>

            <form id="uploadForm" enctype="multipart/form-data">
                <div class="mb-3">
                    <label for="images" class="form-label">Select Images</label>
                    <input type="file" class="form-control" id="images" name="files" multiple accept="image/*" required>
                    <div class="form-text text-light">You can select multiple images at once. Supported formats: JPG, PNG</div>
                    <div id="fileListContainer" class="mt-2"></div>
                </div>

                <div class="card bg-dark mb-4 border border-secondary">
                    <div class="card-header bg-dark">
                        <h5 class="mb-0">Batch Processing Controls</h5>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-end">
                            <div class="col-md-6">
                                <div class="form-group mb-md-0 mb-3">
                                    <label for="ceremonyType" class="form-label">Ceremony Type</label>
                                    <select class="form-select" id="ceremonyType" name="ceremony_type" required>
                                        <option value="" disabled selected>Select ceremony type</option>
                                        <option value="haldi">Haldi</option>
                                        <option value="mehendi">Mehendi</option>
                                        <option value="sangeeth">Sangeeth</option>
                                        <option value="wedding">Wedding</option>
                                        <option value="reception">Reception</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex">
                                    <button type="button" id="selectAll" class="btn btn-outline-light me-2">Select All</button>
                                    <button type="button" id="deselectAll" class="btn btn-outline-secondary me-2">Deselect All</button>
                                    <button type="button" id="uploadSelected" class="btn btn-primary">Upload Selected</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>

            <div id="uploadStatus" class="mt-4" style="display: none;">
                <div class="progress mb-3">
                    <div id="uploadProgress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                </div>
                <div id="statusMessage" class="alert alert-info"></div>
            </div>

            <div id="uploadResult" class="mt-4" style="display: none;">
                <div id="successMessage" class="alert alert-success"></div>
                <div class="text-center mt-3">
                    <a href="/bridal-gallery" class="btn btn-outline-light">View Bridal Gallery</a>
                    <a href="/bridal-swap" class="btn btn-outline-primary">Try Face Swap</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden container for image data processing -->
    <div id="imagePreview" class="d-none"></div>
    
    <!-- Current Templates Section -->
    <div class="card bg-dark text-light mt-4">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
            <h3 class="mb-0">Current Templates</h3>
            <button id="refreshTemplates" class="btn btn-outline-light btn-sm">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
        <div class="card-body">
            <ul class="nav nav-tabs" id="templateTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="haldi-tab" data-bs-toggle="tab" data-bs-target="#haldi" type="button" role="tab">Haldi</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="mehendi-tab" data-bs-toggle="tab" data-bs-target="#mehendi" type="button" role="tab">Mehendi</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="sangeeth-tab" data-bs-toggle="tab" data-bs-target="#sangeeth" type="button" role="tab">Sangeeth</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="wedding-tab" data-bs-toggle="tab" data-bs-target="#wedding" type="button" role="tab">Wedding</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="reception-tab" data-bs-toggle="tab" data-bs-target="#reception" type="button" role="tab">Reception</button>
                </li>
            </ul>
            <div class="tab-content pt-4" id="templateTabContent">
                <div class="tab-pane fade show active" id="haldi" role="tabpanel">
                    <div id="haldi-templates" class="row g-3">
                        <div class="col-12 text-center text-muted loading-placeholder">
                            <p>Loading haldi templates...</p>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="mehendi" role="tabpanel">
                    <div id="mehendi-templates" class="row g-3">
                        <div class="col-12 text-center text-muted loading-placeholder">
                            <p>Loading mehendi templates...</p>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="sangeeth" role="tabpanel">
                    <div id="sangeeth-templates" class="row g-3">
                        <div class="col-12 text-center text-muted loading-placeholder">
                            <p>Loading sangeeth templates...</p>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="wedding" role="tabpanel">
                    <div id="wedding-templates" class="row g-3">
                        <div class="col-12 text-center text-muted loading-placeholder">
                            <p>Loading wedding templates...</p>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="reception" role="tabpanel">
                    <div id="reception-templates" class="row g-3">
                        <div class="col-12 text-center text-muted loading-placeholder">
                            <p>Loading reception templates...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadForm = document.getElementById('uploadForm');
    const imageInput = document.getElementById('images');
    const imagePreview = document.getElementById('imagePreview');
    const uploadStatus = document.getElementById('uploadStatus');
    const uploadProgress = document.getElementById('uploadProgress');
    const statusMessage = document.getElementById('statusMessage');
    const uploadResult = document.getElementById('uploadResult');
    const successMessage = document.getElementById('successMessage');

    // File count display update without previews
    imageInput.addEventListener('change', function() {
        const fileCount = this.files.length;
        const selectAllButton = document.getElementById('selectAll');
        const deselectAllButton = document.getElementById('deselectAll');
        const uploadSelectedButton = document.getElementById('uploadSelected');
        
        // Clear the hidden container
        imagePreview.innerHTML = '';
        
        // Create hidden elements to store file data for processing
        for (let i = 0; i < this.files.length; i++) {
            const file = this.files[i];
            const hiddenElement = document.createElement('div');
            hiddenElement.className = 'd-none';
            hiddenElement.dataset.fileName = file.name;
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'image-checkbox';
            checkbox.checked = true; // Default to checked
            checkbox.dataset.fileName = file.name;
            checkbox.dataset.fileIndex = i;
            
            hiddenElement.appendChild(checkbox);
            imagePreview.appendChild(hiddenElement);
        }
        
        // Update upload button text with file count
        if (fileCount > 0) {
            uploadSelectedButton.textContent = `Upload ${fileCount} File${fileCount !== 1 ? 's' : ''}`;
            uploadSelectedButton.className = 'btn btn-primary';
            selectAllButton.disabled = false;
            deselectAllButton.disabled = false;
        } else {
            uploadSelectedButton.textContent = 'Upload Selected';
            uploadSelectedButton.className = 'btn btn-primary disabled';
            selectAllButton.disabled = true;
            deselectAllButton.disabled = true;
        }
        
        // Add file count display to form
        const fileListContainer = document.getElementById('fileListContainer');
        if (fileListContainer) {
            fileListContainer.innerHTML = '';
            
            if (fileCount > 0) {
                const fileListElement = document.createElement('div');
                fileListElement.className = 'alert alert-info mt-3';
                fileListElement.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="fas fa-file-image me-2"></i>
                        <div>
                            <strong>${fileCount} file${fileCount !== 1 ? 's' : ''} selected</strong>
                            <div class="small text-muted">All files will be uploaded to the selected ceremony type</div>
                        </div>
                    </div>
                `;
                fileListContainer.appendChild(fileListElement);
            }
        }
    });

    // Event listeners for select/deselect buttons
    const selectAllButton = document.getElementById('selectAll');
    const deselectAllButton = document.getElementById('deselectAll');
    const uploadSelectedButton = document.getElementById('uploadSelected');
    
    // Select all images
    selectAllButton.addEventListener('click', function() {
        const checkboxes = document.querySelectorAll('.image-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = true;
        });
    });
    
    // Deselect all images
    deselectAllButton.addEventListener('click', function() {
        const checkboxes = document.querySelectorAll('.image-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
    });
    
    // Function to handle uploading checked images
    function uploadCheckedImages() {
        // Get selected ceremony type
        const ceremonyType = document.getElementById('ceremonyType').value;
        
        if (!ceremonyType) {
            alert('Please select a ceremony type');
            return;
        }
        
        // Get all checked images
        const checkedBoxes = document.querySelectorAll('.image-checkbox:checked');
        
        if (checkedBoxes.length === 0) {
            alert('Please select at least one image');
            return;
        }
        
        // Disable form elements during upload
        const uploadButton = document.getElementById('uploadSelected');
        const selectAllButton = document.getElementById('selectAll');
        const deselectAllButton = document.getElementById('deselectAll');
        const ceremonySelect = document.getElementById('ceremonyType');
        
        uploadButton.disabled = true;
        selectAllButton.disabled = true;
        deselectAllButton.disabled = true;
        ceremonySelect.disabled = true;
        imageInput.disabled = true;
        
        // Create FormData for upload
        const formData = new FormData();
        formData.append('ceremony_type', ceremonyType);
        
        // Keep track of which files are being uploaded
        const uploadingFileNames = [];
        
        // Find the corresponding files from the input
        Array.from(imageInput.files).forEach(file => {
            // Check if this file is selected
            const isSelected = Array.from(checkedBoxes).some(
                checkbox => checkbox.dataset.fileName === file.name
            );
            
            if (isSelected) {
                formData.append('files', file);
                formData.append('file_categories', ceremonyType);
                uploadingFileNames.push(file.name);
            }
        });
        
        // Show upload status
        uploadStatus.style.display = 'block';
        uploadResult.style.display = 'none';
        uploadProgress.style.width = '0%';
        statusMessage.textContent = `Uploading ${uploadingFileNames.length} image${uploadingFileNames.length !== 1 ? 's' : ''} to ${ceremonyType}...`;
        statusMessage.className = 'alert alert-info';
        
        // Create a progress animation
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += 5;
            if (progress >= 90) {
                clearInterval(progressInterval);
            }
            uploadProgress.style.width = progress + '%';
        }, 300);
        
        // Submit the form
        fetch('/upload-bulk-templates', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            clearInterval(progressInterval);
            uploadProgress.style.width = '100%';
            
            // Re-enable form elements
            uploadButton.disabled = false;
            selectAllButton.disabled = false;
            deselectAllButton.disabled = false;
            ceremonySelect.disabled = false;
            imageInput.disabled = false;
            
            if (data.success) {
                statusMessage.textContent = 'Upload complete!';
                statusMessage.className = 'alert alert-success';
                
                // Show success message
                uploadResult.style.display = 'block';
                successMessage.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="fas fa-check-circle text-success me-2" style="font-size: 1.5rem;"></i>
                        <div>
                            <strong>Successfully uploaded ${data.uploaded_count || uploadingFileNames.length} template${(data.uploaded_count || uploadingFileNames.length) !== 1 ? 's' : ''}</strong>
                            <div>Templates are now available in the ${ceremonyType} ceremony gallery</div>
                        </div>
                    </div>
                `;
                
                // Reset the file input and hidden container
                imageInput.value = '';
                imagePreview.innerHTML = '';
                
                // Update the file list container
                const fileListContainer = document.getElementById('fileListContainer');
                if (fileListContainer) {
                    fileListContainer.innerHTML = '';
                }
                
                // Reset the upload button text
                uploadButton.textContent = 'Upload Selected';
                uploadButton.className = 'btn btn-primary disabled';
                
                // Refresh the templates for this ceremony type
                refreshTemplatesAfterUpload(ceremonyType);
                
                // Enhanced refresh mechanism to trigger updates on other pages
                const timestamp = Date.now().toString();
                console.log(`Templates updated for ${ceremonyType} at ${timestamp}`);
                
                // 1. Set the refresh flag for any page listening
                localStorage.setItem('refreshTemplates', 'true');
                
                // 2. Store which ceremony was updated
                localStorage.setItem('lastUpdatedCeremony', ceremonyType);
                
                // 3. Store the update timestamp to avoid duplicate refreshes
                localStorage.setItem('updateTimestamp', timestamp);
                
                // 4. Add debugging information
                console.log({
                    message: 'Template update notification saved to localStorage',
                    ceremony: ceremonyType,
                    timestamp: timestamp,
                    currentLastProcessed: localStorage.getItem('lastProcessedTimestamp') || 'none'
                });
            } else {
                statusMessage.textContent = 'Error: ' + (data.error || 'Unknown error occurred');
                statusMessage.className = 'alert alert-danger';
            }
        })
        .catch(error => {
            clearInterval(progressInterval);
            uploadProgress.style.width = '100%';
            statusMessage.textContent = 'Error: ' + error.message;
            statusMessage.className = 'alert alert-danger';
            
            // Re-enable form elements on error
            uploadButton.disabled = false;
            selectAllButton.disabled = false;
            deselectAllButton.disabled = false;
            ceremonySelect.disabled = false;
            imageInput.disabled = false;
        });
    }
    
    // Upload selected images button
    uploadSelectedButton.addEventListener('click', uploadCheckedImages);
    
    // Original form submission (now just delegated to the upload function)
    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        uploadCheckedImages();
    });
    
    // Function to load templates for a specific ceremony type
    function loadTemplates(ceremonyType) {
        const templateContainer = document.getElementById(`${ceremonyType}-templates`);
        
        // Display loading state
        templateContainer.innerHTML = '<div class="col-12 text-center"><div class="spinner-border text-light" role="status"><span class="visually-hidden">Loading...</span></div></div>';
        
        // Fetch templates for this ceremony type with cache busting
        const timestamp = Date.now();
        fetch(`/api/templates?ceremony_type=${ceremonyType}&_t=${timestamp}`)
            .then(response => response.json())
            .then(data => {
                if (data.templates && data.templates.length > 0) {
                    // Clear loading state
                    templateContainer.innerHTML = '';
                    
                    // Add each template
                    data.templates.forEach(template => {
                        const col = document.createElement('div');
                        col.className = 'col-md-3 col-sm-6 mb-4';
                        
                        const card = document.createElement('div');
                        card.className = 'card h-100 bg-secondary';
                        
                        const img = document.createElement('img');
                        img.src = template.url;
                        img.className = 'card-img-top';
                        img.alt = 'Template';
                        img.style.height = '180px';
                        img.style.objectFit = 'cover';
                        
                        const cardBody = document.createElement('div');
                        cardBody.className = 'card-body p-2';
                        
                        const typeLabel = document.createElement('p');
                        typeLabel.className = 'card-text small mb-0';
                        typeLabel.textContent = template.template_type || 'pinterest';
                        
                        const dateAdded = document.createElement('small');
                        dateAdded.className = 'text-muted';
                        dateAdded.textContent = 'Recently Added';
                        
                        cardBody.appendChild(typeLabel);
                        cardBody.appendChild(dateAdded);
                        card.appendChild(img);
                        card.appendChild(cardBody);
                        col.appendChild(card);
                        
                        templateContainer.appendChild(col);
                    });
                } else {
                    // No templates found
                    templateContainer.innerHTML = `<div class="col-12 text-center text-muted"><p>No ${ceremonyType} templates found</p></div>`;
                }
            })
            .catch(error => {
                console.error('Error loading templates:', error);
                templateContainer.innerHTML = `<div class="col-12 text-center text-danger"><p>Error loading templates: ${error.message}</p></div>`;
            });
    }
    
    // Load all ceremony type templates initially
    function loadAllTemplates() {
        const ceremonyTypes = ['haldi', 'mehendi', 'sangeeth', 'wedding', 'reception'];
        ceremonyTypes.forEach(type => loadTemplates(type));
    }
    
    // Refresh button functionality
    const refreshButton = document.getElementById('refreshTemplates');
    refreshButton.addEventListener('click', loadAllTemplates);
    
    // Auto-refresh templates after successful upload
    function refreshTemplatesAfterUpload(ceremonyType) {
        // Set a unique timestamp for this update
        const updateTime = Date.now().toString();
        localStorage.setItem('updateTimestamp', updateTime);
        
        // Set flags for cross-page communication
        localStorage.setItem('refreshTemplates', 'true');
        localStorage.setItem('lastUpdatedCeremony', ceremonyType);
        
        console.log(`Setting refresh flag for ${ceremonyType} templates with timestamp ${updateTime}`);
        
        // Small delay to ensure server has processed the images
        setTimeout(() => {
            // Use cache-busting for template refresh
            const timestamp = Date.now();
            fetch(`/api/templates?ceremony_type=${ceremonyType}&_t=${timestamp}`)
                .then(response => response.json())
                .then(data => {
                    if (data.templates) {
                        console.log(`Refreshed ${ceremonyType} templates, found ${data.templates.length} templates`);
                        loadTemplates(ceremonyType);
                        
                        // Activate the tab for the ceremony type that was just updated
                        const tabToActivate = document.getElementById(`${ceremonyType}-tab`);
                        if (tabToActivate) {
                            const tab = new bootstrap.Tab(tabToActivate);
                            tab.show();
                        }
                    }
                })
                .catch(error => {
                    console.error('Error refreshing templates:', error);
                });
        }, 1000);
    }
    
    // Update the success handler to refresh templates
    const originalFetchHandler = fetch;
    
    // Load templates when the page loads
    document.addEventListener('DOMContentLoaded', loadAllTemplates);
});
</script>
{% endblock %}