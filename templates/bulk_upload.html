{% extends 'base.html' %}

{% block title %}Template Management{% endblock %}

{% block content %}
<div class="container mt-4">
    <h4 class="mb-4 text-center">Template Management</h4>
    
    <div class="row g-4">
        <!-- Upload Section -->
        <div class="col-lg-6">
            <div class="bg-dark p-4 rounded shadow-sm border-0">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="m-0">Upload Templates</h5>
                </div>
                
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="images" class="form-label small">Select Images</label>
                        <input type="file" class="form-control form-control-sm bg-dark text-light border-secondary" id="images" name="files" multiple accept="image/*" required>
                        <div class="form-text text-muted small mt-1">First image becomes main template</div>
                        <div id="fileListContainer" class="mt-2"></div>
                    </div>

                    <div class="mb-3">
                        <label for="categoryType" class="form-label small">Category Type</label>
                        <select class="form-select form-select-sm bg-dark text-light border-secondary" id="categoryType" name="category_type" required>
                            <option value="" disabled selected>Select category type</option>
                            <option value="bride">Bride</option>
                            <option value="groom">Groom</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="subcategory" class="form-label small">Subcategory</label>
                        <select class="form-select form-select-sm bg-dark text-light border-secondary" id="subcategory" name="subcategory" required disabled>
                            <option value="" disabled selected>Select subcategory</option>
                            <!-- Options will be populated via JavaScript -->
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="itemCategory" class="form-label small">Item Category</label>
                        <select class="form-select form-select-sm bg-dark text-light border-secondary" id="itemCategory" name="item_category" required disabled>
                            <option value="" disabled selected>Select item category</option>
                            <!-- Options will be populated via JavaScript -->
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <button type="button" id="uploadSelected" class="btn btn-sm btn-primary w-100">Upload</button>
                    </div>
                </form>
                
                <div id="uploadStatus" class="my-3" style="display: none;">
                    <div class="progress" style="height: 4px;">
                        <div id="uploadProgress" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div id="statusMessage" class="mt-2 small text-light"></div>
                </div>

                <div id="uploadResult" class="my-3" style="display: none;">
                    <div id="successMessage" class="p-2 rounded bg-success bg-opacity-10 text-success small"></div>
                </div>
            </div>
        </div>
        
        <!-- Template Management -->
        <div class="col-lg-6">
            <div class="bg-dark p-4 rounded shadow-sm border-0">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="m-0">Manage Templates</h5>
                    <div class="d-flex gap-2">
                        <button id="selectAllTemplates" class="btn btn-sm btn-outline-secondary px-2">
                            <i class="fas fa-check-square me-1"></i>Select All
                        </button>
                        <button id="deleteSelected" class="btn btn-sm btn-danger px-2">
                            <i class="fas fa-trash-alt me-1"></i>Delete
                        </button>
                        <button id="clearAllTemplatesBtn" class="btn btn-sm btn-outline-danger px-2">
                            <i class="fas fa-trash me-1"></i>Clear All
                        </button>
                        <button id="refreshTemplates" class="btn btn-sm btn-outline-light px-2">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                
                <div id="deleteStatus" class="mb-3" style="display: none;">
                    <div class="progress" style="height: 4px;">
                        <div id="deleteProgress" class="progress-bar progress-bar-striped progress-bar-animated bg-danger" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div id="deleteStatusMessage" class="mt-2 small text-light"></div>
                </div>
                
                <!-- Category selection for deletion -->
                <div class="mb-3">
                    <select class="form-select form-select-sm bg-dark text-light border-secondary" id="deleteCategoryType">
                        <option value="bride" selected>Bride</option>
                        <option value="groom">Groom</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <select class="form-select form-select-sm bg-dark text-light border-secondary" id="deleteSubcategory">
                        <option value="bridal" selected>Bridal Ceremonies</option>
                        <option value="outfits">Modern Outfits</option>
                        <option value="jewelry">Jewelry</option>
                        <option value="makeup">Makeup</option>
                    </select>
                </div>
                
                <!-- Bridal ceremony tabs (shown only for bride/bridal) -->
                <div id="bridalCeremonyTabs" class="btn-group w-100 mb-3" role="group" aria-label="Ceremony selection">
                    <input type="radio" class="btn-check" name="ceremonyTab" id="haldi-tab-radio" value="haldi" checked>
                    <label class="btn btn-outline-secondary btn-sm" for="haldi-tab-radio">Haldi</label>
                    
                    <input type="radio" class="btn-check" name="ceremonyTab" id="mehendi-tab-radio" value="mehendi">
                    <label class="btn btn-outline-secondary btn-sm" for="mehendi-tab-radio">Mehendi</label>
                    
                    <input type="radio" class="btn-check" name="ceremonyTab" id="sangeeth-tab-radio" value="sangeeth">
                    <label class="btn btn-outline-secondary btn-sm" for="sangeeth-tab-radio">Sangeeth</label>
                    
                    <input type="radio" class="btn-check" name="ceremonyTab" id="wedding-tab-radio" value="wedding">
                    <label class="btn btn-outline-secondary btn-sm" for="wedding-tab-radio">Wedding</label>
                    
                    <input type="radio" class="btn-check" name="ceremonyTab" id="reception-tab-radio" value="reception">
                    <label class="btn btn-outline-secondary btn-sm" for="reception-tab-radio">Reception</label>
                </div>
                
                <!-- Non-bridal category selector -->
                <div id="otherCategoriesList" class="mb-3" style="display: none;">
                    <select class="form-select form-select-sm bg-dark text-light border-secondary" id="deleteItemCategory">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                
                <div class="tab-content" id="deleteTabContent">
                    <div class="tab-pane fade show active" id="haldi-delete" role="tabpanel">
                        <div id="haldi-templates" class="row g-2 template-container">
                            <div class="col-12 text-center loading-placeholder py-4">
                                <div class="spinner-border spinner-border-sm text-secondary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="mehendi-delete" role="tabpanel">
                        <div id="mehendi-templates" class="row g-2 template-container">
                            <div class="col-12 text-center loading-placeholder py-4">
                                <div class="spinner-border spinner-border-sm text-secondary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="sangeeth-delete" role="tabpanel">
                        <div id="sangeeth-templates" class="row g-2 template-container">
                            <div class="col-12 text-center loading-placeholder py-4">
                                <div class="spinner-border spinner-border-sm text-secondary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="wedding-delete" role="tabpanel">
                        <div id="wedding-templates" class="row g-2 template-container">
                            <div class="col-12 text-center loading-placeholder py-4">
                                <div class="spinner-border spinner-border-sm text-secondary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="reception-delete" role="tabpanel">
                        <div id="reception-templates" class="row g-2 template-container">
                            <div class="col-12 text-center loading-placeholder py-4">
                                <div class="spinner-border spinner-border-sm text-secondary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden container for image data processing -->
    <div id="imagePreview" class="d-none"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize key UI elements
    const uploadForm = document.getElementById('uploadForm');
    const imageInput = document.getElementById('images');
    const imagePreview = document.getElementById('imagePreview');
    const uploadStatus = document.getElementById('uploadStatus');
    const uploadProgress = document.getElementById('uploadProgress');
    const statusMessage = document.getElementById('statusMessage');
    const uploadResult = document.getElementById('uploadResult');
    const successMessage = document.getElementById('successMessage');
    const deleteButton = document.getElementById('deleteSelected');
    const deleteStatus = document.getElementById('deleteStatus');
    const deleteProgress = document.getElementById('deleteProgress');
    const deleteStatusMessage = document.getElementById('deleteStatusMessage');
    const selectAllTemplatesButton = document.getElementById('selectAllTemplates');
    
    // File input change handler - show count without previews
    imageInput.addEventListener('change', function() {
        const fileCount = this.files.length;
        const uploadSelectedButton = document.getElementById('uploadSelected');
        
        // Clear previous data
        imagePreview.innerHTML = '';
        
        // Create hidden elements for files (all selected by default)
        for (let i = 0; i < this.files.length; i++) {
            const file = this.files[i];
            const hiddenElement = document.createElement('div');
            hiddenElement.className = 'd-none';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'image-checkbox';
            checkbox.checked = true; // All files are selected by default
            checkbox.dataset.fileName = file.name;
            checkbox.dataset.fileIndex = i;
            
            hiddenElement.appendChild(checkbox);
            imagePreview.appendChild(hiddenElement);
        }
        
        // Update button state based on file count
        if (fileCount > 0) {
            uploadSelectedButton.textContent = `Upload (${fileCount})`;
            uploadSelectedButton.disabled = false;
        } else {
            uploadSelectedButton.textContent = 'Upload';
            uploadSelectedButton.disabled = true;
        }
        
        // Show file count indicator
        const fileListContainer = document.getElementById('fileListContainer');
        if (fileListContainer && fileCount > 0) {
            fileListContainer.innerHTML = '';
            
            const fileCountBadge = document.createElement('div');
            fileCountBadge.className = 'd-inline-block py-1 px-2 mt-1 rounded bg-dark border border-secondary';
            fileCountBadge.innerHTML = `
                <small>
                    <i class="fas fa-image text-primary me-1"></i>
                    <span class="text-light">${fileCount} file${fileCount !== 1 ? 's' : ''} selected</span>
                </small>
            `;
            fileListContainer.appendChild(fileCountBadge);
        } else if (fileListContainer) {
            fileListContainer.innerHTML = '';
        }
    });

    // Get upload button
    const uploadSelectedButton = document.getElementById('uploadSelected');
    
    // Upload handler function
    // Category structure for populating dropdowns
    const categories = {{ categories|tojson }};
    
    // Setup category selection chain
    const categoryTypeSelect = document.getElementById('categoryType');
    const subcategorySelect = document.getElementById('subcategory');
    const itemCategorySelect = document.getElementById('itemCategory');
    
    // When category type changes, update subcategory options
    categoryTypeSelect.addEventListener('change', function() {
        const selectedType = this.value;
        
        // Clear and disable item category
        itemCategorySelect.innerHTML = '<option value="" disabled selected>Select item category</option>';
        itemCategorySelect.disabled = true;
        
        // Update subcategory options
        subcategorySelect.innerHTML = '<option value="" disabled selected>Select subcategory</option>';
        
        if (selectedType && categories[selectedType]) {
            // Add subcategory options
            Object.keys(categories[selectedType]).forEach(subcategory => {
                const option = document.createElement('option');
                option.value = subcategory;
                option.textContent = subcategory.charAt(0).toUpperCase() + subcategory.slice(1).replace('_', ' ');
                subcategorySelect.appendChild(option);
            });
            
            // Enable subcategory select
            subcategorySelect.disabled = false;
        } else {
            subcategorySelect.disabled = true;
        }
    });
    
    // When subcategory changes, update item category options
    subcategorySelect.addEventListener('change', function() {
        const selectedType = categoryTypeSelect.value;
        const selectedSubcategory = this.value;
        
        // Update item category options
        itemCategorySelect.innerHTML = '<option value="" disabled selected>Select item category</option>';
        
        if (selectedType && selectedSubcategory && 
            categories[selectedType] && 
            categories[selectedType][selectedSubcategory]) {
            
            // Add item category options
            categories[selectedType][selectedSubcategory].forEach(itemCategory => {
                const option = document.createElement('option');
                option.value = itemCategory;
                option.textContent = itemCategory.charAt(0).toUpperCase() + itemCategory.slice(1).replace('_', ' ');
                itemCategorySelect.appendChild(option);
            });
            
            // Enable item category select
            itemCategorySelect.disabled = false;
        } else {
            itemCategorySelect.disabled = true;
        }
    });
    
    function uploadCheckedImages() {
        // Get values from all three dropdowns
        const categoryType = document.getElementById('categoryType').value;
        const subcategory = document.getElementById('subcategory').value;
        const itemCategory = document.getElementById('itemCategory').value;
        
        // Validate all selections are made
        if (!categoryType || !subcategory || !itemCategory) {
            alert('Please select all category options');
            return;
        }
        
        const checkedBoxes = document.querySelectorAll('.image-checkbox:checked');
        
        if (checkedBoxes.length === 0) {
            alert('Please select at least one image');
            return;
        }
        
        // Disable form controls during upload
        uploadSelectedButton.disabled = true;
        categoryTypeSelect.disabled = true;
        subcategorySelect.disabled = true;
        itemCategorySelect.disabled = true;
        imageInput.disabled = true;
        
        // Prepare form data
        const formData = new FormData();
        formData.append('category_type', categoryType);
        formData.append('subcategory', subcategory);
        formData.append('item_category', itemCategory);
        
        // Find selected files
        const uploadingFileNames = [];
        Array.from(imageInput.files).forEach(file => {
            const isSelected = Array.from(checkedBoxes).some(
                checkbox => checkbox.dataset.fileName === file.name
            );
            
            if (isSelected) {
                formData.append('files', file);
                uploadingFileNames.push(file.name);
            }
        });
        
        // Show upload progress
        uploadStatus.style.display = 'block';
        uploadResult.style.display = 'none';
        uploadProgress.style.width = '0%';
        statusMessage.textContent = `Uploading ${uploadingFileNames.length} file${uploadingFileNames.length !== 1 ? 's' : ''} to ${categoryType}/${subcategory}/${itemCategory}...`;
        
        // Animated progress bar
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += 5;
            if (progress >= 90) clearInterval(progressInterval);
            uploadProgress.style.width = progress + '%';
        }, 200);
        
        // Upload API call
        fetch('/upload-bulk-templates', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            clearInterval(progressInterval);
            uploadProgress.style.width = '100%';
            
            // Re-enable form controls
            uploadSelectedButton.disabled = false;
            categoryTypeSelect.disabled = false;
            subcategorySelect.disabled = false;
            itemCategorySelect.disabled = false;
            imageInput.disabled = false;
            
            if (data.success) {
                statusMessage.textContent = 'Upload complete!';
                
                // Show success message
                uploadResult.style.display = 'block';
                successMessage.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <div>
                            <strong>Uploaded ${data.uploaded_count || uploadingFileNames.length} file${(data.uploaded_count || uploadingFileNames.length) !== 1 ? 's' : ''}</strong>
                            <div class="text-muted small">Category: ${categoryType}/${subcategory}/${itemCategory}</div>
                        </div>
                    </div>
                `;
                
                // Reset form
                imageInput.value = '';
                imagePreview.innerHTML = '';
                document.getElementById('fileListContainer').innerHTML = '';
                uploadSelectedButton.textContent = 'Upload';
                uploadSelectedButton.disabled = true;
                
                // Only refresh ceremony tabs for bridal categories
                if (categoryType === 'bride' && subcategory === 'bridal') {
                    // Refresh the template display
                    refreshTemplates(itemCategory);
                    
                    // Select the corresponding tab
                    const ceremonyTab = document.querySelector(`input[name="ceremonyTab"][value="${itemCategory}"]`);
                    if (ceremonyTab) {
                        ceremonyTab.checked = true;
                    }
                }
                
                // Only show bridal tab content if we're uploading to bridal ceremonies
                if (categoryType === 'bride' && subcategory === 'bridal') {
                    // Update tab display
                    document.querySelectorAll('.tab-pane').forEach(tab => {
                        tab.classList.remove('show', 'active');
                    });
                    
                    const tabContent = document.getElementById(`${itemCategory}-delete`);
                    if (tabContent) {
                        tabContent.classList.add('show', 'active');
                    }
                }
                
                // Set localStorage flags for cross-page notifications
                const timestamp = Date.now().toString();
                localStorage.setItem('refreshTemplates', 'true');
                localStorage.setItem('lastUpdatedCeremony', itemCategory);
                localStorage.setItem('updateTimestamp', timestamp);
                
                // Hide upload status after delay
                setTimeout(() => {
                    uploadStatus.style.display = 'none';
                }, 3000);
            } else {
                statusMessage.textContent = 'Error: ' + (data.error || 'Unknown error occurred');
            }
        })
        .catch(error => {
            clearInterval(progressInterval);
            uploadProgress.style.width = '100%';
            statusMessage.textContent = 'Error: ' + error.message;
            
            // Re-enable form controls on error
            uploadSelectedButton.disabled = false;
            categoryTypeSelect.disabled = false;
            subcategorySelect.disabled = false;
            itemCategorySelect.disabled = false;
            imageInput.disabled = false;
        });
    }
    
    // Button and form submit handlers
    uploadSelectedButton.addEventListener('click', uploadCheckedImages);
    uploadForm.addEventListener('submit', (e) => {
        e.preventDefault();
        uploadCheckedImages();
    });
    
    // Set up ceremony tab radio buttons
    const ceremonyRadios = document.querySelectorAll('input[name="ceremonyTab"]');
    ceremonyRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.checked) {
                const ceremony = this.value;
                
                // Update tab visibility
                document.querySelectorAll('.tab-pane').forEach(tab => {
                    tab.classList.remove('show', 'active');
                });
                
                const tabPane = document.getElementById(`${ceremony}-delete`);
                if (tabPane) {
                    tabPane.classList.add('show', 'active');
                }
                
                // Don't automatically load templates for this ceremony type
                // Templates will be loaded when user clicks refresh button
            }
        });
    });
    
    // Template deletion functionality
    function deleteSelectedTemplates() {
        const checkedTemplates = document.querySelectorAll('.template-checkbox:checked');
        
        if (checkedTemplates.length === 0) {
            alert('Please select at least one template to delete');
            return;
        }
        
        if (!confirm(`Delete ${checkedTemplates.length} selected template${checkedTemplates.length !== 1 ? 's' : ''}?`)) {
            return;
        }
        
        // Get category information for refreshing later
        const categoryType = document.getElementById('deleteCategoryType').value;
        const subcategory = document.getElementById('deleteSubcategory').value;
        let itemCategory;
        
        if (categoryType === 'bride' && subcategory === 'bridal') {
            itemCategory = document.querySelector('input[name="ceremonyTab"]:checked').value;
        } else {
            itemCategory = document.getElementById('deleteItemCategory').value;
        }
        
        // Collect template paths to delete
        const templatePaths = Array.from(checkedTemplates).map(checkbox => checkbox.dataset.templatePath);
        
        // Disable delete button during operation
        deleteButton.disabled = true;
        
        // Show delete progress UI
        deleteStatus.style.display = 'block';
        deleteProgress.style.width = '0%';
        deleteStatusMessage.textContent = `Deleting ${templatePaths.length} template${templatePaths.length !== 1 ? 's' : ''}...`;
        
        // Animated progress
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += 10;
            if (progress >= 90) clearInterval(progressInterval);
            deleteProgress.style.width = progress + '%';
        }, 150);
        
        // Delete API call
        fetch('/delete-templates', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ template_paths: templatePaths })
        })
        .then(response => response.json())
        .then(data => {
            clearInterval(progressInterval);
            deleteProgress.style.width = '100%';
            deleteButton.disabled = false;
            
            if (data.success) {
                deleteStatusMessage.textContent = `Successfully deleted ${templatePaths.length} template${templatePaths.length !== 1 ? 's' : ''}`;
                
                // Refresh templates
                refreshTemplates(itemCategory);
                
                // Notify other pages
                const timestamp = Date.now().toString();
                localStorage.setItem('refreshTemplates', 'true');
                localStorage.setItem('lastUpdatedCeremony', itemCategory);
                localStorage.setItem('updateTimestamp', timestamp);
                
                // Hide status after delay
                setTimeout(() => {
                    deleteStatus.style.display = 'none';
                }, 3000);
            } else {
                deleteStatusMessage.textContent = 'Error: ' + (data.error || 'Failed to delete templates');
            }
        })
        .catch(error => {
            clearInterval(progressInterval);
            deleteProgress.style.width = '100%';
            deleteStatusMessage.textContent = 'Error: ' + error.message;
            deleteButton.disabled = false;
        });
    }
    
    // Delete button handler
    deleteButton.addEventListener('click', deleteSelectedTemplates);
    
    // Select all templates for deletion
    selectAllTemplatesButton.addEventListener('click', function() {
        // Get category information
        const categoryType = document.getElementById('deleteCategoryType').value;
        const subcategory = document.getElementById('deleteSubcategory').value;
        
        let templateCheckboxes;
        
        if (categoryType === 'bride' && subcategory === 'bridal') {
            // For bridal ceremonies, use data-ceremony attribute
            const currentCeremony = document.querySelector('input[name="ceremonyTab"]:checked').value;
            templateCheckboxes = document.querySelectorAll(`.template-checkbox[data-ceremony="${currentCeremony}"]`);
        } else {
            // For other categories, select all visible template checkboxes in the dynamic container
            const dynamicContainer = document.getElementById('dynamic-templates-container');
            if (dynamicContainer) {
                templateCheckboxes = dynamicContainer.querySelectorAll('.template-checkbox');
            } else {
                // If no dynamic container, get any visible template checkboxes
                templateCheckboxes = document.querySelectorAll('.template-checkbox:not([style*="display: none"])');
            }
        }
        
        if (templateCheckboxes && templateCheckboxes.length > 0) {
            templateCheckboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
        } else {
            console.log('No template checkboxes found to select');
        }
    });
    
    // Template refresh functionality
    function refreshTemplates(itemCategory) {
        // Get category information
        const categoryType = document.getElementById('deleteCategoryType').value;
        const subcategory = document.getElementById('deleteSubcategory').value;
        
        // Get item category from selected tab if not provided
        if (!itemCategory) {
            if (categoryType === 'bride' && subcategory === 'bridal') {
                itemCategory = document.querySelector('input[name="ceremonyTab"]:checked').value;
            } else {
                itemCategory = document.getElementById('deleteItemCategory').value;
            }
        }
        
        // For bridal ceremonies, use existing template containers
        let templateContainer;
        if (categoryType === 'bride' && subcategory === 'bridal') {
            templateContainer = document.getElementById(`${itemCategory}-templates`);
        } else {
            // For other categories, we'll need to create a container dynamically
            // First, get the parent tab-pane for non-bridal templates
            const tabContent = document.getElementById('deleteTabContent');
            
            // Clear any existing dynamic template containers
            const existingDynamic = document.getElementById('dynamic-templates-container');
            if (existingDynamic) {
                existingDynamic.remove();
            }
            
            // Create a new dynamic template container
            templateContainer = document.createElement('div');
            templateContainer.id = 'dynamic-templates-container';
            templateContainer.className = 'row g-2 template-container';
            
            // Add loading placeholder
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'col-12 text-center loading-placeholder py-4';
            loadingDiv.innerHTML = `
                <div class="spinner-border spinner-border-sm text-secondary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            `;
            templateContainer.appendChild(loadingDiv);
            
            // Show the dynamic container by making it the only visible one
            document.querySelectorAll('.tab-pane').forEach(tab => {
                tab.classList.remove('show', 'active');
            });
            
            // Create a new tab-pane for the dynamic content
            const newTabPane = document.createElement('div');
            newTabPane.className = 'tab-pane fade show active';
            newTabPane.id = 'dynamic-tab-pane';
            newTabPane.appendChild(templateContainer);
            
            // Add it to the tab content
            tabContent.appendChild(newTabPane);
        }
        
        if (!templateContainer) return;
        
        const loadingPlaceholder = templateContainer.querySelector('.loading-placeholder');
        if (loadingPlaceholder) {
            loadingPlaceholder.style.display = 'block';
        }
        
        // Remove existing template cards
        Array.from(templateContainer.children).forEach(child => {
            if (!child.classList.contains('loading-placeholder')) {
                child.remove();
            }
        });
        
        // Construct appropriate API URL
        let apiUrl;
        if (categoryType === 'bride' && subcategory === 'bridal') {
            apiUrl = `/api/templates?ceremony_type=${itemCategory}`;
        } else {
            apiUrl = `/api/templates?category_type=${categoryType}&subcategory=${subcategory}&item_category=${itemCategory}`;
        }
        
        // Fetch templates from API
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                if (loadingPlaceholder) {
                    loadingPlaceholder.style.display = 'none';
                }
                
                if (data.templates && data.templates.length > 0) {
                    data.templates.forEach(template => {
                        try {
                            // Get a safe filename for display
                            let displayName = 'Template';
                            
                            if (template.path) {
                                const pathParts = template.path.split('/');
                                if (pathParts.length > 0) {
                                    displayName = pathParts[pathParts.length - 1] || 'Template';
                                }
                            }
                            
                            // Create template card with checkbox for bulk selection
                            const col = document.createElement('div');
                            col.className = 'col-4 col-md-3 mb-2';
                            
                            const card = document.createElement('div');
                            card.className = 'card h-100 bg-dark border-0 shadow-sm';
                            
                            // Add checkbox for bulk selection
                            const checkboxWrapper = document.createElement('div');
                            checkboxWrapper.className = 'form-check position-absolute top-0 start-0 m-1';
                            checkboxWrapper.style.zIndex = '10';
                            
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.className = 'form-check-input template-checkbox';
                            checkbox.dataset.templatePath = template.path || '';
                            checkbox.dataset.ceremony = itemCategory;
                            
                            checkboxWrapper.appendChild(checkbox);
                            
                            // Image container
                            const imgWrapper = document.createElement('div');
                            imgWrapper.className = 'position-relative';
                            
                            const img = document.createElement('img');
                            img.src = template.url || '';
                            img.className = 'card-img-top';
                            img.alt = displayName;
                            img.style.height = '80px';
                            img.style.objectFit = 'cover';
                            
                            // Add "Main" badge if needed
                            if (template.is_main) {
                                const badge = document.createElement('div');
                                badge.className = 'position-absolute top-0 end-0 m-1';
                                badge.innerHTML = '<span class="badge bg-primary">Main</span>';
                                imgWrapper.appendChild(badge);
                            }
                            
                            imgWrapper.appendChild(img);
                            
                            // Simple footer with filename (truncated)
                            const cardFooter = document.createElement('div');
                            cardFooter.className = 'p-1 bg-dark text-center';
                            
                            // Truncate filename if needed
                            let truncatedName = displayName;
                            if (displayName && displayName.length > 15) {
                                truncatedName = displayName.substring(0, 15) + '...';
                            }
                            
                            cardFooter.innerHTML = '<small class="text-light text-truncate d-block" style="font-size: 0.7rem;">'
                                + truncatedName + '</small>';
                            
                            // Assemble card
                            card.appendChild(checkboxWrapper);
                            card.appendChild(imgWrapper);
                            card.appendChild(cardFooter);
                            col.appendChild(card);
                            templateContainer.appendChild(col);
                        } catch (err) {
                            console.error('Error creating template card:', err);
                        }
                    });
                } else {
                    // Empty state
                    const emptyMessage = document.createElement('div');
                    emptyMessage.className = 'col-12 text-center small text-muted py-4';
                    emptyMessage.innerHTML = '<p class="mb-0">No templates available</p>';
                    templateContainer.appendChild(emptyMessage);
                }
            })
            .catch(error => {
                if (loadingPlaceholder) {
                    loadingPlaceholder.style.display = 'none';
                }
                
                const errorMessage = document.createElement('div');
                errorMessage.className = 'col-12 text-center text-danger py-3';
                errorMessage.innerHTML = '<p>Error loading templates</p>';
                templateContainer.appendChild(errorMessage);
                
                console.error('Template loading error:', error);
            });
    }
    
    // Category definitions for dropdown population
    const categoryOptions = {
        'bride': {
            'bridal': ['haldi', 'mehendi', 'sangeeth', 'wedding', 'reception'],
            'outfits': ['casual', 'formal', 'party', 'ethnic', 'western'],
            'jewelry': ['necklaces', 'earrings', 'maang_tikka', 'bangles', 'rings'],
            'makeup': ['traditional', 'modern', 'natural', 'bold', 'reception']
        },
        'groom': {
            'traditional': ['sherwani', 'kurta', 'indo_western', 'dhoti', 'jodhpuri'],
            'suits': ['tuxedos', 'three_piece', 'two_piece', 'blazers', 'casual'],
            'accessories': ['watches', 'cufflinks', 'ties', 'pocket_squares', 'shoes']
        }
    };
    
    // Handle category type change in delete section
    document.getElementById('deleteCategoryType').addEventListener('change', function() {
        const categoryType = this.value;
        const subcategorySelect = document.getElementById('deleteSubcategory');
        
        // Clear existing options
        subcategorySelect.innerHTML = '';
        
        // Add options based on category type
        if (categoryType === 'bride') {
            // Add bride subcategories
            const brideOptions = [
                ['bridal', 'Bridal Ceremonies'],
                ['outfits', 'Modern Outfits'],
                ['jewelry', 'Jewelry'],
                ['makeup', 'Makeup']
            ];
            
            brideOptions.forEach(option => {
                const optEl = document.createElement('option');
                optEl.value = option[0];
                optEl.textContent = option[1];
                subcategorySelect.appendChild(optEl);
            });
        } else {
            // Add groom subcategories
            const groomOptions = [
                ['traditional', 'Traditional Wear'],
                ['suits', 'Modern Suits'],
                ['accessories', 'Accessories']
            ];
            
            groomOptions.forEach(option => {
                const optEl = document.createElement('option');
                optEl.value = option[0];
                optEl.textContent = option[1];
                subcategorySelect.appendChild(optEl);
            });
        }
        
        // Trigger change event to update item categories
        subcategorySelect.dispatchEvent(new Event('change'));
    });
    
    // Handle subcategory change
    document.getElementById('deleteSubcategory').addEventListener('change', function() {
        const categoryType = document.getElementById('deleteCategoryType').value;
        const subcategory = this.value;
        const bridalTabs = document.getElementById('bridalCeremonyTabs');
        const otherCategories = document.getElementById('otherCategoriesList');
        const itemCategorySelect = document.getElementById('deleteItemCategory');
        
        // Show/hide appropriate selectors
        if (categoryType === 'bride' && subcategory === 'bridal') {
            bridalTabs.style.display = 'flex';
            otherCategories.style.display = 'none';
        } else {
            bridalTabs.style.display = 'none';
            otherCategories.style.display = 'block';
            
            // Populate item categories
            itemCategorySelect.innerHTML = '';
            
            if (categoryOptions[categoryType] && categoryOptions[categoryType][subcategory]) {
                categoryOptions[categoryType][subcategory].forEach(category => {
                    const optEl = document.createElement('option');
                    optEl.value = category;
                    // Format the category name to look nicer
                    optEl.textContent = category.charAt(0).toUpperCase() + 
                        category.slice(1).replace('_', ' ');
                    itemCategorySelect.appendChild(optEl);
                });
            }
        }
    });
    
    // Initialize subcategory options
    document.getElementById('deleteCategoryType').dispatchEvent(new Event('change'));
    
    // Handle clear all templates button
    document.getElementById('clearAllTemplatesBtn').addEventListener('click', function() {
        const categoryType = document.getElementById('deleteCategoryType').value;
        const subcategory = document.getElementById('deleteSubcategory').value;
        let itemCategory;
        
        // Get the selected item category based on the visible selector
        if (categoryType === 'bride' && subcategory === 'bridal') {
            itemCategory = document.querySelector('input[name="ceremonyTab"]:checked').value;
        } else {
            itemCategory = document.getElementById('deleteItemCategory').value;
        }
        
        // Format category display name for confirmation
        let categoryDisplay;
        if (categoryType === 'bride' && subcategory === 'bridal') {
            categoryDisplay = `${itemCategory} ceremony`;
        } else {
            const subcatName = document.getElementById('deleteSubcategory').options[
                document.getElementById('deleteSubcategory').selectedIndex].text;
            const itemName = document.getElementById('deleteItemCategory') ? 
                document.getElementById('deleteItemCategory').options[
                    document.getElementById('deleteItemCategory').selectedIndex].text : 
                itemCategory;
            categoryDisplay = `${subcatName} > ${itemName}`;
        }
        
        if (confirm(`Are you sure you want to delete ALL templates for ${categoryDisplay}?`)) {
            fetch('/delete-templates', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    category_type: categoryType,
                    subcategory: subcategory,
                    item_category: itemCategory,
                    clear_all: true
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('deleteStatusMessage').innerHTML = 
                        `<div class="alert alert-success">${data.message} (${data.deleted_count} files)</div>`;
                    
                    // Refresh templates
                    refreshTemplates();
                } else {
                    document.getElementById('deleteStatusMessage').innerHTML = 
                        `<div class="alert alert-danger">${data.message}</div>`;
                }
            })
            .catch(error => {
                document.getElementById('deleteStatusMessage').innerHTML = 
                    `<div class="alert alert-danger">Error: ${error}</div>`;
            });
        }
    });

    // Refresh button handler
    document.getElementById('refreshTemplates').addEventListener('click', function() {
        // Get category information
        const categoryType = document.getElementById('deleteCategoryType').value;
        const subcategory = document.getElementById('deleteSubcategory').value;
        
        let itemCategory;
        if (categoryType === 'bride' && subcategory === 'bridal') {
            itemCategory = document.querySelector('input[name="ceremonyTab"]:checked').value;
        } else {
            itemCategory = document.getElementById('deleteItemCategory').value;
        }
        
        refreshTemplates(itemCategory);
    });
    
    // Don't load templates automatically - wait for refresh button click
});
</script>
{% endblock %}