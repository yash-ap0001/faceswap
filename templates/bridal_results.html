{% extends 'base.html' %}

{% block title %}Multi-Template Results{% endblock %}

{% block styles %}
<style>
    /* Custom badge colors for enhancement methods */
    .badge.bg-purple {
        background-color: #6f42c1;
        color: white;
    }
    .badge.bg-teal {
        background-color: #20c997;
        color: white;
    }
    /* Enhanced badge hover effects */
    .badge[title] {
        cursor: help;
        transition: all 0.2s ease;
    }
    .badge[title]:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    /* Navigation controls styling */
    .navigation-controls button {
        opacity: 0.7;
        transition: all 0.2s ease;
    }
    .navigation-controls button:hover {
        opacity: 1;
        transform: scale(1.1);
    }
    .image-container {
        max-height: 75vh;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex align-items-center justify-content-between">
                <h1 class="mb-0">Face Swap Results</h1>
                <a href="{{ url_for('bridal_gallery') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i> Back to Gallery
                </a>
            </div>
            <p class="text-muted">Processing your face on multiple templates</p>
        </div>
    </div>

    <!-- Source Image and Settings -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">Your Source Image</h5>
                </div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    <img src="{{ url_for('uploaded_file', filename=source_path.split('/')[-1]) }}" 
                         class="img-fluid rounded" 
                         alt="Source Image"
                         style="max-height: 300px; object-fit: contain;">
                </div>
            </div>
        </div>
        <div class="col-md-8">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Processing Options</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="enhanceSwitch" checked>
                                <label class="form-check-label" for="enhanceSwitch">
                                    Enhance Face Quality
                                </label>
                            </div>
                            <small class="text-muted d-block mb-3">
                                Apply AI enhancement to improve face details after swapping
                            </small>
                            
                            <div class="mb-3" id="enhanceMethodContainer">
                                <label for="enhanceMethod" class="form-label">Enhancement Method</label>
                                <select class="form-select" id="enhanceMethod">
                                    <option value="auto" selected>Auto (Best Available)</option>
                                    <option value="gfpgan">GFPGAN (Good for realistic results)</option>
                                    <option value="codeformer">CodeFormer (Good for details)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="progress mb-3" id="overall-progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                                     role="progressbar" 
                                     style="width: 0%" 
                                     aria-valuenow="0" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">0%</div>
                            </div>
                            <p id="status-message">Ready to process templates</p>
                            
                            <div class="d-grid">
                                <button id="startProcessingBtn" class="btn btn-primary">
                                    <i class="fas fa-play me-2"></i> Start Processing
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Grid -->
    <div class="row mb-4" id="results-container">
        <!-- Results will be added here dynamically -->
    </div>
</div>

<!-- Image preview modal -->
<div class="modal fade" id="resultPreviewModal" tabindex="-1" aria-labelledby="resultPreviewModalLabel" aria-hidden="true" style="transition: opacity 0.2s ease">
    <div class="modal-dialog modal-xl modal-dialog-centered" style="max-width: 90%; transition: transform 0.3s ease">
        <div class="modal-content" style="background-color: rgba(20, 20, 20, 0.75); border-radius: 10px; backdrop-filter: blur(15px); border: none;">
            <!-- Removed header -->
            <div class="modal-body p-0 position-relative">
                <div id="result-image-container" class="image-container" style="overflow: hidden; position: relative; max-height: 85vh; cursor: move;">
                    <img id="resultPreviewModalImage" src="" class="img-fluid" alt="Result Preview" style="transition: transform 0.3s ease; transform-origin: center;">
                    
                    <!-- Navigation arrows -->
                    <div class="navigation-controls position-absolute start-0 top-50 translate-middle-y ps-2 ms-2" style="z-index: 1050;">
                        <button class="btn btn-dark rounded-circle shadow" onclick="navigateResults('prev')">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                    </div>
                    <div class="navigation-controls position-absolute end-0 top-50 translate-middle-y pe-2 me-2" style="z-index: 1050;">
                        <button class="btn btn-dark rounded-circle shadow" onclick="navigateResults('next')">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    
                    <!-- Close button -->
                    <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" data-bs-dismiss="modal" aria-label="Close" style="z-index: 1050;"></button>
                    
                    <!-- Zoom controls -->
                    <div class="zoom-controls position-absolute top-0 start-0 p-2 m-2" style="z-index: 1050;">
                        <button class="btn btn-sm btn-dark ms-1" id="result-zoom-in">
                            <i class="fas fa-search-plus"></i>
                        </button>
                        <button class="btn btn-sm btn-dark ms-1" id="result-zoom-out">
                            <i class="fas fa-search-minus"></i>
                        </button>
                        <button class="btn btn-sm btn-dark ms-1" id="result-zoom-reset">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    
                    <!-- Image counter -->
                    <div class="image-counter position-absolute bottom-0 start-50 translate-middle-x mb-3 px-3 py-1 rounded bg-dark bg-opacity-75 text-white" style="z-index: 1050;">
                        <span id="current-result-index">1</span> / <span id="total-result-count">1</span>
                    </div>
                    
                    <!-- Download button -->
                    <a id="downloadResultBtn" href="#" class="btn btn-sm btn-outline-light position-absolute bottom-0 end-0 m-3" download style="z-index: 1050;">
                        <i class="fas fa-download me-1"></i> Download
                    </a>
                </div>
            </div>
            <!-- Removed footer -->
        </div>
    </div>
</div>

<!-- Error modal -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="errorModalLabel">Error</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="error-message"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize variables
    const sourcePath = "{{ source_path }}";
    const templatePaths = {{ template_paths|tojson }};
    const resultsContainer = document.getElementById('results-container');
    const overallProgress = document.querySelector('#overall-progress .progress-bar');
    const statusMessage = document.getElementById('status-message');
    const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
    const errorMessage = document.getElementById('error-message');
    const resultPreviewModal = new bootstrap.Modal(document.getElementById('resultPreviewModal'));
    const resultPreviewModalImage = document.getElementById('resultPreviewModalImage');
    const downloadResultBtn = document.getElementById('downloadResultBtn');
    const currentResultCounter = document.getElementById('current-result-index');
    const totalResultCounter = document.getElementById('total-result-count');
    
    // Variables for image navigation
    const allResultImages = [];
    let currentResultIndex = 0;
    
    // Add keyboard navigation support
    document.addEventListener('keydown', (e) => {
        // Only if the result modal is visible
        if (resultPreviewModal._element && resultPreviewModal._element.classList.contains('show')) {
            if (e.key === 'ArrowRight') {
                navigateResults('next');
            } else if (e.key === 'ArrowLeft') {
                navigateResults('prev');
            } else if (e.key === '+' || e.key === '=') {
                zoomResultIn();
            } else if (e.key === '-' || e.key === '_') {
                zoomResultOut();
            } else if (e.key === '0') {
                resetResultZoom();
            }
        }
    });
    
    // Variable declarations moved to top of script
    
    // Navigate between result images
    function navigateResults(direction) {
        if (allResultImages.length <= 1) return;
        
        if (direction === 'next') {
            currentResultIndex = (currentResultIndex + 1) % allResultImages.length;
        } else if (direction === 'prev') {
            currentResultIndex = (currentResultIndex - 1 + allResultImages.length) % allResultImages.length;
        }
        
        // Update the image and download button
        const resultData = allResultImages[currentResultIndex];
        resultPreviewModalImage.src = resultData.src;
        downloadResultBtn.href = resultData.src;
        downloadResultBtn.download = resultData.src.split('/').pop();
        
        // Reset zoom level
        resultZoomLevel = 1;
        resultPreviewModalImage.style.transform = 'scale(1)';
        
        // Update counter
        document.getElementById('current-result-index').textContent = currentResultIndex + 1;
    }
    
    // Show result preview with navigation
    function showResultPreview(resultImg) {
        // Store the index of the clicked image
        currentResultIndex = allResultImages.findIndex(img => img.src === resultImg.getAttribute('data-full-path'));
        if (currentResultIndex === -1) currentResultIndex = 0;
        
        // Update the image and download button
        resultPreviewModalImage.src = resultImg.getAttribute('data-full-path');
        downloadResultBtn.href = resultImg.getAttribute('data-full-path');
        downloadResultBtn.download = resultImg.getAttribute('data-full-path').split('/').pop();
        
        // Update counter
        document.getElementById('current-result-index').textContent = currentResultIndex + 1;
        document.getElementById('total-result-count').textContent = allResultImages.length;
        
        // Reset zoom level
        resultZoomLevel = 1;
        resultPreviewModalImage.style.transform = 'scale(1)';
        
        // Show modal
        resultPreviewModal.show();
    }
    
    // Process all templates sequentially
    async function processAllTemplates() {
        allResultImages = []; // Reset result images array
        let processedCount = 0;
        
        // Get enhancement options
        const enhanceEnabled = document.getElementById('enhanceSwitch').checked;
        const enhanceMethod = document.getElementById('enhanceMethod').value;
        
        // Create template cards first
        templatePaths.forEach((path, index) => {
            const templateName = path.split('/').pop();
            const ceremony = path.split('/').slice(-2)[0]; // Get ceremony from path
            
            const colDiv = document.createElement('div');
            colDiv.className = 'col-md-4 mb-4';
            colDiv.innerHTML = `
                <div class="card h-100 template-result-card" id="result-card-${index}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">${ceremony.charAt(0).toUpperCase() + ceremony.slice(1)}</h5>
                        <span class="badge bg-secondary processing-badge">Processing...</span>
                    </div>
                    <div class="card-body p-0 position-relative">
                        <div class="d-flex">
                            <div class="w-50 p-2">
                                <p class="small text-muted mb-1">Template</p>
                                <img src="${path}" class="img-fluid rounded" alt="Template" style="height: 200px; width: 100%; object-fit: cover;">
                            </div>
                            <div class="w-50 p-2 result-container" id="result-container-${index}">
                                <p class="small text-muted mb-1">Result</p>
                                <div class="result-placeholder d-flex align-items-center justify-content-center" style="height: 200px; background-color: #f8f9fa; border-radius: 0.25rem;">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            resultsContainer.appendChild(colDiv);
        });
        
        // Process each template
        for (let i = 0; i < templatePaths.length; i++) {
            const template = templatePaths[i];
            const resultContainer = document.getElementById(`result-container-${i}`);
            const resultCard = document.getElementById(`result-card-${i}`);
            const processingBadge = resultCard.querySelector('.processing-badge');
            
            try {
                statusMessage.textContent = `Processing template ${i+1} of ${templatePaths.length}...`;
                
                // Make API call to process this template
                const response = await fetch('/process_template', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        source_path: sourcePath,
                        template_path: template,
                        enhance: enhanceEnabled,
                        enhance_method: enhanceMethod
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update the result container with the processed image
                    // Determine enhancement badge
                    let enhanceBadge = '';
                    if (data.enhanced) {
                        let methodName = data.enhance_method || 'Auto';
                        // Format the method name for display
                        if (methodName === 'auto') methodName = 'Auto';
                        else if (methodName === 'gfpgan') methodName = 'GFPGAN';
                        else if (methodName === 'codeformer') methodName = 'CodeFormer';
                        methodName = methodName.charAt(0).toUpperCase() + methodName.slice(1);
                        
                        // Use different badge colors based on the method
                        let badgeClass = 'bg-info';
                        if (methodName === 'GFPGAN') badgeClass = 'bg-purple';
                        else if (methodName === 'CodeFormer') badgeClass = 'bg-teal';
                        
                        enhanceBadge = `<span class="badge ${badgeClass}" title="Enhanced with ${methodName}">Enhanced (${methodName})</span>`;
                    }
                    
                    resultContainer.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <p class="small text-muted mb-1">Result</p>
                            ${enhanceBadge}
                        </div>
                        <img src="${data.result_path}" class="img-fluid rounded result-image" 
                             alt="Result" style="height: 200px; width: 100%; object-fit: cover;"
                             data-full-path="${data.result_path}">
                    `;
                    
                    // Add click handler for the result image
                    const resultImage = resultContainer.querySelector('.result-image');
                    resultImage.addEventListener('click', function() {
                        showResultPreview(this);
                    });
                    
                    // Update badge to show success
                    processingBadge.className = 'badge bg-success';
                    processingBadge.textContent = 'Completed';
                    
                    // Add to allResultImages array for navigation
                    allResultImages.push({
                        src: data.result_path,
                        template: template,
                        index: i
                    });
                    
                    results.push({
                        template: template,
                        result: data.result_path
                    });
                } else {
                    throw new Error(data.error || 'Failed to process template');
                }
            } catch (error) {
                console.error(`Error processing template ${i+1}:`, error);
                
                // Update result container to show error
                resultContainer.innerHTML = `
                    <p class="small text-muted mb-1">Result</p>
                    <div class="alert alert-danger h-100 d-flex align-items-center justify-content-center" style="min-height: 200px;">
                        <div>
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Processing failed
                        </div>
                    </div>
                `;
                
                // Update badge to show error
                processingBadge.className = 'badge bg-danger';
                processingBadge.textContent = 'Failed';
            }
            
            // Update progress
            processedCount++;
            const percentComplete = Math.round((processedCount / templatePaths.length) * 100);
            overallProgress.style.width = `${percentComplete}%`;
            overallProgress.setAttribute('aria-valuenow', percentComplete);
            overallProgress.textContent = `${percentComplete}%`;
        }
        
        // All templates processed
        statusMessage.textContent = `All ${processedCount} templates processed. ${results.length} successful, ${processedCount - results.length} failed.`;
    }
    
    // Show error in modal
    function showError(message) {
        errorMessage.textContent = message;
        errorModal.show();
    }
    
    // Toggle enhancement options
    function toggleEnhancementOptions() {
        const enhanceSwitch = document.getElementById('enhanceSwitch');
        const methodContainer = document.getElementById('enhanceMethodContainer');
        
        if (enhanceSwitch && methodContainer) {
            methodContainer.style.display = enhanceSwitch.checked ? 'block' : 'none';
        }
    }
    
    // Variables for image navigation
    let currentResultIndex = 0;
    const allResultImages = [];
    
    // Show result preview and set up navigation
    function showResultPreview(imageElement) {
        const imgPath = imageElement.getAttribute('data-full-path');
        
        // Find this image in our array for navigation
        const index = allResultImages.findIndex(img => img.src === imgPath);
        if (index !== -1) {
            currentResultIndex = index;
        }
        
        // Update current image info
        updateResultCounter();
        
        // Set image source and download link
        resultPreviewModalImage.src = imgPath;
        downloadResultBtn.href = imgPath;
        downloadResultBtn.download = imgPath.split('/').pop();
        
        // Reset zoom
        resetResultZoom();
        
        // Show modal
        resultPreviewModal.show();
    }
    
    // Navigate between result images
    function navigateResults(direction) {
        if (allResultImages.length === 0) return;
        
        if (direction === 'prev') {
            currentResultIndex = (currentResultIndex - 1 + allResultImages.length) % allResultImages.length;
        } else {
            currentResultIndex = (currentResultIndex + 1) % allResultImages.length;
        }
        
        const imgData = allResultImages[currentResultIndex];
        resultPreviewModalImage.src = imgData.src;
        downloadResultBtn.href = imgData.src;
        downloadResultBtn.download = imgData.src.split('/').pop();
        
        // Update counter
        updateResultCounter();
    }
    
    // Update the counter display
    function updateResultCounter() {
        if (currentResultCounter && totalResultCounter) {
            currentResultCounter.textContent = (currentResultIndex + 1).toString();
            totalResultCounter.textContent = allResultImages.length.toString();
        }
    }
    

    
    // Zoom and panning functionality for result preview
    let resultZoomLevel = 1;
    const resultZoomStep = 0.1;
    const resultMaxZoom = 3;
    const resultMinZoom = 0.5;
    let isDragging = false;
    let startX, startY, currentX = 0, currentY = 0;
    
    function zoomResultIn() {
        if (resultZoomLevel < resultMaxZoom) {
            resultZoomLevel += resultZoomStep;
            applyResultZoom();
        }
    }
    
    function zoomResultOut() {
        if (resultZoomLevel > resultMinZoom) {
            resultZoomLevel -= resultZoomStep;
            applyResultZoom();
        }
    }
    
    function resetResultZoom() {
        resultZoomLevel = 1;
        currentX = 0;
        currentY = 0;
        applyResultZoom();
    }
    
    function applyResultZoom() {
        resultPreviewModalImage.style.transform = `scale(${resultZoomLevel}) translate(${currentX}px, ${currentY}px)`;
        
        // Only enable dragging when zoomed in
        const container = document.getElementById('result-image-container');
        if (container) {
            if (resultZoomLevel > 1) {
                container.style.cursor = 'move';
            } else {
                container.style.cursor = 'default';
                // Reset position when zoom is at default
                currentX = 0;
                currentY = 0;
            }
        }
    }
    
    // Initialize drag and pan functionality for zoomed images
    function initDragPan() {
        const container = document.getElementById('result-image-container');
        if (!container) return;
        
        // Mouse events
        container.addEventListener('mousedown', (e) => {
            // Only enable dragging when zoomed in
            if (resultZoomLevel <= 1) return;
            
            isDragging = true;
            startX = e.clientX - currentX;
            startY = e.clientY - currentY;
            e.preventDefault();
        });
        
        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            
            currentX = e.clientX - startX;
            currentY = e.clientY - startY;
            applyResultZoom();
            e.preventDefault();
        });
        
        document.addEventListener('mouseup', () => {
            isDragging = false;
        });
        
        // Touch events for mobile
        container.addEventListener('touchstart', (e) => {
            if (resultZoomLevel <= 1) return;
            
            isDragging = true;
            startX = e.touches[0].clientX - currentX;
            startY = e.touches[0].clientY - currentY;
        }, { passive: false });
        
        container.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            
            currentX = e.touches[0].clientX - startX;
            currentY = e.touches[0].clientY - startY;
            applyResultZoom();
            e.preventDefault();
        }, { passive: false });
        
        container.addEventListener('touchend', () => {
            isDragging = false;
        });
    }
    
    // Initialize drag and pan when modal is shown
    document.getElementById('resultPreviewModal').addEventListener('shown.bs.modal', () => {
        initDragPan();
    });
    
    // Initialize processing
    document.addEventListener('DOMContentLoaded', function() {
        const enhanceSwitch = document.getElementById('enhanceSwitch');
        if (enhanceSwitch) {
            enhanceSwitch.addEventListener('change', toggleEnhancementOptions);
            toggleEnhancementOptions(); // Initial state
        }
        
        // Initialize zoom controls
        const zoomInBtn = document.getElementById('result-zoom-in');
        const zoomOutBtn = document.getElementById('result-zoom-out');
        const zoomResetBtn = document.getElementById('result-zoom-reset');
        
        if (zoomInBtn) zoomInBtn.addEventListener('click', zoomResultIn);
        if (zoomOutBtn) zoomOutBtn.addEventListener('click', zoomResultOut);
        if (zoomResetBtn) zoomResetBtn.addEventListener('click', resetResultZoom);
        
        if (templatePaths.length > 0) {
            processAllTemplates().catch(error => {
                console.error('Error in template processing:', error);
                showError('An error occurred during processing. Please try again.');
            });
        } else {
            showError('No templates selected for processing.');
        }
    });
</script>
{% endblock %}