{% extends "base.html" %}

{% block style %}
<style>
    .budget-card {
        background-color: var(--card-surface);
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        height: 100%;
    }
    
    .budget-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
    
    .progress-thin {
        height: 6px;
    }
    
    .budget-item {
        background-color: var(--card-surface);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
    }
    
    .budget-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }
    
    .budget-item.paid {
        border-left-color: #28a745;
    }
    
    .budget-item.unpaid {
        border-left-color: #dc3545;
    }
    
    .budget-item.partially-paid {
        border-left-color: #ffc107;
    }
    
    .category-card {
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        transition: all 0.3s ease;
    }
    
    .category-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }
    
    .category-card.venue {
        background: linear-gradient(45deg, rgba(126, 87, 194, 0.1), rgba(126, 87, 194, 0.2));
    }
    
    .category-card.catering {
        background: linear-gradient(45deg, rgba(40, 167, 69, 0.1), rgba(40, 167, 69, 0.2));
    }
    
    .category-card.decor {
        background: linear-gradient(45deg, rgba(220, 53, 69, 0.1), rgba(220, 53, 69, 0.2));
    }
    
    .category-card.attire {
        background: linear-gradient(45deg, rgba(255, 193, 7, 0.1), rgba(255, 193, 7, 0.2));
    }
    
    .category-card.photography {
        background: linear-gradient(45deg, rgba(23, 162, 184, 0.1), rgba(23, 162, 184, 0.2));
    }
    
    .category-card.entertainment {
        background: linear-gradient(45deg, rgba(111, 66, 193, 0.1), rgba(111, 66, 193, 0.2));
    }
    
    .category-card.other {
        background: linear-gradient(45deg, rgba(108, 117, 125, 0.1), rgba(108, 117, 125, 0.2));
    }
    
    .chart-container {
        position: relative;
        height: 300px;
    }
    
    .status-badge {
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
    }
    
    .status-badge.paid {
        background-color: rgba(40, 167, 69, 0.2);
        color: #28a745;
    }
    
    .status-badge.unpaid {
        background-color: rgba(220, 53, 69, 0.2);
        color: #dc3545;
    }
    
    .status-badge.partially-paid {
        background-color: rgba(255, 193, 7, 0.2);
        color: #ffc107;
    }
    
    .modal-dark .modal-content {
        background-color: var(--card-surface);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
    }
    
    .modal-dark .modal-header,
    .modal-dark .modal-footer {
        border-color: var(--border-color);
    }
    
    .modal-dark .close {
        color: var(--text-primary);
    }
    
    .modal-dark .form-control {
        background-color: rgba(0, 0, 0, 0.2);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
    }
    
    .modal-dark .form-control:focus {
        background-color: rgba(0, 0, 0, 0.3);
        border-color: var(--light-purple);
        box-shadow: 0 0 0 0.25rem rgba(126, 87, 194, 0.25);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-0">Budget Planner</h1>
                <p class="text-muted">Track and manage your wedding expenses</p>
            </div>
            <div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addExpenseModal">
                    <i class="fas fa-plus me-2"></i>Add Expense
                </button>
            </div>
        </div>
    </div>
    
    <!-- Budget Summary Cards -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="budget-card">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Total Budget</h6>
                    <h2 class="mb-0" id="total-budget">${{ "{:,.2f}".format(total_budget) }}</h2>
                    <button class="btn btn-sm btn-outline-primary mt-3" data-bs-toggle="modal" data-bs-target="#setBudgetModal">
                        <i class="fas fa-edit me-1"></i>Set Budget
                    </button>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="budget-card">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Total Spent</h6>
                    <h2 class="mb-0 {{ 'text-success' if total_spent <= total_budget else 'text-danger' }}" id="total-spent">
                        ${{ "{:,.2f}".format(total_spent) }}
                    </h2>
                    <div class="progress progress-thin mt-3">
                        <div class="progress-bar {{ 'bg-success' if total_spent <= total_budget else 'bg-danger' }}" 
                             role="progressbar" 
                             style="width: {{ (total_spent / total_budget * 100) if total_budget > 0 else 0 }}%" 
                             aria-valuenow="{{ total_spent }}" 
                             aria-valuemin="0" 
                             aria-valuemax="{{ total_budget }}"></div>
                    </div>
                    <small class="text-muted">{{ "{:.1f}%".format(total_spent / total_budget * 100) if total_budget > 0 else '0%' }} of budget</small>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="budget-card">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Remaining</h6>
                    <h2 class="mb-0 {{ 'text-success' if remaining > 0 else 'text-danger' }}" id="remaining-budget">
                        ${{ "{:,.2f}".format(remaining) }}
                    </h2>
                    <small class="text-muted mt-3 d-block">
                        {{ "{:.1f}%".format(remaining / total_budget * 100) if total_budget > 0 else '0%' }} of budget remaining
                    </small>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="budget-card">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Paid vs. Unpaid</h6>
                    <div class="d-flex align-items-center">
                        <h3 class="mb-0 text-success">${{ "{:,.2f}".format(total_paid) }}</h3>
                        <span class="mx-2 text-muted">/</span>
                        <h3 class="mb-0 text-danger">${{ "{:,.2f}".format(total_unpaid) }}</h3>
                    </div>
                    <div class="progress progress-thin mt-3">
                        <div class="progress-bar bg-success" 
                             role="progressbar" 
                             style="width: {{ (total_paid / total_spent * 100) if total_spent > 0 else 0 }}%" 
                             aria-valuenow="{{ total_paid }}" 
                             aria-valuemin="0" 
                             aria-valuemax="{{ total_spent }}"></div>
                        <div class="progress-bar bg-danger" 
                             role="progressbar" 
                             style="width: {{ (total_unpaid / total_spent * 100) if total_spent > 0 else 0 }}%" 
                             aria-valuenow="{{ total_unpaid }}" 
                             aria-valuemin="0" 
                             aria-valuemax="{{ total_spent }}"></div>
                    </div>
                    <small class="text-muted">{{ "{:.1f}%".format(total_paid / total_spent * 100) if total_spent > 0 else '0%' }} paid</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Budget Breakdown by Category -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header bg-dark d-flex justify-content-between align-items-center">
                    <h4 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Budget Breakdown</h4>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-light dropdown-toggle" type="button" id="breakdownDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-filter me-1"></i>Filter
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="breakdownDropdown">
                            <li><a class="dropdown-item active" href="#" data-filter="all">All Expenses</a></li>
                            <li><a class="dropdown-item" href="#" data-filter="paid">Paid Only</a></li>
                            <li><a class="dropdown-item" href="#" data-filter="unpaid">Unpaid Only</a></li>
                            <li><hr class="dropdown-divider"></li>
                            {% for category in categories %}
                                <li><a class="dropdown-item" href="#" data-filter="{{ category }}">{{ category|capitalize }}</a></li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="budgetPieChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Category Breakdown -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header bg-dark d-flex justify-content-between align-items-center">
                    <h4 class="mb-0"><i class="fas fa-list-alt me-2"></i>Expenses by Category</h4>
                    <div>
                        <button class="btn btn-sm btn-outline-light" id="showAllCategories">Show All</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row" id="categoryCards">
                        {% for category, amount in category_totals.items() %}
                            <div class="col-md-6 mb-3">
                                <div class="category-card {{ category }}">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h5 class="mb-0">{{ category|capitalize }}</h5>
                                        <span class="badge bg-dark">${{ "{:,.2f}".format(amount) }}</span>
                                    </div>
                                    <div class="progress progress-thin mb-2">
                                        <div class="progress-bar 
                                                    {{ 'bg-success' if amount <= category_budgets.get(category, 0) else 'bg-danger' }}" 
                                             role="progressbar" 
                                             style="width: {{ (amount / category_budgets.get(category, 1) * 100) 
                                                            if category_budgets.get(category, 0) > 0 else 0 }}%" 
                                             aria-valuenow="{{ amount }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="{{ category_budgets.get(category, 0) }}"></div>
                                    </div>
                                    <small class="text-muted d-block mb-2">
                                        Budget: ${{ "{:,.2f}".format(category_budgets.get(category, 0)) }}
                                    </small>
                                    <a href="#" class="btn btn-sm btn-outline-secondary w-100 view-category-btn" data-category="{{ category }}">
                                        <i class="fas fa-eye me-1"></i>View Details
                                    </a>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Budget Items List -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-dark d-flex justify-content-between align-items-center">
                    <h4 class="mb-0"><i class="fas fa-receipt me-2"></i>All Expenses</h4>
                    <div class="d-flex">
                        <div class="input-group me-2">
                            <span class="input-group-text bg-dark border-secondary">
                                <i class="fas fa-search text-muted"></i>
                            </span>
                            <input type="text" class="form-control bg-dark border-secondary text-white" id="expenseSearch" placeholder="Search expenses...">
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-outline-light dropdown-toggle" type="button" id="expenseFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-filter me-1"></i>Filter
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="expenseFilterDropdown">
                                <li><a class="dropdown-item active" href="#" data-filter="all">All Expenses</a></li>
                                <li><a class="dropdown-item" href="#" data-filter="paid">Paid</a></li>
                                <li><a class="dropdown-item" href="#" data-filter="partially_paid">Partially Paid</a></li>
                                <li><a class="dropdown-item" href="#" data-filter="unpaid">Unpaid</a></li>
                                <li><hr class="dropdown-divider"></li>
                                {% for category in categories %}
                                    <li><a class="dropdown-item" href="#" data-filter="{{ category }}">{{ category|capitalize }}</a></li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="expensesTable">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Category</th>
                                    <th>Estimated Cost</th>
                                    <th>Actual Cost</th>
                                    <th>Status</th>
                                    <th>Payment Date</th>
                                    <th>Vendor</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in budget_items %}
                                    <tr class="budget-item-row" data-category="{{ item.category }}" data-status="{{ item.payment_status }}">
                                        <td>{{ item.description }}</td>
                                        <td>
                                            <span class="badge" style="background-color: rgba({{ category_colors[item.category]|safe }}, 0.2); color: rgb({{ category_colors[item.category]|safe }});">
                                                {{ item.category|capitalize }}
                                            </span>
                                        </td>
                                        <td>${{ "{:,.2f}".format(item.estimated_cost) }}</td>
                                        <td>${{ "{:,.2f}".format(item.actual_cost) if item.actual_cost else '-' }}</td>
                                        <td>
                                            <span class="status-badge {{ item.payment_status }}">
                                                {{ item.payment_status|replace('_', ' ')|capitalize }}
                                            </span>
                                        </td>
                                        <td>{{ item.payment_date.strftime('%b %d, %Y') if item.payment_date else '-' }}</td>
                                        <td>{{ item.vendor.name if item.vendor else '-' }}</td>
                                        <td>
                                            <div class="btn-group">
                                                <button type="button" class="btn btn-sm btn-outline-primary edit-budget-item" data-item-id="{{ item.id }}">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-success mark-as-paid" data-item-id="{{ item.id }}" {{ 'disabled' if item.payment_status == 'paid' else '' }}>
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-danger delete-budget-item" data-item-id="{{ item.id }}">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    {% if not budget_items %}
                        <div class="text-center py-5">
                            <i class="fas fa-receipt text-muted fa-3x mb-3"></i>
                            <p>No expenses added yet.</p>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addExpenseModal">
                                <i class="fas fa-plus me-1"></i>Add First Expense
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Set Budget Modal -->
<div class="modal fade modal-dark" id="setBudgetModal" tabindex="-1" aria-labelledby="setBudgetModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="setBudgetModalLabel">Set Your Budget</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="budgetForm" action="{{ url_for('set_budget', event_id=event.id) }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="totalBudget" class="form-label">Total Wedding Budget</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="totalBudget" name="total_budget" value="{{ total_budget }}" min="0" step="0.01" required>
                        </div>
                    </div>
                    
                    <h6 class="mb-3">Category Breakdown (Optional)</h6>
                    
                    {% for category in categories %}
                        <div class="mb-3">
                            <label for="budget{{ category }}" class="form-label">{{ category|capitalize }}</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control category-budget" 
                                       id="budget{{ category }}" 
                                       name="budget_{{ category }}" 
                                       value="{{ category_budgets.get(category, 0) }}"
                                       min="0" step="0.01">
                            </div>
                        </div>
                    {% endfor %}
                    
                    <div class="alert alert-info">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Budget allocated:</span>
                            <span id="allocatedBudget">${{ "{:,.2f}".format(sum(category_budgets.values())) }}</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Unallocated:</span>
                            <span id="unallocatedBudget">${{ "{:,.2f}".format(total_budget - sum(category_budgets.values())) }}</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Budget</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Expense Modal -->
<div class="modal fade modal-dark" id="addExpenseModal" tabindex="-1" aria-labelledby="addExpenseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addExpenseModalLabel">Add New Expense</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="expenseForm" action="{{ url_for('add_budget_item', event_id=event.id) }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="expenseCategory" class="form-label">Category</label>
                        <select class="form-select" id="expenseCategory" name="category" required>
                            <option value="" selected disabled>Select a category</option>
                            {% for category in categories %}
                                <option value="{{ category }}">{{ category|capitalize }}</option>
                            {% endfor %}
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="expenseDescription" class="form-label">Description</label>
                        <input type="text" class="form-control" id="expenseDescription" name="description" required>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="estimatedCost" class="form-label">Estimated Cost</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="estimatedCost" name="estimated_cost" min="0" step="0.01" required>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="actualCost" class="form-label">Actual Cost (if known)</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="actualCost" name="actual_cost" min="0" step="0.01">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="paymentStatus" class="form-label">Payment Status</label>
                        <select class="form-select" id="paymentStatus" name="payment_status" required>
                            <option value="unpaid" selected>Unpaid</option>
                            <option value="partially_paid">Partially Paid</option>
                            <option value="paid">Paid</option>
                        </select>
                    </div>
                    
                    <div class="mb-3 payment-date-group" style="display: none;">
                        <label for="paymentDate" class="form-label">Payment Date</label>
                        <input type="date" class="form-control" id="paymentDate" name="payment_date">
                    </div>
                    
                    <div class="mb-3">
                        <label for="vendorSelect" class="form-label">Vendor (Optional)</label>
                        <select class="form-select" id="vendorSelect" name="vendor_id">
                            <option value="">Select a vendor</option>
                            {% for vendor in vendors %}
                                <option value="{{ vendor.id }}">{{ vendor.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Expense</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Expense Modal -->
<div class="modal fade modal-dark" id="editExpenseModal" tabindex="-1" aria-labelledby="editExpenseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editExpenseModalLabel">Edit Expense</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editExpenseForm" action="{{ url_for('edit_budget_item', event_id=event.id, item_id=0) }}" method="POST">
                <div class="modal-body">
                    <!-- Form fields will be populated by JavaScript -->
                    <input type="hidden" id="editItemId" name="item_id">
                    
                    <div class="mb-3">
                        <label for="editExpenseCategory" class="form-label">Category</label>
                        <select class="form-select" id="editExpenseCategory" name="category" required>
                            <option value="" selected disabled>Select a category</option>
                            {% for category in categories %}
                                <option value="{{ category }}">{{ category|capitalize }}</option>
                            {% endfor %}
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editExpenseDescription" class="form-label">Description</label>
                        <input type="text" class="form-control" id="editExpenseDescription" name="description" required>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editEstimatedCost" class="form-label">Estimated Cost</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="editEstimatedCost" name="estimated_cost" min="0" step="0.01" required>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="editActualCost" class="form-label">Actual Cost</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="editActualCost" name="actual_cost" min="0" step="0.01">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editPaymentStatus" class="form-label">Payment Status</label>
                        <select class="form-select" id="editPaymentStatus" name="payment_status" required>
                            <option value="unpaid">Unpaid</option>
                            <option value="partially_paid">Partially Paid</option>
                            <option value="paid">Paid</option>
                        </select>
                    </div>
                    
                    <div class="mb-3 edit-payment-date-group">
                        <label for="editPaymentDate" class="form-label">Payment Date</label>
                        <input type="date" class="form-control" id="editPaymentDate" name="payment_date">
                    </div>
                    
                    <div class="mb-3">
                        <label for="editVendorSelect" class="form-label">Vendor (Optional)</label>
                        <select class="form-select" id="editVendorSelect" name="vendor_id">
                            <option value="">Select a vendor</option>
                            {% for vendor in vendors %}
                                <option value="{{ vendor.id }}">{{ vendor.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade modal-dark" id="deleteExpenseModal" tabindex="-1" aria-labelledby="deleteExpenseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteExpenseModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this expense? This action cannot be undone.</p>
                <p id="deleteItemDescription" class="fw-bold"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteExpenseForm" action="{{ url_for('delete_budget_item', event_id=event.id, item_id=0) }}" method="POST">
                    <input type="hidden" id="deleteItemId" name="item_id">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Category colors for charts
        const categoryColors = {
            {% for category, color in category_colors.items() %}
                '{{ category }}': 'rgb({{ color }})',
            {% endfor %}
        };
        
        // Budget breakdown pie chart
        const ctxPie = document.getElementById('budgetPieChart').getContext('2d');
        const budgetData = {
            labels: [
                {% for category, amount in category_totals.items() %}
                    '{{ category|capitalize }}',
                {% endfor %}
            ],
            datasets: [{
                data: [
                    {% for category, amount in category_totals.items() %}
                        {{ amount }},
                    {% endfor %}
                ],
                backgroundColor: [
                    {% for category in category_totals.keys() %}
                        categoryColors['{{ category }}'],
                    {% endfor %}
                ],
                borderWidth: 0
            }]
        };
        
        const budgetPieChart = new Chart(ctxPie, {
            type: 'doughnut',
            data: budgetData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: '#f5f5f5',
                            font: {
                                size: 12
                            },
                            padding: 20
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: $${value.toLocaleString()} (${percentage}%)`;
                            }
                        }
                    }
                },
                cutout: '70%'
            }
        });
        
        // Payment status toggle
        const paymentStatus = document.getElementById('paymentStatus');
        const paymentDateGroup = document.querySelector('.payment-date-group');
        
        paymentStatus.addEventListener('change', function() {
            if (this.value === 'paid' || this.value === 'partially_paid') {
                paymentDateGroup.style.display = 'block';
                document.getElementById('paymentDate').required = true;
            } else {
                paymentDateGroup.style.display = 'none';
                document.getElementById('paymentDate').required = false;
            }
        });
        
        // Edit payment status toggle
        const editPaymentStatus = document.getElementById('editPaymentStatus');
        const editPaymentDateGroup = document.querySelector('.edit-payment-date-group');
        
        editPaymentStatus.addEventListener('change', function() {
            if (this.value === 'paid' || this.value === 'partially_paid') {
                editPaymentDateGroup.style.display = 'block';
                document.getElementById('editPaymentDate').required = true;
            } else {
                editPaymentDateGroup.style.display = 'none';
                document.getElementById('editPaymentDate').required = false;
            }
        });
        
        // Budget allocation calculation
        const totalBudgetInput = document.getElementById('totalBudget');
        const categoryBudgetInputs = document.querySelectorAll('.category-budget');
        const allocatedBudgetDisplay = document.getElementById('allocatedBudget');
        const unallocatedBudgetDisplay = document.getElementById('unallocatedBudget');
        
        function updateBudgetAllocations() {
            const totalBudget = parseFloat(totalBudgetInput.value) || 0;
            let allocated = 0;
            
            categoryBudgetInputs.forEach(input => {
                allocated += parseFloat(input.value) || 0;
            });
            
            allocatedBudgetDisplay.textContent = '$' + allocated.toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            
            const unallocated = totalBudget - allocated;
            unallocatedBudgetDisplay.textContent = '$' + unallocated.toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            
            if (unallocated < 0) {
                unallocatedBudgetDisplay.classList.add('text-danger');
            } else {
                unallocatedBudgetDisplay.classList.remove('text-danger');
            }
        }
        
        totalBudgetInput.addEventListener('input', updateBudgetAllocations);
        categoryBudgetInputs.forEach(input => {
            input.addEventListener('input', updateBudgetAllocations);
        });
        
        // Edit expense functionality
        const editButtons = document.querySelectorAll('.edit-budget-item');
        editButtons.forEach(button => {
            button.addEventListener('click', function() {
                const itemId = this.getAttribute('data-item-id');
                
                // Fetch item data (in a real app, this would be an AJAX request)
                // For now, we'll simulate by finding the data in the table
                const row = this.closest('tr');
                const description = row.cells[0].textContent;
                const category = row.getAttribute('data-category');
                const estimatedCost = parseFloat(row.cells[2].textContent.replace('$', '').replace(',', ''));
                const actualCostText = row.cells[3].textContent;
                const actualCost = actualCostText !== '-' ? parseFloat(actualCostText.replace('$', '').replace(',', '')) : '';
                const status = row.getAttribute('data-status');
                const paymentDateText = row.cells[5].textContent;
                const paymentDate = paymentDateText !== '-' ? new Date(paymentDateText) : '';
                const vendorText = row.cells[6].textContent;
                const vendorId = vendorText !== '-' ? findVendorIdByName(vendorText) : '';
                
                // Populate the edit form
                document.getElementById('editItemId').value = itemId;
                document.getElementById('editExpenseDescription').value = description;
                document.getElementById('editExpenseCategory').value = category;
                document.getElementById('editEstimatedCost').value = estimatedCost;
                document.getElementById('editActualCost').value = actualCost;
                document.getElementById('editPaymentStatus').value = status;
                
                if (paymentDate) {
                    const formattedDate = paymentDate.toISOString().split('T')[0];
                    document.getElementById('editPaymentDate').value = formattedDate;
                } else {
                    document.getElementById('editPaymentDate').value = '';
                }
                
                document.getElementById('editVendorSelect').value = vendorId;
                
                // Update form action URL
                const form = document.getElementById('editExpenseForm');
                form.action = form.action.replace(/item_id=\d+/, `item_id=${itemId}`);
                
                // Show/hide payment date field based on status
                if (status === 'paid' || status === 'partially_paid') {
                    editPaymentDateGroup.style.display = 'block';
                } else {
                    editPaymentDateGroup.style.display = 'none';
                }
                
                // Open the modal
                const editModal = new bootstrap.Modal(document.getElementById('editExpenseModal'));
                editModal.show();
            });
        });
        
        // Helper function to find vendor ID by name
        function findVendorIdByName(name) {
            const vendorSelect = document.getElementById('vendorSelect');
            for (const option of vendorSelect.options) {
                if (option.textContent === name) {
                    return option.value;
                }
            }
            return '';
        }
        
        // Delete expense functionality
        const deleteButtons = document.querySelectorAll('.delete-budget-item');
        deleteButtons.forEach(button => {
            button.addEventListener('click', function() {
                const itemId = this.getAttribute('data-item-id');
                const row = this.closest('tr');
                const description = row.cells[0].textContent;
                
                // Populate the delete confirmation modal
                document.getElementById('deleteItemId').value = itemId;
                document.getElementById('deleteItemDescription').textContent = description;
                
                // Update form action URL
                const form = document.getElementById('deleteExpenseForm');
                form.action = form.action.replace(/item_id=\d+/, `item_id=${itemId}`);
                
                // Open the modal
                const deleteModal = new bootstrap.Modal(document.getElementById('deleteExpenseModal'));
                deleteModal.show();
            });
        });
        
        // Mark as paid functionality
        const markAsPaidButtons = document.querySelectorAll('.mark-as-paid');
        markAsPaidButtons.forEach(button => {
            button.addEventListener('click', function() {
                const itemId = this.getAttribute('data-item-id');
                
                // In a real app, this would be an AJAX request
                // For demonstration, we'll just show the edit modal with paid status
                const row = this.closest('tr');
                const description = row.cells[0].textContent;
                const category = row.getAttribute('data-category');
                const estimatedCost = parseFloat(row.cells[2].textContent.replace('$', '').replace(',', ''));
                const actualCostText = row.cells[3].textContent;
                const actualCost = actualCostText !== '-' ? parseFloat(actualCostText.replace('$', '').replace(',', '')) : estimatedCost;
                const vendorText = row.cells[6].textContent;
                const vendorId = vendorText !== '-' ? findVendorIdByName(vendorText) : '';
                
                // Populate the edit form
                document.getElementById('editItemId').value = itemId;
                document.getElementById('editExpenseDescription').value = description;
                document.getElementById('editExpenseCategory').value = category;
                document.getElementById('editEstimatedCost').value = estimatedCost;
                document.getElementById('editActualCost').value = actualCost;
                document.getElementById('editPaymentStatus').value = 'paid';
                
                // Set payment date to today
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('editPaymentDate').value = today;
                
                document.getElementById('editVendorSelect').value = vendorId;
                
                // Update form action URL
                const form = document.getElementById('editExpenseForm');
                form.action = form.action.replace(/item_id=\d+/, `item_id=${itemId}`);
                
                // Show payment date field
                editPaymentDateGroup.style.display = 'block';
                
                // Open the modal
                const editModal = new bootstrap.Modal(document.getElementById('editExpenseModal'));
                editModal.show();
            });
        });
        
        // Search functionality
        const searchInput = document.getElementById('expenseSearch');
        searchInput.addEventListener('input', function() {
            const searchText = this.value.toLowerCase();
            const rows = document.querySelectorAll('.budget-item-row');
            
            rows.forEach(row => {
                const description = row.cells[0].textContent.toLowerCase();
                const category = row.cells[1].textContent.toLowerCase();
                const vendor = row.cells[6].textContent.toLowerCase();
                
                if (description.includes(searchText) || category.includes(searchText) || vendor.includes(searchText)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
        
        // Filter expenses
        const filterLinks = document.querySelectorAll('#expenseFilterDropdown .dropdown-item');
        filterLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Update active filter
                filterLinks.forEach(l => l.classList.remove('active'));
                this.classList.add('active');
                
                const filter = this.getAttribute('data-filter');
                const rows = document.querySelectorAll('.budget-item-row');
                
                rows.forEach(row => {
                    if (filter === 'all') {
                        row.style.display = '';
                    } else if (row.getAttribute('data-status') === filter || row.getAttribute('data-category') === filter) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        });
        
        // Category filter for pie chart
        const breakdownFilterLinks = document.querySelectorAll('#breakdownDropdown .dropdown-item');
        breakdownFilterLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Update active filter
                breakdownFilterLinks.forEach(l => l.classList.remove('active'));
                this.classList.add('active');
                
                const filter = this.getAttribute('data-filter');
                
                // Filter chart data (in a real app, this would update the chart with filtered data)
                // For demonstration, we just log the filter
                console.log(`Filtering chart by: ${filter}`);
            });
        });
        
        // View category details
        const viewCategoryButtons = document.querySelectorAll('.view-category-btn');
        viewCategoryButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                
                const category = this.getAttribute('data-category');
                
                // Filter expenses table to show only this category
                const filterLinks = document.querySelectorAll('#expenseFilterDropdown .dropdown-item');
                filterLinks.forEach(link => {
                    if (link.getAttribute('data-filter') === category) {
                        link.click();
                    }
                });
                
                // Scroll to expenses table
                document.querySelector('.table-responsive').scrollIntoView({ behavior: 'smooth' });
            });
        });
        
        // Show all categories button
        const showAllCategoriesButton = document.getElementById('showAllCategories');
        showAllCategoriesButton.addEventListener('click', function() {
            const categoryCards = document.querySelectorAll('.category-card');
            categoryCards.forEach(card => {
                card.closest('.col-md-6').style.display = '';
            });
            this.textContent = 'Show All';
        });
    });
</script>
{% endblock %}